<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de gastos</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    input { padding: 8px 10px; }
    button { padding: 8px 12px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f6f6f6; text-align: left; }
    td.num { text-align: right; }
    .muted { opacity: 0.7; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <h1>Registro de gastos</h1>

  <div class="row">
    <label class="muted">Límite:</label>
    <input id="limit" type="number" value="200" min="1" max="1000" />
    <button id="reload">Recargar</button>
    <span id="status" class="muted">—</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Usuario</th>
        <th>Comercio</th>
        <th>Categoría</th>
        <th>Importe</th>
        <th>Moneda</th>
      </tr>
    </thead>
    <tbody id="expenses-body"></tbody>
  </table>

  <script>
    async function loadExpenses() {
      const statusEl = document.getElementById("status");
      const tbody = document.getElementById("expenses-body");
      const limit = document.getElementById("limit").value || 200;

      statusEl.textContent = "Cargando…";
      tbody.innerHTML = "";

      try {
        const url = `/expenses?limit=${encodeURIComponent(limit)}`;
        const res = await fetch(url, { cache: "no-store" });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`HTTP ${res.status}: ${txt}`);
        }

        const data = await res.json();
        const expenses = Array.isArray(data.expenses) ? data.expenses : [];

        statusEl.textContent = `Registros: ${expenses.length}`;

        if (expenses.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="6" class="muted" style="text-align:center;">No hay gastos aún</td>`;
          tbody.appendChild(tr);
          return;
        }

        for (const e of expenses) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${e.created_at ?? ""}</td>
            <td>${e.user_id ?? ""}</td>
            <td>${e.merchant_clean ?? ""}</td>
            <td>${e.category ?? ""}</td>
            <td class="num">${e.amount ?? ""}</td>
            <td>${e.currency ?? ""}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error cargando gastos (F12 → Console)";
        statusEl.classList.remove("muted");
        statusEl.classList.add("error");

        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="error">${String(err)}</td>`;
        tbody.appendChild(tr);
      }
    }

    document.getElementById("reload").addEventListener("click", loadExpenses);
    loadExpenses();
  </script>
</body>
</html>
