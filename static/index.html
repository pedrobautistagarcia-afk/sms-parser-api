<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro Gastos</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --muted:rgba(255,255,255,.7);
      --line:rgba(255,255,255,.08);
      --text:#fff;
      --chip:rgba(255,255,255,.08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(84,140,255,.28), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,170,80,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:22px 18px 28px; }
    .top{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    h1{ font-size:18px; margin:0; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:4px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.15);
    }
    .left, .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input, select, button{
      font: inherit;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      outline:none;
    }
    input::placeholder{ color:rgba(255,255,255,.45); }
    button{
      cursor:pointer;
      background: rgba(255,255,255,.10);
      transition: transform .05s ease, background .15s ease;
    }
    button:hover{ background: rgba(255,255,255,.16); }
    button:active{ transform: scale(.98); }
    .chip{
      padding:7px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--line);
      font-size:12px; color:var(--muted);
    }
    .kpis{ display:flex; gap:10px; flex-wrap:wrap; }
    table{ width:100%; border-collapse:collapse; }
    thead th{
      text-align:left; font-size:12px; color:rgba(255,255,255,.75);
      padding:10px 12px; border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      position:sticky; top:0; z-index:1;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;
      vertical-align:middle;
      line-height:1.25;
      white-space:nowrap;
    }
    tbody tr:hover{ background: rgba(255,255,255,.03); }
    .amt{ text-align:right; font-variant-numeric: tabular-nums; }
    .amt-expense{ color: rgba(255,90,90,.95); font-weight:600; }
    .amt-income{ color: rgba(90,255,160,.95); font-weight:600; }
    .muted{ color:var(--muted); }
    .category select{
      text-transform: capitalize;
      padding:6px 10px;
      background: rgba(255,255,255,.07);
    }
    .actions{ text-align:right; width:1%; }
    .btn-mini{
      padding:6px 10px;
      font-size:12px;
      border-radius:10px;
    }
    /* Rule button: solo visible al hover */
    .ruleBtn{ opacity:0; pointer-events:none; transition: opacity .12s ease; }
    tr:hover .ruleBtn{ opacity:1; pointer-events:auto; }

    /* Keep cell size stable on click */
    td:focus, td:active, td *:focus, td *:active{ outline:none !important; box-shadow:none !important; }
  </style>

<style>
/* SORT_HEADERS_V1 */
.th-sort{ cursor:pointer; user-select:none; }
.th-sort:hover{ background: rgba(255,255,255,.06); }
.sort-ind{ display:inline-block; min-width:14px; opacity:.85; }
</style>

</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Registro Gastos</h1>
        <div class="sub" id="statusLine">Loading…</div>
      </div>
      <div class="right">
        <button class="btn-mini" id="btnRefresh">Refresh</button>
        <button class="btn-mini" id="btnCsv">Export CSV</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="left">
          <input id="q" placeholder="Search merchant…" />
          <select id="cur">
            <option value="">All currencies</option>
            <option value="KWD">KWD</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
          <select id="cat">
            <option value="">All categories</option>
          </select>
          <span class="chip" id="chipCount">0 rows</span>
        </div>

        <div class="right">
          <button class="btn-mini" data-preset="today">Today</button>
          <button class="btn-mini" data-preset="week">Last week</button>
          <button class="btn-mini" data-preset="month">Last month</button>
          <button class="btn-mini" data-preset="year">This year</button>
          <button class="btn-mini" id="btnClear">Clear filters</button>
        </div>
      </div>

      <div style="overflow:auto; max-height:70vh;">
        <table>
          <thead>
            <tr>
              <th data-sort="created_at" class="th-sort">Created <span class="sort-ind" data-ind="created_at"></span></th>
              <th>Merchant</th>
              <th>Category</th>
              <th class="amt th-sort" data-sort="amount">Amount <span class="sort-ind" data-ind="amount"></span></th>
              <th>Cur</th>
              <th class="actions">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- SINGLE SOURCE OF TRUTH ---
  let lastGood = [];
  let view = [];

  // Sorting (default: newest first)
  const sortState = { key: "created_at", dir: "desc" }; // dir: "asc" | "desc"

  // Filters
  const filters = {
    q: "",
    cur: "",
    cat: "",
    from: null, // Date
    to: null
  };

  const $ = (id) => document.getElementById(id);

  function parseIso(s){
    if(!s) return null;
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }

  function setPreset(p){
    const now = new Date();
    const start = new Date(now);
    const end = new Date(now);

    if(p === "today"){
      start.setHours(0,0,0,0);
      end.setHours(23,59,59,999);
    } else if(p === "week"){
      start.setDate(now.getDate()-7);
    } else if(p === "month"){
      start.setMonth(now.getMonth()-1);
    } else if(p === "year"){
      start.setMonth(0,1);
      start.setHours(0,0,0,0);
    }
    filters.from = start;
    filters.to = end;
    applyAndRender();
  }

  function clearFilters(){
    filters.q = "";
    filters.cur = "";
    filters.cat = "";
    filters.from = null;
    filters.to = null;
    $("q").value = "";
    $("cur").value = "";
    $("cat").value = "";
    applyAndRender();
  }


  function sortView(){
    const k = sortState.key;
    const dir = sortState.dir === "asc" ? 1 : -1;

    view.sort((a,b) => {
      let av = a?.[k];
      let bv = b?.[k];

      if(k === "amount"){
        av = Number(av ?? 0);
        bv = Number(bv ?? 0);
        if(av === bv) return 0;
        return (av > bv ? 1 : -1) * dir;
      }

      // created_at (ISO)
      if(k === "created_at"){
        const ad = new Date(av || 0).getTime();
        const bd = new Date(bv || 0).getTime();
        if(ad === bd) return 0;
        return (ad > bd ? 1 : -1) * dir;
      }

      // fallback string
      av = String(av ?? "").toLowerCase();
      bv = String(bv ?? "").toLowerCase();
      if(av === bv) return 0;
      return (av > bv ? 1 : -1) * dir;
    });
  }

  function updateSortIndicators(){
    document.querySelectorAll(".sort-ind").forEach(el => el.textContent = "");
    const ind = document.querySelector(`.sort-ind[data-ind="${sortState.key}"]`);
    if(ind) ind.textContent = (sortState.dir === "asc") ? "↑" : "↓";
  }


  async function loadExpenses(){
    const url = `/expenses?user_id=pedro&limit=500`;
    $("statusLine").textContent = "Loading…";
    try{
      const r = await fetch(url, { cache: "no-store" });
      const j = await r.json();
      if(j && Array.isArray(j.expenses)){
        // IMPORTANT: never wipe lastGood on empty unless explicitly true empty
        // If backend returns count=0 but we previously had data, keep lastGood.
        if(j.expenses.length > 0){
          lastGood = j.expenses;
        } else if(lastGood.length === 0){
          lastGood = j.expenses;
        }
        $("statusLine").textContent = `OK · ${new Date().toLocaleTimeString()} · rows=${lastGood.length}`;
      } else {
        $("statusLine").textContent = "Bad response";
      }
    } catch(e){
      $("statusLine").textContent = "Fetch error (kept last data)";
      console.error(e);
    }
    hydrateCategoryFilter();
    applyAndRender();
  }

  function hydrateCategoryFilter(){
    const set = new Set(lastGood.map(e => (e.category || "other").toLowerCase()));
    const cats = Array.from(set).sort();
    const sel = $("cat");
    const current = sel.value;
    sel.innerHTML = `<option value="">All categories</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join("");
    sel.value = current || "";
  }

  function applyAndRender(){
    const q = filters.q.trim().toLowerCase();
    const cur = filters.cur;
    const cat = filters.cat;

    view = lastGood.filter(e => {
      const m = (e.merchant_clean || "").toLowerCase();
      if(q && !m.includes(q)) return false;
      if(cur && (e.currency || "") !== cur) return false;
      if(cat && (e.category || "other").toLowerCase() !== cat.toLowerCase()) return false;

      const d = parseIso(e.created_at);
      if(filters.from && d && d < filters.from) return false;
      if(filters.to && d && d > filters.to) return false;

      return true;
    });

    sortView();
    updateSortIndicators();
    renderTable();
  }

  function fmtDate(iso){
    if(!iso) return "";
    return iso.replace("T"," ").replace("+00:00","").replace("Z","");
  }

  function renderTable(){
    const tb = $("tbody");
    tb.innerHTML = "";

    for(const e of view){
      const tr = document.createElement("tr");
      tr.setAttribute("data-id", e.id);

      const catVal = (e.category || "other").toLowerCase();
      const cur = (e.currency || "").toUpperCase();
      const amt = Number(e.amount || 0);

      // Expense vs income coloring (from backend field "direction")
      
      const sms = String(e.sms || "").toLowerCase();
      const isIncome =
        sms.includes("credit") ||
        sms.includes("credited") ||
        sms.includes("deposit") ||
        sms.includes("salary") ||
        sms.includes("received") ||
        sms.includes("refund");

      const amtClass = isIncome ? "amt-income" : "amt-expense";

      tr.innerHTML = `
        <td class="muted">${fmtDate(e.created_at)}</td>
        <td>${e.merchant_clean || ""}</td>
        <td class="category">
          <select data-id="${e.id}">
            ${["other","coffee","food","transport","shopping","rent","utilities","salary","income"].map(c =>
              `<option value="${c}" ${c===catVal ? "selected":""}>${c}</option>`
            ).join("")}
          </select>
        </td>
        <td class="amt ${amtClass}">${(isIncome ? "+" : "") + amt.toFixed(3)}</td>
        <td class="muted">${cur}</td>
        <td class="actions">
          <button class="btn-mini ruleBtn" data-action="rule" data-id="${e.id}">Rule</button>
          <button class="btn-mini" data-action="del" data-id="${e.id}">Delete</button>
        </td>
      `;
      tb.appendChild(tr);
    }

    $("chipCount").textContent = `${view.length} rows`;
  }

  // Actions
  document.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button");
    if(!btn) return;

    const action = btn.getAttribute("data-action");
    const id = btn.getAttribute("data-id");
    if(!action || !id) return;

    if(action === "del"){
      if(!confirm(`Delete expense #${id}?`)) return;
      try{
        const r = await fetch(`/expense/${id}?user_id=pedro`, { method:"DELETE" });
        const j = await r.json();
        if(j && j.deleted){
          lastGood = lastGood.filter(x => String(x.id) !== String(id));
          applyAndRender();
        }
      } catch(e){ console.error(e); }
    }

    if(action === "rule"){
      // Minimal placeholder: later we open modal
      alert("Rule UI next. (Backend endpoint /rules is ready)");
    }
  });

  // Category change (visual-only for now)
  document.addEventListener("change", (ev) => {
    const sel = ev.target.closest("select[data-id]");
    if(!sel) return;
    const id = sel.getAttribute("data-id");
    const val = sel.value;

    // Update local view so it doesn't jump back
    const row = lastGood.find(x => String(x.id) === String(id));
    if(row) row.category = val;

    applyAndRender();
  });

  // Inputs
  $("q").addEventListener("input", () => { filters.q = $("q").value; applyAndRender(); });
  $("cur").addEventListener("change", () => { filters.cur = $("cur").value; applyAndRender(); });
  $("cat").addEventListener("change", () => { filters.cat = $("cat").value; applyAndRender(); });


  // Click-to-sort on table headers
  document.addEventListener("click", (ev) => {
    const th = ev.target.closest("th.th-sort");
    if(!th) return;
    const key = th.getAttribute("data-sort");
    if(!key) return;

    if(sortState.key === key){
      sortState.dir = (sortState.dir === "asc") ? "desc" : "asc";
    } else {
      sortState.key = key;
      // default direction: created desc, amount desc
      sortState.dir = (key === "created_at" || key === "amount") ? "desc" : "asc";
    }
    applyAndRender();
  });

  document.querySelectorAll("button[data-preset]").forEach(b => {
    b.addEventListener("click", () => setPreset(b.getAttribute("data-preset")));
  });

  $("btnClear").addEventListener("click", clearFilters);
  $("btnRefresh").addEventListener("click", loadExpenses);

  $("btnCsv").addEventListener("click", () => {
    const rows = view;
    const header = ["created_at","merchant_clean","category","amount","currency"];
    const csv = [
      header.join(","),
      ...rows.map(e => header.map(k => {
        const v = (e[k] ?? "");
        const s = String(v).replaceAll('"','""');
        return `"${s}"`;
      }).join(","))
    ].join("\n");

    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `expenses_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Boot
  clearFilters();
  updateSortIndicators();
  loadExpenses();
})();
</script>
</body>
</html>
