<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro Gastos</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#111b27; --text:#e6edf3; --muted:#93a4b8;
      --line:rgba(255,255,255,.10);
      --chip:rgba(255,255,255,.06);
      --danger:#ff5c66; --ok:#3ddc97;
      --accent:#7aa2ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#ffffff; --panel:#f6f7f9; --panel2:#ffffff; --text:#0b1220; --muted:#516074;
      --line:rgba(0,0,0,.10);
      --chip:rgba(0,0,0,.06);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      display:flex; align-items:center; gap:10px;
    }
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .pill{
      border:1px solid var(--line); background:var(--chip); padding:6px 10px; border-radius:999px;
      color:var(--muted); font-size:12px;
    }

    .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--line); background:var(--panel2); color:var(--text);
      padding:8px 10px; border-radius:10px; cursor:pointer; box-shadow:none;
      font-size:13px;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(122,162,255,.35); background:rgba(122,162,255,.12)}
    .btn.danger{border-color:rgba(255,92,102,.35); background:rgba(255,92,102,.10)}
    .btn.ghost{background:transparent}
    .iconbtn{width:40px; display:inline-flex; align-items:center; justify-content:center}

    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:12px;
      box-shadow:var(--shadow);
    }

    .ctrl{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .ctrl label{
      font-size:12px; color:var(--muted); margin-right:2px;
    }
    select, input[type="date"], input[type="text"]{
      border:1px solid var(--line); background:var(--panel2); color:var(--text);
      padding:8px 10px; border-radius:10px; font-size:13px; outline:none;
    }
    select:focus, input:focus{border-color:rgba(122,162,255,.45)}
    .spacer{flex:1}

    .balance{
      position:relative;
    }
    .dropdown{
      position:absolute; right:0; top:44px; z-index:20;
      min-width:230px;
      border:1px solid var(--line); background:var(--panel2);
      border-radius:14px; box-shadow:var(--shadow);
      padding:10px;
      display:none;
    }
    .dropdown.open{display:block}
    .brow{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 8px; border-radius:10px;
    }
    .brow:hover{background:var(--chip)}
    .brow b{font-weight:700}
    .pos{color:var(--ok); font-weight:700}
    .neg{color:var(--danger); font-weight:700}

    .tablewrap{
      margin-top:14px;
      border:1px solid var(--line); background:var(--panel);
      border-radius:14px; overflow:hidden; box-shadow:var(--shadow);
    }
    table{width:100%; border-collapse:collapse; table-layout:fixed}
    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      padding:12px 12px; border-bottom:1px solid var(--line);
      user-select:none; cursor:pointer;
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px; border-bottom:1px solid var(--line);
      font-size:13px; vertical-align:middle;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    [data-theme="light"] tbody tr:hover{background:rgba(0,0,0,.03)}
    .amt{text-align:right; font-variant-numeric: tabular-nums}
    .curcell{display:flex; align-items:center; gap:6px}
    .flag{display:inline-flex; width:18px}
    .flag svg{width:16px; height:12px; border-radius:3px; display:block}
    .catSel, .merchantEdit{
      width:100%;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      padding:6px 8px;
      border-radius:10px;
    }
    .merchantEdit:hover{background:var(--chip)}
    .merchantEdit:focus{outline:none; border-color:rgba(122,162,255,.45); background:var(--panel2)}
    .cellActions{
      opacity:0; transition:opacity .12s ease;
      display:flex; justify-content:flex-end;
    }
    tr:hover .cellActions{opacity:1}
    .small{font-size:12px; color:var(--muted)}
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--panel2);
      display:none;
      align-items:center; justify-content:space-between; gap:10px;
    }
    .toast.show{display:flex}
    .err{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,92,102,.35);
      background:rgba(255,92,102,.10);
      color:#ffb4b4;
      display:none;
      white-space:pre-wrap;
    }
    .err.show{display:block}

    .sortHint{opacity:.6; margin-left:6px; font-size:11px}
    .kpiRow{
      display:none;
      margin-top:12px;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap:10px;
    }
    .kpiRow.show{display:grid}
    .kpi{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:14px;
      padding:12px;
      box-shadow:var(--shadow);
    }
    .kpi .v{font-size:18px; font-weight:800; margin-top:6px}
  
/* Keep selection visible even when not hovering */
tr .row-select { opacity: 0; transition: opacity .12s ease; }
tr:hover .row-select { opacity: 1; }
tr .row-select:checked { opacity: 1; }
tr.selected-row { outline: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.04); }


/* --- RG patch: always-visible row selector --- */
th.rg-sel, td.rg-sel { width: 36px; text-align: center; }
input.rg-rowcb { width: 16px; height: 16px; cursor: pointer; }
tr.rg-selected { outline: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.05); }


/* --- RG patch: selection visibility + remove hover dot --- */

/* Checkbox: oculto por defecto */
td.rg-sel .rg-rowcb { opacity: 0; }
tbody tr:hover td.rg-sel .rg-rowcb { opacity: 1; }     /* visible al hover para poder seleccionar */
td.rg-sel .rg-rowcb:checked { opacity: 1; }            /* visible si est√° seleccionado */

/* Mant√©n el highlight SOLO si est√° seleccionado */
tbody tr.rg-selected { outline: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.05); }

/* Quitar posibles "dots" / circulitos que aparezcan al hover al final de la fila */
tbody tr:hover td:last-child::after { content: none !important; display: none !important; }
tbody tr:hover::after { content: none !important; display: none !important; }

/* Quita elementos t√≠picos de hover-actions tipo dot */
tbody tr:hover .hover-dot,
tbody tr:hover .row-dot,
tbody tr:hover .dot,
tbody tr:hover .rule-dot,
tbody tr:hover .action-dot,
tbody tr:hover .menu-dot,
tbody tr:hover .kebab,
tbody tr:hover .ellipsis { display: none !important; }

/* Si el "circulito" es un bot√≥n peque√±o vac√≠o al final (muy com√∫n), lo escondemos */
tbody tr:hover td:last-child button:empty { display: none !important; }


/* --- RG patch: fix amount/currency + remove right hover dot --- */

/* El "circulito" suele ser un bot√≥n peque√±o en la √∫ltima celda que aparece en hover */
tbody tr:hover td:last-child button,
tbody tr td:last-child button {
  display: none !important;
}

/* Si no es button sino un div/span tipo dot/icon */
tbody tr:hover td:last-child .dot,
tbody tr td:last-child .dot,
tbody tr:hover td:last-child .hover-dot,
tbody tr td:last-child .hover-dot,
tbody tr:hover td:last-child .row-dot,
tbody tr td:last-child .row-dot,
tbody tr:hover td:last-child .action-dot,
tbody tr td:last-child .action-dot,
tbody tr:hover td:last-child .menu-dot,
tbody tr td:last-child .menu-dot {
  display: none !important;
}

</style>
</head>
<body>
<div class="wrap" id="app">
  <div class="top">
    <div class="title">
      <h1>Registro Gastos</h1>
      <div class="pill" id="statusPill">loading‚Ä¶</div>
      <button class="btn ghost" id="toggleKpi">KPIs</button>
    </div>

    <div class="right">
      <button class="btn iconbtn" id="themeBtn" title="Tema">
        <span id="themeIcon">üåô</span>
      </button>

      <div class="balance">
        <button class="btn primary" id="balanceBtn">Balance</button>
        <div class="dropdown" id="balanceMenu">
          <div class="brow"><b><span class="flag" data-cur="KWD"></span> KWD</b><span id="balKWD" class="small">‚Äî</span></div>
          <div class="brow"><b><span class="flag" data-cur="USD"></span> USD</b><span id="balUSD" class="small">‚Äî</span></div>
          <div class="brow"><b><span class="flag" data-cur="EUR"></span> EUR</b><span id="balEUR" class="small">‚Äî</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="ctrl">
      <label>Currency</label>
      <select id="curFilter"></select>
    </div>
    <div class="ctrl">
      <label>Category</label>
      <select id="catFilter"></select>
    </div>
    <div class="ctrl">
      <label>From</label>
      <input type="date" id="dateFrom">
    </div>
    <div class="ctrl">
      <label>To</label>
      <input type="date" id="dateTo">
    </div>

    <div class="ctrl">
      <button class="btn" id="btnToday">Today</button>
      <button class="btn" id="btnWeek">Last week</button>
      <button class="btn" id="btnMonth">Last month</button>
      <button class="btn" id="btnYear">This year</button>
      <button class="btn" id="btnClear">Clear</button>
    </div>

    <div class="spacer"></div>

    <div class="ctrl">
      <button class="btn danger" id="btnDelete" disabled>Delete selected</button>
      <button class="btn" id="btnExport">Export CSV</button>
    </div>
  </div>

  <div class="kpiRow" id="kpiRow">
    <div class="kpi"><div class="small">Total (filtered)</div><div class="v" id="kpiTotal">‚Äî</div></div>
    <div class="kpi"><div class="small">Today</div><div class="v" id="kpiToday">‚Äî</div></div>
    <div class="kpi"><div class="small">Avg / day</div><div class="v" id="kpiAvg">‚Äî</div></div>
    <div class="kpi"><div class="small">Top category</div><div class="v" id="kpiTopCat">‚Äî</div></div>
  </div>

  <div class="err" id="errBox"></div>

  <div class="toast" id="toast">
    <div id="toastMsg">Deleted.</div>
    <button class="btn" id="btnUndo">Undo (10s)</button>
  </div>

  <div class="tablewrap">
    <table id="t">
      <thead>
        <tr>
          <th data-sort="created_at">Date <span class="sortHint" id="sortHintDate"></span></th>
          <th data-sort="merchant_clean">Merchant</th>
          <th data-sort="category">Category</th>
          <th data-sort="currency">Currency</th>
          <th data-sort="amount" style="text-align:right">Amount</th>
          <th style="width:54px;"></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
  
function addApiKey(url){
  const u = new URL(url, window.location.origin);
  u.searchParams.set("api_key", 'ElPortichuelo99');
  return u.pathname + u.search;
}
// =============== CONFIG ===============
  const USER_ID = "pedro";
  const API_KEY = "ElPortichuelo99";
  const LIMIT = 500;

  // =============== FLAGS (SVG) ===============
  function flagHTML(cur){
    const c = String(cur||"").toUpperCase();
    const KUWAIT = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#fff"/>
      <rect width="16" height="4" y="0" fill="#0B7A3B"/>
      <rect width="16" height="4" y="8" fill="#C8102E"/>
      <path d="M0 0h5L8 6 5 12H0z" fill="#000"/>
    </svg>`;
    const USA = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#fff"/>
      <g fill="#B22234">
        <rect y="0" width="16" height="1"/>
        <rect y="2" width="16" height="1"/>
        <rect y="4" width="16" height="1"/>
        <rect y="6" width="16" height="1"/>
        <rect y="8" width="16" height="1"/>
        <rect y="10" width="16" height="1"/>
      </g>
      <rect width="7" height="5" fill="#3C3B6E"/>
      <g fill="#fff" opacity=".9">
        <circle cx="1.2" cy="1" r=".25"/><circle cx="2.4" cy="1" r=".25"/><circle cx="3.6" cy="1" r=".25"/><circle cx="4.8" cy="1" r=".25"/><circle cx="6.0" cy="1" r=".25"/>
        <circle cx="1.8" cy="2" r=".25"/><circle cx="3.0" cy="2" r=".25"/><circle cx="4.2" cy="2" r=".25"/><circle cx="5.4" cy="2" r=".25"/>
        <circle cx="1.2" cy="3" r=".25"/><circle cx="2.4" cy="3" r=".25"/><circle cx="3.6" cy="3" r=".25"/><circle cx="4.8" cy="3" r=".25"/><circle cx="6.0" cy="3" r=".25"/>
        <circle cx="1.8" cy="4" r=".25"/><circle cx="3.0" cy="4" r=".25"/><circle cx="4.2" cy="4" r=".25"/><circle cx="5.4" cy="4" r=".25"/>
      </g>
    </svg>`;
    const EU = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#003399"/>
      <g fill="#FFCC00">
        <circle cx="8" cy="2.1" r=".35"/>
        <circle cx="10.2" cy="2.7" r=".35"/>
        <circle cx="11.8" cy="4.3" r=".35"/>
        <circle cx="12.4" cy="6.0" r=".35"/>
        <circle cx="11.8" cy="7.7" r=".35"/>
        <circle cx="10.2" cy="9.3" r=".35"/>
        <circle cx="8" cy="9.9" r=".35"/>
        <circle cx="5.8" cy="9.3" r=".35"/>
        <circle cx="4.2" cy="7.7" r=".35"/>
        <circle cx="3.6" cy="6.0" r=".35"/>
        <circle cx="4.2" cy="4.3" r=".35"/>
        <circle cx="5.8" cy="2.7" r=".35"/>
      </g>
    </svg>`;
    if(c==="KWD") return KUWAIT;
    if(c==="USD") return USA;
    if(c==="EUR") return EU;
    return "";
  }
  function initFlags(){
    document.querySelectorAll(".flag[data-cur]").forEach(el=>{
      el.innerHTML = flagHTML(el.getAttribute("data-cur"));
    });
  }

  // =============== HELPERS ===============
  const $ = (id)=>document.getElementById(id);
  function setStatus(txt){ $("statusPill").textContent = txt; }
  function showErr(msg){
    const b = $("errBox");
    b.textContent = String(msg||"");
    b.classList.toggle("show", !!msg);
  }
  function api(url){
    const u = new URL(url, window.location.origin);
    return u.pathname + u.search;
  }
  function apiKey(url){
    const u = new URL(url, window.location.origin);
    u.searchParams.set("api_key", API_KEY);
    return u.pathname + u.search;
  }
  async function getJSON(url){
    const r = await fetch(api(url));
    const j = await r.json();
    return j;
  }
  async function postJSON(url, body){
    const r = await fetch(apiKey(url), {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body||{})
    });
    const t = await r.text().catch(()=> "");
    if(!r.ok) throw new Error(`${url} => HTTP ${r.status} :: ${t}`);
    try{ return JSON.parse(t); }catch(_){ return {ok:true}; }
  }
  function titleCase(x){
    x = String(x||"").trim();
    if(!x) return "";
    return x.charAt(0).toUpperCase() + x.slice(1);
  }
  function isoDay(s){ return (s||"").slice(0,10); }
  function parseDate(s){
    // created_at is ISO, keep as Date
    try{ return new Date(s); }catch(_){ return null; }
  }
  function fmtMoney(n){
    if(n===null||n===undefined||n==="") return "";
    const v = Number(n);
    if(Number.isNaN(v)) return String(n);
    return v.toFixed(3).replace(/\.000$/,".000").replace(/(\.\d{2})0$/,"$1");
  }
  function inferDirection(row){
    const d = (row.direction||"").toLowerCase();
    if(d==="in"||d==="credit"||d==="credited") return "in";
    if(d==="out"||d==="debit"||d==="debited") return "out";
    const sms = (row.sms||row.sms_raw||"").toLowerCase();
    if(sms.includes("credited")) return "in";
    if(sms.includes("debited")) return "out";
    return "out"; // default gasto
  }

  // =============== STATE ===============
  const state = {
    all: [],
    view: [],
    selectedId: null,
    sortKey: "created_at",
    sortDir: "desc",
    categories: new Set(),
    currencies: new Set(),
    undoTimer: null,
    lastDeleted: null
  };

  // =============== THEME ===============
  function setTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem("theme", t);
    $("themeIcon").textContent = (t==="light") ? "‚òÄÔ∏è" : "üåô";
  }
  function initTheme(){
    const t = localStorage.getItem("theme") || "dark";
    setTheme(t);
  }

  // =============== FILTERS ===============
  function buildFilters(){
    // currencies
    const curSel = $("curFilter");
    const curs = Array.from(state.currencies).sort();
    curSel.innerHTML = `<option value="">All currencies</option>` + curs.map(c=>`<option value="${c}">${c}</option>`).join("");

    // categories
    const catSel = $("catFilter");
    const cats = Array.from(state.categories).sort();
    catSel.innerHTML = `<option value="">All categories</option>` + cats.map(c=>`<option value="${c}">${titleCase(c)}</option>`).join("");
  }

  function applyFilters(){
    const cur = $("curFilter").value || "";
    const cat = $("catFilter").value || "";
    const df = $("dateFrom").value || "";
    const dt = $("dateTo").value || "";

    state.view = state.all.filter(r=>{
      if(cur && (r.currency||"")!==cur) return false;
      if(cat && (r.category||"")!==cat) return false;

      if(df || dt){
        const d = isoDay(r.created_at || r.date_iso || r.date_raw || "");
        if(df && d && d < df) return false;
        if(dt && d && d > dt) return false;
      }
      return true;
    });

    sortView();
    render();
  }

  function setQuickRange(mode){
    const today = new Date();
    const iso = (d)=> d.toISOString().slice(0,10);
    const to = iso(today);
    let from = "";
    if(mode==="today"){
      from = to;
    }else if(mode==="week"){
      const d = new Date(today); d.setDate(d.getDate()-7);
      from = iso(d);
    }else if(mode==="month"){
      const d = new Date(today); d.setMonth(d.getMonth()-1);
      from = iso(d);
    }else if(mode==="year"){
      const d = new Date(today); d.setMonth(0); d.setDate(1);
      from = iso(d);
    }
    $("dateFrom").value = from;
    $("dateTo").value = to;
    applyFilters();
  }

  function clearFilters(){
    $("curFilter").value = "";
    $("catFilter").value = "";
    $("dateFrom").value = "";
    $("dateTo").value = "";
    applyFilters();
  }

  // =============== SORT ===============
  function sortView(){
    const k = state.sortKey;
    const dir = state.sortDir === "asc" ? 1 : -1;
    state.view.sort((a,b)=>{
      let av = a[k], bv = b[k];
      if(k==="amount"){
        av = Number(av||0); bv = Number(bv||0);
      }else{
        av = String(av||""); bv = String(bv||"");
      }
      if(av < bv) return -1*dir;
      if(av > bv) return  1*dir;
      return 0;
    });
    $("sortHintDate").textContent = (state.sortKey==="created_at") ? (state.sortDir==="asc"?"‚Üë":"‚Üì") : "";
  }

  // =============== BALANCE + KPI ===============
  function computeBalance(rows){
    const out = {KWD:0, USD:0, EUR:0};
    for(const r of rows){
      const cur = (r.currency||"").toUpperCase();
      const amt = Number(r.amount||0);
      const sign = inferDirection(r)==="in" ? 1 : -1;
      if(out[cur]!==undefined) out[cur] += sign*amt;
    }
    return out;
  }

  function updateBalanceAndKpis(){
    const rows = state.view;
    const b = computeBalance(rows);

    const fmt = (v)=> (v>=0 ? `<span class="pos">${v.toFixed(3)}</span>` : `<span class="neg">${v.toFixed(3)}</span>`);
    $("balKWD").innerHTML = fmt(b.KWD);
    $("balUSD").innerHTML = fmt(b.USD);
    $("balEUR").innerHTML = fmt(b.EUR);

    // KPI: total (sum abs signed)
    const tot = b.KWD + b.USD + b.EUR; // mixto, solo para idea (principalmente KWD)
    $("kpiTotal").textContent = `${tot.toFixed(3)} (mix)`;

    // today
    const t = new Date().toISOString().slice(0,10);
    const todayRows = rows.filter(r => isoDay(r.created_at||"") === t);
    const bt = computeBalance(todayRows);
    const todayMix = bt.KWD+bt.USD+bt.EUR;
    $("kpiToday").textContent = `${todayMix.toFixed(3)} (mix)`;

    // avg/day (por d√≠as en dataset)
    const days = new Set(rows.map(r=>isoDay(r.created_at||"")).filter(Boolean));
    const dcount = Math.max(1, days.size);
    $("kpiAvg").textContent = `${(todayMix/dcount).toFixed(3)} (mix)`;

    // top cat
    const m = new Map();
    for(const r of rows){
      const c = (r.category||"other");
      m.set(c, (m.get(c)||0) + 1);
    }
    let best = "‚Äî", bestN=0;
    for(const [k,v] of m.entries()){
      if(v>bestN){bestN=v; best=k;}
    }
    $("kpiTopCat").textContent = titleCase(best);
  }

  // =============== RENDER ===============
  function render(){
    const tb = $("tbody");
    tb.innerHTML = "";

    for(const r of state.view){
      const id = r.id;
      const dir = inferDirection(r);
      const signClass = dir==="in" ? "pos" : "neg";
      const amountTxt = fmtMoney(r.amount);
      const dateTxt = isoDay(r.created_at || r.date_iso || r.date_raw || "");
      const cur = (r.currency||"").toUpperCase();
      const cat = (r.category||"other");
      const merch = (r.merchant_clean ?? r.merchant_raw ?? "").trim();

      const tr = document.createElement("tr");
      tr.dataset.id = id;

      tr.innerHTML = `
        <td title="${dateTxt}">${dateTxt}</td>
        <td>
          <input class="merchantEdit" data-id="${id}" value="${merch.replace(/"/g,'&quot;')}" />
        </td>
        <td>
          ${categoryCellHTML(id, cat)}
        </td>
        <td>
          <div class="curcell" title="${cur}">
            <span class="flag">${flagHTML(cur)}</span><span>${cur}</span>
          </div>
        </td>
        <td class="amt ${signClass}" title="${amountTxt}">${amountTxt}</td>
        <td>
          <div class="cellActions">
            <input type="radio" name="sel" ${state.selectedId===id ? "checked":""} />
          </div>
        </td>
      `;

      tr.addEventListener("click", (e)=>{
        const rid = Number(tr.dataset.id);
        state.selectedId = rid;
        $("btnDelete").disabled = false;
        // marcar radio
        tr.querySelector('input[type="radio"]').checked = true;
      });

      tb.appendChild(tr);
    }

    setStatus(`count ${state.view.length}`);
    updateBalanceAndKpis();
    wireRowInputs(); // binds after render
  }

  function categoryCellHTML(id, current){
    const cats = Array.from(state.categories).sort();
    const options = cats.map(c=>{
      const sel = c===current ? "selected" : "";
      return `<option value="${c}" ${sel}>${titleCase(c)}</option>`;
    }).join("");
    return `
      <select class="catSel" data-id="${id}">
        ${options}
        <option value="__add__">+ Add category‚Ä¶</option>
      </select>
    `;
  }

  function wireRowInputs(){
    // merchant edit
    document.querySelectorAll(".merchantEdit").forEach(inp=>{
      inp.addEventListener("keydown", async (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          inp.blur();
        }
      });
      inp.addEventListener("blur", async ()=>{
        const id = Number(inp.dataset.id);
        const val = inp.value.trim();
        try{
          showErr("");
          await postJSON("/update_field", {userid: USER_ID, id, field:"merchant_clean", value: val});
          // update local
          const row = state.all.find(x=>x.id===id);
          if(row) row.merchant_clean = val;
          applyFilters();
        }catch(err){
          showErr("Save merchant failed: " + err.message);
        }
      });
    });

    // category select
    document.querySelectorAll(".catSel").forEach(sel=>{
      sel.addEventListener("change", async ()=>{
        const id = Number(sel.dataset.id);
        const v = sel.value;
        if(v === "__add__"){
          const name = prompt("New category name:");
          if(!name){
            // revert
            const row = state.all.find(x=>x.id===id);
            sel.value = row?.category || "other";
            return;
          }
          const cat = name.trim().toLowerCase();
          if(!cat){
            const row = state.all.find(x=>x.id===id);
            sel.value = row?.category || "other";
            return;
          }
          state.categories.add(cat);
          buildFilters();
          // re-render row dropdowns will happen after applyFilters
          await saveCategory(id, cat);
          return;
        }
        await saveCategory(id, v);
      });
    });
  }

  async function saveCategory(id, cat){
    try{
      showErr("");
      await postJSON("/update_field", {userid: USER_ID, id, field:"category", value: cat});
      const row = state.all.find(x=>x.id===id);
      if(row) row.category = cat;
      applyFilters();
    }catch(err){
      showErr("Save category failed: " + err.message);
      // revert UI
      const row = state.all.find(x=>x.id===id);
      if(row) applyFilters();
    }
  }

  // =============== DELETE + UNDO ===============
  function showToast(msg){
    $("toastMsg").textContent = msg;
    $("toast").classList.add("show");
    clearTimeout(state.undoTimer);
    state.undoTimer = setTimeout(()=> $("toast").classList.remove("show"), 10000);
  }

  async function doDeleteSelected(){
    if(!state.selectedId) return;
    const id = state.selectedId;
    try{
      showErr("");
      await postJSON("/delete", {userid: USER_ID, id});
      showToast(`Deleted #${id}`);
      await load();
    }catch(err){
      showErr("Delete failed: " + err.message);
    }
  }

  async function undoDelete(){
    try{
      showErr("");
      await postJSON("/undo_delete", {userid: USER_ID});
      $("toast").classList.remove("show");
      await load();
    }catch(err){
      showErr("Undo failed: " + err.message);
    }
  }

  // =============== EXPORT CSV ===============
  function exportCSV(){
    const rows = state.view;
    const headers = ["created_at","merchant_clean","category","currency","amount"];
    const escape = (v)=> `"${String(v??"").replace(/"/g,'""')}"`;
    const lines = [headers.join(",")].concat(rows.map(r=>[
      r.created_at||"",
      r.merchant_clean||"",
      r.category||"",
      r.currency||"",
      r.amount??""
    ].map(escape).join(",")));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "registro_gastos.csv";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  // =============== LOAD ===============
  async function load(){
    try{
      showErr("");
      setStatus("loading‚Ä¶");
      const j = await getJSON(`/expenses?user_id=${encodeURIComponent(USER_ID)}&limit=${LIMIT}`);
      const rows = j.expenses || [];
      state.all = rows;

      // sets
      state.categories = new Set(rows.map(r => (r.category||"other").toLowerCase()));
      state.currencies = new Set(rows.map(r => (r.currency||"").toUpperCase()).filter(Boolean));

      // ensure defaults exist
      if(!state.categories.size) state.categories.add("other");
      if(!state.currencies.size) state.currencies.add("KWD");

      buildFilters();
      applyFilters();
      setStatus(`count ${state.view.length}`);
    }catch(err){
      showErr(String(err?.message || err));
      setStatus("error");
    }
  }

  // =============== EVENTS ===============
  function bind(){
    initFlags();
    initTheme();

    $("toggleKpi").addEventListener("click", ()=>{
      $("kpiRow").classList.toggle("show");
    });

    $("themeBtn").addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      setTheme(cur==="dark" ? "light" : "dark");
    });

    $("balanceBtn").addEventListener("click", ()=>{
      $("balanceMenu").classList.toggle("open");
    });
    document.addEventListener("click",(e)=>{
      if(!e.target.closest(".balance")) $("balanceMenu").classList.remove("open");
    });

    $("curFilter").addEventListener("change", applyFilters);
    $("catFilter").addEventListener("change", applyFilters);
    $("dateFrom").addEventListener("change", applyFilters);
    $("dateTo").addEventListener("change", applyFilters);

    $("btnToday").addEventListener("click", ()=>setQuickRange("today"));
    $("btnWeek").addEventListener("click", ()=>setQuickRange("week"));
    $("btnMonth").addEventListener("click", ()=>setQuickRange("month"));
    $("btnYear").addEventListener("click", ()=>setQuickRange("year"));
    $("btnClear").addEventListener("click", clearFilters);

    $("btnDelete").addEventListener("click", doDeleteSelected);
    $("btnUndo").addEventListener("click", undoDelete);
    $("btnExport").addEventListener("click", exportCSV);

    // sorting headers
    document.querySelectorAll("thead th[data-sort]").forEach(th=>{
      th.addEventListener("click", ()=>{
        const k = th.getAttribute("data-sort");
        if(state.sortKey === k){
          state.sortDir = (state.sortDir==="asc") ? "desc" : "asc";
        }else{
          state.sortKey = k;
          state.sortDir = (k==="created_at") ? "desc" : "asc";
        }
        sortView();
        render();
      });
    });
  }

  // boot
  bind();
  load();

// Persist row selection (do not lose selection on mouse leave)
document.addEventListener("change", (e) => {
  const el = e.target;
  if (!el || !el.classList || !el.classList.contains("row-select")) return;
  const tr = el.closest("tr");
  if (tr) tr.classList.toggle("selected-row", el.checked);
});


/* --- RG patch: persistent multi-select + delete selected --- */
window.__rgSel = window.__rgSel || new Set();

function rgEnsureSelectHeader() {
  const theadRow = document.querySelector("thead tr");
  if (!theadRow) return;
  if (theadRow.querySelector("th.rg-sel")) return;

  const th = document.createElement("th");
  th.className = "rg-sel";
  th.title = "Select";
  th.innerHTML = "‚úì";
  theadRow.insertBefore(th, theadRow.firstChild);
}

function rgRowIdFromTr(tr){
  if (!tr) return null;
  const did = tr.getAttribute("data-id") || tr.dataset?.id;
  if (did && /^\d+$/.test(did)) return Number(did);
  // fallback: first numeric cell
  const tds = Array.from(tr.querySelectorAll("td"));
  for (const td of tds){
    const txt = (td.textContent||"").trim();
    if (/^\d+$/.test(txt)) return Number(txt);
  }
  return null;
}

function rgInjectCheckboxes(){
  rgEnsureSelectHeader();
  const tbody = document.querySelector("tbody");
  if (!tbody) return;

  tbody.querySelectorAll("tr").forEach(tr => {
    if (tr.querySelector("td.rg-sel")) return;

    const id = rgRowIdFromTr(tr);
    const td = document.createElement("td");
    td.className = "rg-sel";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.className = "rg-rowcb";
    if (id && window.__rgSel.has(id)) cb.checked = true;

    cb.addEventListener("change", () => {
      const rid = rgRowIdFromTr(tr);
      if (!rid) return;
      if (cb.checked) window.__rgSel.add(rid);
      else window.__rgSel.delete(rid);
      tr.classList.toggle("rg-selected", cb.checked);
    });

    td.appendChild(cb);
    tr.insertBefore(td, tr.firstChild);

    // apply selected style
    if (id && window.__rgSel.has(id)) tr.classList.add("rg-selected");
  });
}

// Observe table changes and reinject checkboxes after refresh/filter
(function(){
  const tbody = document.querySelector("tbody");
  if (!tbody) return;
  const obs = new MutationObserver(() => rgInjectCheckboxes());
  obs.observe(tbody, { childList: true, subtree: true });
  rgInjectCheckboxes();
})();

// Optional: hook existing Delete button to delete selected (if it exists)
async function rgDeleteSelected(){
  const ids = Array.from(window.__rgSel);
  if (!ids.length){ alert("No rows selected."); return; }

  const user = window.__currentUserId || "pedro";
  for (const id of ids){
    const res = await fetch(rgAddApiKey("/delete"), {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({userid: user, id})
    });
    if (!res.ok){
      const txt = await res.text();
      alert("Delete failed id "+id+": "+res.status+" :: "+txt);
      return;
    }
    window.__rgSel.delete(id);
  }
  if (typeof window.loadExpenses === "function") window.loadExpenses();
  else location.reload();
}

// Hook: if there is a button whose text includes "Delete selected" or "Delete"
function rgHookDeleteBtn(){
  const btns = Array.from(document.querySelectorAll("button"));
  const b = btns.find(x => /delete selected|borrar seleccion|borrar/i.test((x.textContent||"").trim()));
  if (b && !b.__rgHooked){
    b.__rgHooked = true;
    b.addEventListener("click", (e)=>{ e.preventDefault(); rgDeleteSelected(); });
  }
}
document.addEventListener("DOMContentLoaded", rgHookDeleteBtn);
setTimeout(rgHookDeleteBtn, 800);


/* --- RG patch: move Currency right after Amount --- */
function rgMoveCurrencyAfterAmount(){
  const table = document.querySelector("table");
  if (!table) return;

  const ths = Array.from(table.querySelectorAll("thead th"));
  if (!ths.length) return;

  const norm = (t) => (t || "").trim().toLowerCase();
  const iAmount = ths.findIndex(th => ["amount","importe"].includes(norm(th.textContent)));
  const iCurr   = ths.findIndex(th => ["currency","cur","moneda"].includes(norm(th.textContent)));

  // Si no encontramos o ya est√° justo despu√©s, no hacemos nada
  if (iAmount < 0 || iCurr < 0) return;
  if (iCurr === iAmount + 1) return;

  // Mover header
  const theadRow = table.querySelector("thead tr");
  const thAmount = ths[iAmount];
  const thCurr   = ths[iCurr];
  if (!theadRow || !thAmount || !thCurr) return;

  // Insertar currency despu√©s de amount
  theadRow.insertBefore(thCurr, thAmount.nextSibling);

  // Mover celdas en cada fila
  const rows = Array.from(table.querySelectorAll("tbody tr"));
  rows.forEach(tr => {
    const tds = Array.from(tr.children); // incluye td.rg-sel ya
    const tdAmount = tds[iAmount];
    const tdCurr   = tds[iCurr];
    if (!tdAmount || !tdCurr) return;
    tr.insertBefore(tdCurr, tdAmount.nextSibling);
  });
}

// Ejecutar al cargar y tras refrescos (tu tabla se regenera a veces)
document.addEventListener("DOMContentLoaded", () => {
  try { rgMoveCurrencyAfterAmount(); } catch(e){}
  setTimeout(() => { try { rgMoveCurrencyAfterAmount(); } catch(e){} }, 400);
  setTimeout(() => { try { rgMoveCurrencyAfterAmount(); } catch(e){} }, 1200);
});

// Si ya tienes MutationObserver por tabla, esto lo refuerza
(function(){
  const tbody = document.querySelector("tbody");
  if (!tbody) return;
  const obs = new MutationObserver(() => {
    try { rgMoveCurrencyAfterAmount(); } catch(e){}
  });
  obs.observe(tbody, {childList:true, subtree:true});
})();


/* --- RG patch: normalize Amount/Currency columns --- */
function rgNorm(t){ return (t||"").trim().toLowerCase(); }
function rgIsNumberText(t){
  const x = (t||"").trim().replace(/,/g,"");
  return /^-?\d+(\.\d+)?$/.test(x);
}
function rgExtractAmountFromCell(td){
  if (!td) return null;

  // Busca un elemento hijo cuyo texto sea un n√∫mero (p.ej. span rojo/verde)
  const kids = Array.from(td.querySelectorAll("*"));
  for (const el of kids){
    const txt = (el.textContent||"").trim();
    if (rgIsNumberText(txt)) return el; // devolvemos el elemento para moverlo
  }

  // Fallback: intenta extraer del textContent
  const txt = (td.textContent||"").trim();
  const m = txt.match(/-?\d+(?:\.\d+)?/);
  if (m) {
    const span = document.createElement("span");
    span.textContent = m[0];
    return span;
  }
  return null;
}

function rgFixAmountCurrency(){
  const table = document.querySelector("table");
  if (!table) return;

  const ths = Array.from(table.querySelectorAll("thead th"));
  if (!ths.length) return;

  const iAmount = ths.findIndex(th => ["amount","importe"].includes(rgNorm(th.textContent)));
  const iCurr   = ths.findIndex(th => ["currency","cur","moneda"].includes(rgNorm(th.textContent)));
  if (iAmount < 0 || iCurr < 0) return;

  // 1) Asegura que Currency est√° justo despu√©s de Amount (solo headers; celdas las tratamos por fila)
  const theadRow = table.querySelector("thead tr");
  if (theadRow){
    const thAmount = ths[iAmount];
    const thCurr = ths[iCurr];
    // recalcula por si ya movimos algo antes
    if (thAmount && thCurr) {
      // si no est√° justo despu√©s, mu√©vela
      const now = Array.from(theadRow.children);
      const a = now.indexOf(thAmount);
      const c = now.indexOf(thCurr);
      if (a >= 0 && c >= 0 && c !== a+1){
        theadRow.insertBefore(thCurr, thAmount.nextSibling);
      }
    }
  }

  // 2) Por cada fila: si Amount est√° vac√≠o y el importe est√° en la √∫ltima celda, moverlo a Amount.
  const rows = Array.from(table.querySelectorAll("tbody tr"));
  rows.forEach(tr => {
    const tds = Array.from(tr.children);
    if (!tds.length) return;

    // Recalcular √≠ndices reales en la fila (porque puede haber columna selector al principio)
    const headerCells = Array.from(table.querySelectorAll("thead tr > th"));
    const amountIdx = headerCells.findIndex(th => ["amount","importe"].includes(rgNorm(th.textContent)));
    const currIdx   = headerCells.findIndex(th => ["currency","cur","moneda"].includes(rgNorm(th.textContent)));
    if (amountIdx < 0 || currIdx < 0) return;

    const tdAmount = tds[amountIdx];
    const tdCurr   = tds[currIdx];
    const tdLast   = tds[tds.length-1];

    if (!tdAmount || !tdCurr || !tdLast) return;

    const amountTxt = (tdAmount.textContent||"").trim();
    // Si la columna Amount ya tiene n√∫mero, no tocamos
    if (rgIsNumberText(amountTxt)) return;

    // Detecta si en la √∫ltima celda hay el n√∫mero
    const amountEl = rgExtractAmountFromCell(tdLast);
    if (!amountEl) return;

    // Limpia Amount y mete ah√≠ el n√∫mero (manteniendo color si ven√≠a de un span)
    tdAmount.innerHTML = "";
    tdAmount.appendChild(amountEl);

    // Y en la √∫ltima celda eliminamos SOLO ese n√∫mero si ven√≠a de dentro
    // Si lo movimos desde dentro del DOM, ya no queda. Si lo creamos por fallback, no tocamos tdLast.
  });
}

// Ejecutar al cargar + tras refrescos
document.addEventListener("DOMContentLoaded", () => {
  rgFixAmountCurrency();
  setTimeout(rgFixAmountCurrency, 300);
  setTimeout(rgFixAmountCurrency, 900);
});

(function(){
  const tbody = document.querySelector("tbody");
  if (!tbody) return;
  const obs = new MutationObserver(() => rgFixAmountCurrency());
  obs.observe(tbody, {childList:true, subtree:true});
})();

</script>

<!-- RG_PATCH_V2_AMOUNT_CURRENCY_AND_DOT -->
<style>
/* 1) Matar la columna final (ah√≠ est√° el circulito y ahora mismo tambi√©n el amount) */
table thead th:last-child,
table tbody td:last-child {
  display: none !important;
}

/* 2) Asegura que Amount se vea bien */
table td.rg-amount-cell span {
  font-variant-numeric: tabular-nums;
}
</style>

<script>
/* 3) Mueve el n√∫mero que ahora est√° en la √∫ltima celda visible hacia la columna Amount */

function rg_norm(t){ return (t||"").trim().toLowerCase(); }
function rg_isNum(t){
  const x = (t||"").trim().replace(/,/g,"");
  return /^-?\d+(\.\d+)?$/.test(x);
}
function rg_findHeaderIndex(names){
  const ths = Array.from(document.querySelectorAll("table thead th"));
  for (let i=0;i<ths.length;i++){
    if (names.includes(rg_norm(ths[i].textContent))) return i;
  }
  return -1;
}
function rg_extractNumberNode(td){
  if (!td) return null;
  // busca alg√∫n elemento cuyo texto sea n√∫mero (span rojo/verde)
  const nodes = Array.from(td.querySelectorAll("*"));
  for (const el of nodes){
    const txt = (el.textContent||"").trim();
    if (rg_isNum(txt)) return el;
  }
  // fallback con text
  const txt = (td.textContent||"").trim();
  const m = txt.match(/-?\d+(?:\.\d+)?/);
  if (!m) return null;
  const sp = document.createElement("span");
  sp.textContent = m[0];
  return sp;
}

function rg_fixAmountFromLastColumn(){
  const table = document.querySelector("table");
  if (!table) return;

  // Importante: calculamos √≠ndices sobre el DOM actual (incluye la columna select)
  const idxAmount = rg_findHeaderIndex(["amount","importe"]);
  const idxCurrency = rg_findHeaderIndex(["currency","cur","moneda"]);
  if (idxAmount < 0 || idxCurrency < 0) return;

  const rows = Array.from(table.querySelectorAll("tbody tr"));
  rows.forEach(tr => {
    const tds = Array.from(tr.children);
    if (tds.length < 3) return;

    const tdAmount = tds[idxAmount];
    if (!tdAmount) return;

    // si ya hay un n√∫mero en Amount, no tocamos
    const amountTxt = (tdAmount.textContent||"").trim();
    if (rg_isNum(amountTxt)) {
      tdAmount.classList.add("rg-amount-cell");
      return;
    }

    // El n√∫mero est√° en la √∫ltima columna (la del circulito). Aunque la ocultemos por CSS,
    // sigue existiendo en el DOM, as√≠ que lo cogemos de ah√≠:
    const tdLast = tds[tds.length - 1];
    const numNode = rg_extractNumberNode(tdLast);
    if (!numNode) return;

    tdAmount.innerHTML = "";
    tdAmount.appendChild(numNode);
    tdAmount.classList.add("rg-amount-cell");
  });
}

function rg_runV2(){
  try { rg_fixAmountFromLastColumn(); } catch(e){}
}

document.addEventListener("DOMContentLoaded", () => {
  rg_runV2();
  setTimeout(rg_runV2, 300);
  setTimeout(rg_runV2, 900);
});

// si tu tabla se refresca, lo re-ejecutamos
(function(){
  const tbody = document.querySelector("tbody");
  if (!tbody) return;
  const obs = new MutationObserver(() => rg_runV2());
  obs.observe(tbody, {childList:true, subtree:true});
})();
</script>


<!-- RG_PATCH_V4_SAFE_AMOUNT_CURRENCY_FIX -->
<style>
/* Alineaci√≥n visual (sin tocar estructura) */
table thead th.rg-th-amount, table tbody td.rg-td-amount { text-align: right !important; }
table thead th.rg-th-currency, table tbody td.rg-td-currency { text-align: center !important; }

/* Ocultar SOLO el contenido duplicado en la celda origen (sin eliminar TDs) */
.rg-ghost { opacity: 0 !important; pointer-events: none !important; }

/* Extra: que Amount use n√∫meros tabulares */
table tbody td.rg-td-amount { font-variant-numeric: tabular-nums; }
</style>

<script>
(function(){
  function norm(t){ return (t||"").trim().toLowerCase(); }
  function isNumText(t){
    const x = (t||"").trim().replace(/,/g,"");
    return /^-?\d+(\.\d+)?$/.test(x);
  }
  function hasCurrencyText(t){
    const u = (t||"").toUpperCase();
    return u.includes("KWD") || u.includes("USD") || u.includes("EUR");
  }

  function findHeaderIndex(names){
    const ths = Array.from(document.querySelectorAll("table thead th"));
    for (let i=0;i<ths.length;i++){
      const t = norm(ths[i].textContent);
      if (names.includes(t)) return i;
    }
    return -1;
  }

  function findNumberElement(td){
    if (!td) return null;
    // Preferimos un elemento hijo (span) que sea un n√∫mero limpio
    const els = Array.from(td.querySelectorAll("*"));
    for (const el of els){
      const txt = (el.textContent||"").trim();
      if (isNumText(txt)) return el;
    }
    // fallback: texto plano
    const txt = (td.textContent||"").trim();
    if (isNumText(txt)){
      const sp = document.createElement("span");
      sp.textContent = txt;
      return sp;
    }
    return null;
  }

  function findCurrencyContainer(td){
    if (!td) return null;
    const txt = (td.textContent||"").trim();
    if (hasCurrencyText(txt)) return td;
    return null;
  }

  function fixOnce(){
    const table = document.querySelector("table");
    if (!table) return;

    const idxAmount = findHeaderIndex(["amount","importe"]);
    const idxCurr   = findHeaderIndex(["currency","cur","moneda"]);
    if (idxAmount < 0 || idxCurr < 0) return;

    // Marca headers para alineaci√≥n
    const ths = Array.from(table.querySelectorAll("thead th"));
    if (ths[idxAmount]) ths[idxAmount].classList.add("rg-th-amount");
    if (ths[idxCurr])   ths[idxCurr].classList.add("rg-th-currency");

    const rows = Array.from(table.querySelectorAll("tbody tr"));
    if (!rows.length) return;

    for (const tr of rows){
      const tds = Array.from(tr.children);
      if (tds.length <= Math.max(idxAmount, idxCurr)) continue;

      const tdAmount = tds[idxAmount];
      const tdCurr   = tds[idxCurr];

      if (tdAmount) tdAmount.classList.add("rg-td-amount");
      if (tdCurr)   tdCurr.classList.add("rg-td-currency");

      // Si Amount ya tiene n√∫mero, no tocamos
      const amtNow = (tdAmount?.textContent||"").trim();
      const amountOk = isNumText(amtNow) || Array.from(tdAmount?.querySelectorAll("*")||[]).some(el=>isNumText((el.textContent||"").trim()));

      // Si Currency ya contiene KWD/EUR/USD, no tocamos
      const currNow = (tdCurr?.textContent||"").trim();
      const currencyOk = hasCurrencyText(currNow);

      // Busca en otras celdas el n√∫mero y la currency (sin tocar estructura)
      let srcAmountEl = null, srcAmountTd = null;
      let srcCurrTd = null;

      if (!amountOk){
        // buscamos el n√∫mero en las celdas (prioridad: √∫ltimas 3 celdas)
        const scan = tds.slice(-4).concat(tds); // por si acaso
        for (const td of scan){
          if (td === tdAmount || td === tdCurr) continue;
          const el = findNumberElement(td);
          if (el){
            srcAmountEl = el;
            srcAmountTd = td;
            break;
          }
        }
        if (srcAmountEl && tdAmount){
          // copiamos el HTML de la celda origen (mantiene color rojo/verde)
          tdAmount.innerHTML = srcAmountTd.innerHTML;
          // y ocultamos SOLO el elemento num√©rico en la celda origen para evitar duplicado
          // (si el n√∫mero va en un span/child)
          if (srcAmountEl.classList) srcAmountEl.classList.add("rg-ghost");
        }
      }

      if (!currencyOk){
        const scan = tds.slice(-5).concat(tds);
        for (const td of scan){
          if (td === tdAmount || td === tdCurr) continue;
          if (hasCurrencyText((td.textContent||"").trim())){
            srcCurrTd = td;
            break;
          }
        }
        if (srcCurrTd && tdCurr){
          tdCurr.innerHTML = srcCurrTd.innerHTML;
          // ocultamos el texto en origen (no toda la celda)
          const kids = Array.from(srcCurrTd.childNodes);
          kids.forEach(n=>{
            if (n && n.nodeType === 3){ // text node
              // no tocamos
            }
          });
          // Si hay spans, los ocultamos
          Array.from(srcCurrTd.querySelectorAll("*")).forEach(el=>el.classList?.add("rg-ghost"));
        }
      }
    }
  }

  function run(){
    try { fixOnce(); } catch(e){}
  }

  document.addEventListener("DOMContentLoaded", () => {
    run();
    setTimeout(run, 250);
    setTimeout(run, 800);
  });

  const tbody = document.querySelector("tbody");
  if (tbody){
    const obs = new MutationObserver(() => run());
    obs.observe(tbody, {childList:true, subtree:true});
  }
})();
</script>

</body>
</html>
