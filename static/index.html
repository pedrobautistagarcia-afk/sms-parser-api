<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Registro Gastos</title>
  <style>
    :root{
      --bg:#000000;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
      --border2:#243041;

      --panelBg:rgba(255,255,255,.03);
      --tableBg:rgba(255,255,255,.02);

      --green:#22c55e;
      --red:#ef4444;
      --amber:#fbbf24;
    }

    html[data-theme="light"]{
      --bg:#ffffff;
      --text:#0b1220;
      --muted:#4b5563;
      --border:#e5e7eb;
      --border2:#d1d5db;

      --panelBg:#ffffff;
      --tableBg:#ffffff;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    .wrap{max-width:1100px; margin:28px auto; padding:0 18px;}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    h1{margin:0; font-size:22px; letter-spacing:.2px;}
    .sub{margin-top:6px; color:var(--muted); font-size:12px; font-weight:800}

    .panel{
      background:var(--panelBg);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.30);
    }
    html[data-theme="light"] .panel{ box-shadow: 0 10px 30px rgba(0,0,0,.10); }

    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .btn{
      cursor:pointer;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      transition:background .15s ease, border-color .15s ease, transform .02s ease;
      user-select:none;
      height:32px;
      display:inline-flex; align-items:center;
    }
    .btn:hover{background:rgba(255,255,255,.06); border-color:var(--border2)}
    .btn:active{transform:translateY(1px)}
    html[data-theme="light"] .btn{background:#fff; color:#0b1220;}
    html[data-theme="light"] .btn:hover{background:#f9fafb}

    .pill{
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:12px;
      outline:none;
      font-weight:900;
      height:32px;
    }
    .pill:focus{border-color:#304156}
    html[data-theme="light"] .pill{
      background:#fff;
      color:#0b1220;
    }
    select.pill option{background:#0b0f14; color:var(--text)}
    html[data-theme="light"] select.pill option{background:#fff; color:#0b1220}

    .spacer{flex:1}

    #err{
      margin-top:10px;
      display:none;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.35);
      color:#fecaca;
      font-weight:900;
      font-size:12px;
      white-space:pre-wrap;
    }
    html[data-theme="light"] #err{
      background:rgba(239,68,68,.08);
      color:#7f1d1d;
      border-color:rgba(239,68,68,.25);
    }

    .tableWrap{
      margin-top:12px;
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--tableBg);
    }

    table{width:100%; border-collapse:collapse; min-width:920px;}
    thead th{
      position:sticky; top:0;
      background:rgba(0,0,0,.35);
      border-bottom:1px solid var(--border);
      text-align:left;
      padding:10px 10px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }
    html[data-theme="light"] thead th{
      background:#f3f4f6;
      color:#111827;
    }
    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:10px 10px;
      font-size:13px;
      white-space:nowrap;
      vertical-align:middle;
    }
    html[data-theme="light"] tbody td{
      border-bottom:1px solid rgba(229,231,235,.9);
    }
    tbody tr:hover td{background:rgba(255,255,255,.03)}
    html[data-theme="light"] tbody tr:hover td{background:#f9fafb}

    .muted{color:var(--muted); font-weight:800; font-size:12px}
    .amt{font-weight:900; text-align:right}
    .amt.neg{color:var(--red)}
    .amt.pos{color:var(--green)}

    .th-sort .sort-ind{opacity:.7; margin-left:6px; font-size:11px}
    .actions{width:62px; text-align:right}
    .actions .delBtn{opacity:0; transition:opacity .15s ease}
    tbody tr:hover .actions .delBtn{opacity:1}

    /* inline edit for merchant */
    .inlineInput{
      width: 260px;
      max-width: 260px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      outline:none;
      height:32px;
    }
    html[data-theme="light"] .inlineInput{
      background:#fff;
      color:#0b1220;
      border-color:var(--border);
    }

    /* category selector (same style) */
    .catSel{
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:12px;
      outline:none;
      font-weight:900;
      height:32px;
      min-width:150px;
    }
    html[data-theme="light"] .catSel{
      background:#fff;
      color:#0b1220;
      border-color:var(--border);
    }
    .catSel option{background:#0b0f14; color:var(--text)}
    html[data-theme="light"] .catSel option{background:#fff; color:#0b1220}

    /* currency flags (emoji - simple and works everywhere) */
    .cur{font-weight:900}
    .cur .flag{margin-right:6px}

    /* toast undo */
    #toast{
      position:fixed; left:18px; bottom:18px;
      display:none; gap:10px; align-items:center; z-index:9999;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--text);
      font-size:12px;
      backdrop-filter: blur(10px);
    }
    html[data-theme="light"] #toast{ background:rgba(0,0,0,.05); color:#0b1220; }
    #toastMsg{font-weight:900}
  
    /* Balance dropdown */
    .balWrap{ position:relative; display:inline-flex; }
    .balBtn{ gap:8px; }
    .balMenu{
      position:absolute; right:0; top:40px;
      min-width:240px;
      background:var(--panelBg);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      display:none;
      z-index:9999;
      backdrop-filter: blur(10px);
    }
    html[data-theme="light"] .balMenu{
      box-shadow: 0 18px 45px rgba(0,0,0,.12);
    }
    .balMenu .line{
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 8px;
      border-radius:12px;
      font-weight:900;
      font-size:12px;
    }
    .balMenu .line:hover{ background:rgba(255,255,255,.03); }
    html[data-theme="light"] .balMenu .line:hover{ background:#f9fafb; }

    .balMenu .left{ display:flex; align-items:center; gap:8px; }
    .balMenu .flag{ width:20px; text-align:center; }
    .balMenu .pos{ color:var(--green); }
    .balMenu .neg{ color:var(--red); }
    .balMenu .muted{ color:var(--muted); font-weight:800; }

    /* Quick range buttons */
    .quickBtn{ padding:7px 10px; }
    

    .flag{display:inline-flex; align-items:center; justify-content:center; width:18px; margin-right:6px}
    .flag svg{width:16px; height:12px; border-radius:3px; display:block}
</style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Registro Gastos</h1>

<div id="jsErrorBox" style="display:none; margin:10px 0; padding:10px; border-radius:10px; font-size:13px; background:rgba(255,0,0,.12); color:#ffb4b4; border:1px solid rgba(255,0,0,.25);">
</div>

        <div class="sub">Filtros arriba + tabla estable (si falla, muestra el HTTP). Dark/Light estable.</div>
      </div>

      <div class="balWrap">
          <button class="btn balBtn" id="balanceBtn" title="Balance"><span id="balanceLabel">Balance</span> <span style="opacity:.7">‚ñæ</span></button>
          <div class="balMenu" id="balanceMenu">
            <div class="line"><div class="left"><span class="flag" data-flag="KWD"></span><span style="font-weight:900">KWD</span></div><div id="balKWD" class="muted">0</div></div>
            <div class="line"><div class="left"><span class="flag" data-flag="USD"></span><span style="font-weight:900">USD</span></div><div id="balUSD" class="muted">0</div></div>
            <div class="line"><div class="left"><span class="flag" data-flag="EUR"></span><span style="font-weight:900">EUR</span></div><div id="balEUR" class="muted">0</div></div>
          </div>
        </div>
        <button class="btn" id="themeToggle" title="Toggle theme"><span id="themeText">Dark</span></button>
    </div>

    <div class="panel">
      <div class="row">
        <input id="q" class="pill" placeholder="Search merchant..." style="min-width:220px"/>
        <select id="cur" class="pill" style="min-width:170px">
          <option value="">All currencies</option>
        </select>
        <select id="cat" class="pill" style="min-width:170px">
          <option value="">All categories</option>
        </select>

        <input id="startDate" class="pill" type="date" title="Start date"/>
        <input id="endDate" class="pill" type="date" title="End date"/>

        <button class="btn quickBtn" id="btnToday">Today</button>
        <button class="btn quickBtn" id="btnWeek">Last week</button>
        <button class="btn quickBtn" id="btnMonth">Last month</button>
        <button class="btn quickBtn" id="btnYear">This year</button>
        <button class="btn" id="clear">Clear</button>
        <div class="spacer"></div>
        <span id="status" class="muted">Ready</span>
      </div>

      <div id="err"></div>

      <div class="tableWrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th class="th-sort" data-sort="created_at">Date <span class="sort-ind" data-ind="created_at"></span></th>
              <th class="th-sort" data-sort="currency">Currency <span class="sort-ind" data-ind="currency"></span></th>
              <th>Merchant</th>
              <th>Category</th>
              <th class="th-sort" data-sort="amount" style="text-align:right">Amount <span class="sort-ind" data-ind="amount"></span></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- rows -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast">
    <span id="toastMsg">Deleted (undo 10s)</span>
    <button id="undoBtn" class="btn">Undo</button>
  </div>

<script>
  
  // ===========================
  // SAFETY LAYER (no rompe UI)
  // ===========================
  function showJsError(e){
    try{
      const box = document.getElementById("jsErrorBox");
      if(box){
        box.style.display = "block";
        box.textContent = "JS error: " + (e?.message || e);
      } else {
        // fallback: console only
        console.error("JS error:", e);
      }
    }catch(_){}
  }

  // Render robusto: intenta varias funciones/targets sin petar
  function renderAny(rows){
    rows = rows || [];
    // intenta funciones t√≠picas si existen
    try { if (typeof renderTable === "function") return renderTable(rows); } catch(e){ showJsError(e); }
    try { if (typeof renderRows  === "function") return renderRows(rows);  } catch(e){ showJsError(e); }
    try { if (typeof render      === "function") return render(rows);      } catch(e){ showJsError(e); }
    try { if (typeof drawTable   === "function") return drawTable(rows);   } catch(e){ showJsError(e); }

    // fallback directo: pintar tbody si existe
    try{
      const tbody = document.querySelector("table tbody");
      if(!tbody) return;
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.created_at || ""}</td>
          <td>${r.merchant_clean || r.merchant_raw || ""}</td>
          <td>${r.category || ""}</td>
          <td>${r.currency || ""}</td>
          <td style="text-align:right">${(r.amount ?? "")}</td>
        </tr>
      `).join("");
    }catch(e){ showJsError(e); }
  }

  // Si applyFilters peta, no te quedas sin filas
  function safeApplyFilters(){
    try{
      if(typeof applyFilters === "function"){
        safeApplyFilters();
        return;
      }
      // si no hay applyFilters, renderiza todo
      if(typeof state !== "undefined"){
        const all = state.view || state.expenses || state.all || [];
        renderAny(all);
      }
    }catch(e){
      showJsError(e);
      try{
        if(typeof state !== "undefined"){
          const all = state.expenses || state.all || state.view || [];
          renderAny(all);
        }
      }catch(_){}
    }
  }

  // Captura errores globales para que no ‚Äúdesaparezcan‚Äù
  window.addEventListener("error", (ev)=>{ showJsError(ev.error || ev.message); });
  window.addEventListener("unhandledrejection", (ev)=>{ showJsError(ev.reason || ev); });
// ===== CONFIG =====
  const API_KEY = "ElPortichuelo99";
  const DEFAULT_USER = "pedro";

  const $ = (id)=>document.getElementById(id);

  const state = {
    user_id: DEFAULT_USER,
    raw: [],
    view: [],
    sortKey: "created_at",
    sortDir: "desc",
    lastDeleted: false
  };

  
  function withKey(url){
    const k = "ElPortichuelo99";
    const u = new URL(url, window.location.origin);
    if (!u.searchParams.get("api_key")) u.searchParams.set("api_key", k);
    return u.pathname + u.search;
  }catch(e){
      return url + (url.includes("?") ? "&" : "?") + "api_key=" + encodeURIComponent(API_KEY);
    }
  }

  function setStatus(t){ if($("status")) $("status").textContent = t; }
  function showError(t){
    const e = $("err");
    if(!e) return;
    e.style.display = "block";
    e.textContent = String(t || "");
  }
  function clearError(){
    const e = $("err");
    if(!e) return;
    e.style.display = "none";
    e.textContent = "";
  }


  async function postJSONTry(paths, bodies){
    // paths: ["/update_field", "/update", ...]
    // bodies: [payload1, payload2, ...]
    const errs = [];
    for(const path of paths){
      for(const body of bodies){
        try{
          const r = await fetch(withKey(path), {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(body || {})
          });
          if(!r.ok){
            const t = await r.text().catch(()=> "");
            errs.push(`${path} => HTTP ${r.status} ${r.statusText} :: ${t.slice(0,120)}`);
            continue;
          }
          // attempt json, else ok
          try{ return await r.json(); } catch(e){ return {ok:true}; }
        }catch(e){
          errs.append(`${path} => ${e}`);
        }
      }
    }
    throw new Error(errs.join("\n"));
  }

  async function postJSON(url, body){
    const r = await fetch(withKey(url), {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body || {})
    });
    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(`HTTP ${r.status} ${r.statusText} :: ${t.slice(0,200)}`);
    }
    return await r.json();
  }

  function flagFor(cur){
    const c = (cur||"").toUpperCase();
    if(c==="KWD") return "üá∞üáº";
    if(c==="USD") return "üá∫üá∏";
    if(c==="EUR") return "üá™üá∫";
    return "üè≥Ô∏è";
  }


  function flagHTML(cur){
    const c = String(cur||"").toUpperCase();
    // simple inline SVGs (lightweight, always render)
    const KUWAIT = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#fff"/>
      <rect width="16" height="4" y="0" fill="#0B7A3B"/>
      <rect width="16" height="4" y="8" fill="#C8102E"/>
      <path d="M0 0h5L8 6 5 12H0z" fill="#000"/>
    </svg>`;
    const USA = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#fff"/>
      <g fill="#B22234">
        <rect y="0" width="16" height="1"/>
        <rect y="2" width="16" height="1"/>
        <rect y="4" width="16" height="1"/>
        <rect y="6" width="16" height="1"/>
        <rect y="8" width="16" height="1"/>
        <rect y="10" width="16" height="1"/>
      </g>
      <rect width="7" height="5" fill="#3C3B6E"/>
      <g fill="#fff" opacity=".9">
        <circle cx="1.2" cy="1" r=".25"/><circle cx="2.4" cy="1" r=".25"/><circle cx="3.6" cy="1" r=".25"/><circle cx="4.8" cy="1" r=".25"/><circle cx="6.0" cy="1" r=".25"/>
        <circle cx="1.8" cy="2" r=".25"/><circle cx="3.0" cy="2" r=".25"/><circle cx="4.2" cy="2" r=".25"/><circle cx="5.4" cy="2" r=".25"/>
        <circle cx="1.2" cy="3" r=".25"/><circle cx="2.4" cy="3" r=".25"/><circle cx="3.6" cy="3" r=".25"/><circle cx="4.8" cy="3" r=".25"/><circle cx="6.0" cy="3" r=".25"/>
        <circle cx="1.8" cy="4" r=".25"/><circle cx="3.0" cy="4" r=".25"/><circle cx="4.2" cy="4" r=".25"/><circle cx="5.4" cy="4" r=".25"/>
      </g>
    </svg>`;
    const EU = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#003399"/>
      <g fill="#FFCC00">
        <circle cx="8" cy="2.1" r=".35"/>
        <circle cx="10.2" cy="2.7" r=".35"/>
        <circle cx="11.8" cy="4.3" r=".35"/>
        <circle cx="12.4" cy="6.0" r=".35"/>
        <circle cx="11.8" cy="7.7" r=".35"/>
        <circle cx="10.2" cy="9.3" r=".35"/>
        <circle cx="8" cy="9.9" r=".35"/>
        <circle cx="5.8" cy="9.3" r=".35"/>
        <circle cx="4.2" cy="7.7" r=".35"/>
        <circle cx="3.6" cy="6.0" r=".35"/>
        <circle cx="4.2" cy="4.3" r=".35"/>
        <circle cx="5.8" cy="2.7" r=".35"/>
      </g>
    </svg>`;

    if(c==="KWD") return KUWAIT;
    if(c==="USD") return USA;
    if(c==="EUR") return EU;
    return "";
  }

  function fmtAmount(a){
    if(a === null || a === undefined || a === "") return "";
    const n = Number(a);
    if(Number.isNaN(n)) return String(a);
    return n.toFixed(3).replace(/\.000$/, ".000").replace(/\.([0-9]*?)0+$/, ".$1").replace(/\.$/,"");
  }

  function normalizeCat(c){
    const x = String(c||"other").trim().toLowerCase();
    return x ? (x[0].toUpperCase() + x.slice(1)) : "Other";
  }

  function setSort(key){
    if(state.sortKey === key){
      state.sortDir = (state.sortDir === "asc") ? "desc" : "asc";
    }else{
      state.sortKey = key;
      state.sortDir = (key === "amount") ? "desc" : "desc";
    }
    safeApplyFilters();
    updateSortIndicators();
  }

  function updateSortIndicators(){
    document.querySelectorAll(".sort-ind").forEach(el=>el.textContent="");
    const ind = document.querySelector(`.sort-ind[data-ind="${state.sortKey}"]`);
    if(ind) ind.textContent = (state.sortDir === "asc") ? "‚ñ≤" : "‚ñº";
  }

  function applyFilters(){
    const q = ($("q")?.value || "").trim().toLowerCase();
    const cur = ($("cur")?.value || "").trim().toLowerCase();
    const cat = ($("cat")?.value || "").trim().toLowerCase();
    const sd  = ($("startDate")?.value || "");
    const ed  = ($("endDate")?.value || "");

    let v = state.raw.filter(e=>{
      const m = String(e.merchant_clean || "").toLowerCase();
      const c = String(e.currency || "").toLowerCase();
      const k = String(e.category || "other").toLowerCase();
      const created = String(e.created_at || "");
      const cdate = created ? created.slice(0,10) : "";

      if(q && !m.includes(q)) return false;
      if(cur && c !== cur) return false;
      if(cat && k !== cat) return false;
      if(sd && cdate && cdate < sd) return false;
      if(ed && cdate && cdate > ed) return false;

      return true;
    });

    // sort
    const dir = (state.sortDir === "asc") ? 1 : -1;
    const key = state.sortKey;

    v.sort((a,b)=>{
      const av = a[key], bv = b[key];
      if(key === "amount"){
        const an = Number(av||0), bn = Number(bv||0);
        return (an - bn) * dir;
      }
      const as = String(av||""), bs = String(bv||"");
      return as.localeCompare(bs) * dir;
    });

    state.view = v;
    render();
    updateBalance();
  }

  function render(){
    const tb = $("tbody");
    if(!tb) return;

    tb.innerHTML = state.view.map(e=>{
      const amt = Number(e.amount||0);
      const dir = String(e.direction||"").toLowerCase(); // may be "in"/"out"
      const isOut = (dir === "out") || (String(e.sms||"").toLowerCase().includes("debited"));
      const isIn  = (dir === "in")  || (String(e.sms||"").toLowerCase().includes("credited"));
      const cls = isIn ? "pos" : (isOut ? "neg" : (amt < 0 ? "neg" : ""));
      const amtTxt = fmtAmount(Math.abs(amt));

      const cur = String(e.currency||"");
      const flag = flagHTML(cur);
// category options built later (stateCats)
      const cat = String(e.category||"other").toLowerCase();

      return `
        <tr>
          <td>${String(e.created_at||"").slice(0,19).replace("T"," ")}</td>
          <td class="cur"><span class="flag">${flag}</span>${cur}</td>
          <td><input class="inlineInput" data-id="${e.id}" data-field="merchant_clean" value="${escapeHtml(e.merchant_clean||"")}" /></td>
          <td>
            <select class="catSel" data-id="${e.id}" data-field="category">
              ${stateCats.map(x=>{
                const val = x.toLowerCase();
                const sel = (val === cat) ? "selected" : "";
                return `<option value="${val}" ${sel}>${x}</option>`;
              }).join("")}
            </select>
          </td>
          <td class="amt ${cls}">${isIn ? "" : "-"}${amtTxt}</td>
          <td class="actions" data-id="${e.id}"><button class="btn delBtn" title="Delete">üóëÔ∏è</button></td>
        </tr>
      `;
    }).join("");
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // Categories list (dynamic)
  let stateCats = ["Other","Coffee","Food","Transport","Shopping","Rent"];

  function rebuildSelectOptions(){
    // currencies
    const curSel = $("cur");
    const catSel = $("cat");
    if(curSel){
      const curSet = new Set(state.raw.map(e=>String(e.currency||"").toUpperCase()).filter(Boolean));
      const curVals = Array.from(curSet).sort();
      curSel.innerHTML = `<option value="">All currencies</option>` + curVals.map(c=>`<option value="${c.toLowerCase()}">${c}</option>`).join("");
    }
    if(catSel){
      const catSet = new Set(state.raw.map(e=>String(e.category||"other").toLowerCase()));
      const catVals = Array.from(catSet).sort();
      // keep pretty label
      catSel.innerHTML = `<option value="">All categories</option>` + catVals.map(c=>{
        const label = (c && c[0]) ? (c[0].toUpperCase()+c.slice(1)) : "Other";
        return `<option value="${c}">${label}</option>`;
      }).join("");
    }

    // per-row category selector options (pretty)
    const catSet2 = new Set(state.raw.map(e=>normalizeCat(e.category||"other")));
    stateCats = Array.from(catSet2).sort((a,b)=>a.localeCompare(b));
    if(!stateCats.length) stateCats = ["Other"];
  }

  async function load(){
    clearError();
    setStatus("Loading...");

    let r;
    try{
      r = await fetch(withKey(`/expenses?user_id=${encodeURIComponent(state.user_id)}&limit=500`));
    }catch(e){
      showError("Load failed: network error");
      setStatus("Error");
      return;
    }

    if(!r.ok){
      const t = await r.text().catch(()=> "");
      showError(`Load failed: HTTP ${r.status} ${r.statusText}\n${t.slice(0,400)}`);
      setStatus("Error");
      return;
    }

    let j;
    try{
      j = await r.json();
    }catch(e){
      const t = await r.text().catch(()=> "");
      showError(`Load failed: invalid JSON\n${t.slice(0,400)}`);
      setStatus("Error");
      return;
    }

    const arr = (j && j.expenses) ? j.expenses : [];
    state.raw = Array.isArray(arr) ? arr : [];
    rebuildSelectOptions();
    safeApplyFilters();
    updateBalance();

    setStatus(`Loaded: ${state.raw.length}`);
    if(state.raw.length === 0){
      showError("0 rows from API. (No es la tabla; la API est√° devolviendo vac√≠o.)");
    }
  }

  // ===== Theme =====
  function initTheme(){
    const saved = localStorage.getItem("rg_theme");
    const theme = (saved === "light" || saved === "dark") ? saved : "dark";
    document.documentElement.setAttribute("data-theme", theme);
    if($("themeText")) $("themeText").textContent = (theme === "dark") ? "Dark" : "Light";
  }

  if($("themeToggle")){
    $("themeToggle").addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      const next = (cur === "dark") ? "light" : "dark";
      localStorage.setItem("rg_theme", next);
      document.documentElement.setAttribute("data-theme", next);
      if($("themeText")) $("themeText").textContent = (next === "dark") ? "Dark" : "Light";
    });
  }

  // ===== Events =====
  if($("q")) $("q").addEventListener("input", applyFilters);
  if($("cur")) $("cur").addEventListener("change", applyFilters);
  if($("cat")) $("cat").addEventListener("change", applyFilters);
  if($("startDate")) $("startDate").addEventListener("change", applyFilters);
  if($("endDate")) $("endDate").addEventListener("change", applyFilters);

  if($("clear")){
    $("clear").addEventListener("click", ()=>{
      if($("q")) $("q").value="";
      if($("cur")) $("cur").value="";
      if($("cat")) $("cat").value="";
      if($("startDate")) $("startDate").value="";
      if($("endDate")) $("endDate").value="";
      safeApplyFilters();
      clearError();
    });
  }

  // Sorting
  document.querySelectorAll(".th-sort").forEach(th=>{
    th.addEventListener("click", ()=> setSort(th.dataset.sort));
  });

  // Inline merchant save on blur
  document.addEventListener("blur", async (ev)=>{
    const inp = ev.target;
    if(!(inp && inp.classList && inp.classList.contains("inlineInput"))) return;
    const id = Number(inp.dataset.id||0);
    const val = inp.value || "";
    if(!id) return;

    try{
      // Backend must have /update_field or similar; if not, we just don't crash.
      // If your backend endpoint is different, tell me and lo ajusto.
      await postJSONTry(
        ["/update_field","/update","/edit","/set_field"],
        [
          {id, user_id: state.user_id, field:"merchant_clean", value: val},
          {id, user_id: state.user_id, merchant_clean: val},
          {id, user_id: state.user_id, field:"merchant_clean", merchant_clean: val, value: val}
        ]
      );
      await load();
}catch(e){
      // Don‚Äôt kill UI
      showError("Save merchant failed: " + (e.message||e));
    }
  }, true);

  // Category change save
  document.addEventListener("change", async (ev)=>{
    const sel = ev.target;
    if(!(sel && sel.classList && sel.classList.contains("catSel"))) return;
    const id = Number(sel.dataset.id||0);
    const val = sel.value || "other";
    if(!id) return;
    try{
      await postJSONTry(
        ["/update_field","/update","/set_category","/edit","/set_field"],
        [
          {id, user_id: state.user_id, field:"category", value: val},
          {id, user_id: state.user_id, category: val},
          {id, user_id: state.user_id, field:"category", category: val, value: val}
        ]
      );
      await load();
}catch(e){
      showError("Save category failed: " + (e.message||e));
    }
  });

  // Delete + Undo (requires backend /delete and /undo_delete; if not present, we show error)
  let undoTimer = null;
  function showToast(msg){
    if(!$("toast")) return;
    if($("toastMsg")) $("toastMsg").textContent = msg || "Deleted (undo 10s)";
    $("toast").style.display = "inline-flex";
    clearTimeout(undoTimer);
    undoTimer = setTimeout(()=>{ if($("toast")) $("toast").style.display="none"; }, 10000);
  }

  document.addEventListener("click", async (ev)=>{
    const btn = ev.target.closest(".delBtn");
    if(!btn) return;
    const td = ev.target.closest("td.actions");
    const id = Number(td?.dataset?.id||0);
    if(!id) return;
    try{
      await postJSONTry(
        ["/delete","/delete_expense","/remove","/del"],
        [
          {id, user_id: state.user_id},
          {id},
        ]
      );
showToast("Deleted (undo 10s)");
      await load();
    }catch(e){
      showError("Delete failed: " + (e.message||e));
    }
  });

  if($("undoBtn")){
    $("undoBtn").addEventListener("click", async ()=>{
      try{
        await postJSONTry(
        ["/undo_delete","/restore_last","/undo","/undelete"],
        [
          {user_id: state.user_id},
          {}
        ]
      );
if($("toast")) $("toast").style.display="none";
        await load();
      }catch(e){
        showError("Undo failed: " + (e.message||e));
      }
    });
  }


  function ymd(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function setRange(start, end){
    if($("startDate")) $("startDate").value = start || "";
    if($("endDate")) $("endDate").value = end || "";
    safeApplyFilters();
  }

  // Signed amount: expenses negative, income positive
  function signedAmount(e){
    const amt = Number(e.amount||0);
    const dir = String(e.direction||"").toLowerCase();
    const sms = String(e.sms||"").toLowerCase();
    if(dir === "in") return Math.abs(amt);
    if(dir === "out") return -Math.abs(amt);
    if(sms.includes("credited")) return Math.abs(amt);
    if(sms.includes("debited")) return -Math.abs(amt);
    // fallback: assume expense if amount positive (most of your msgs are debited)
    return -Math.abs(amt);
  }

  function fmtBal(n){
    const x = Number(n||0);
    const abs = Math.abs(x);
    // 3 decimals pero sin ceros molestos
    let t = abs.toFixed(3);
    t = t.replace(/\.([0-9]*?)0+$/, ".$1").replace(/\.$/,"");
    return (x < 0 ? "-" : "") + t;
  }

  function paintBal(el, val){
    if(!el) return;
    el.textContent = fmtBal(val);
    el.classList.remove("pos","neg","muted");
    if(val > 0) el.classList.add("pos");
    else if(val < 0) el.classList.add("neg");
    else el.classList.add("muted");
  }

  
  function initBalanceFlags(){
    document.querySelectorAll('.flag[data-flag]').forEach(el=>{
      const c = el.getAttribute('data-flag');
      el.innerHTML = flagHTML(c);
    });
  }

  function updateBalance(){
    const sums = {KWD:0, USD:0, EUR:0};
    for(const e of (state.view || [])){
      const cur = String(e.currency||"").toUpperCase();
      if(!sums.hasOwnProperty(cur)) continue;
      sums[cur] += signedAmount(e);
    }
    paintBal($("balKWD"), sums.KWD);
    paintBal($("balUSD"), sums.USD);
    paintBal($("balEUR"), sums.EUR);
  }

  // Balance dropdown toggles
  const balBtn = $("balanceBtn");
  const balMenu = $("balanceMenu");
  if(balBtn && balMenu){
    balBtn.addEventListener("click", (ev)=>{
      ev.stopPropagation();
      balMenu.style.display = (balMenu.style.display === "block") ? "none" : "block";
    });
    document.addEventListener("click", ()=>{ balMenu.style.display = "none"; });
  }

  // Quick range buttons
  if($("btnToday")){
    $("btnToday").addEventListener("click", ()=>{
      const d = new Date();
      const t = ymd(d);
      setRange(t, t);
    });
  }
  if($("btnWeek")){
    $("btnWeek").addEventListener("click", ()=>{
      const end = new Date();
      const start = new Date();
      start.setDate(start.getDate() - 7);
      setRange(ymd(start), ymd(end));
    });
  }
  if($("btnMonth")){
    $("btnMonth").addEventListener("click", ()=>{
      const end = new Date();
      const start = new Date();
      start.setMonth(start.getMonth() - 1);
      setRange(ymd(start), ymd(end));
    });
  }
  if($("btnYear")){
    $("btnYear").addEventListener("click", ()=>{
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 1);
      setRange(ymd(start), ymd(now));
    });
  }

  // boot
  initTheme();
  if(typeof initBalanceFlags==='function') initBalanceFlags();
  updateSortIndicators();
  load();


/* ===========================
   FORCE_RENDER_FALLBACK
   (si no hay filas, pinta igual)
   =========================== */
(function(){
  function pickTbody(){
    return document.querySelector("table tbody")
        || document.querySelector("#table tbody")
        || document.querySelector("#expensesTable tbody")
        || document.querySelector("tbody");
  }

  function escapeHtml(x){
    return String(x ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderDirect(rows){
    const tbody = pickTbody();
    if(!tbody) return;

    // Si tu tabla tiene columnas distintas, esto igualmente pinta algo visible
    tbody.innerHTML = rows.map(r => {
      const date = escapeHtml(r.created_at || r.date_iso || r.date_raw || "");
      const merch = escapeHtml(r.merchant_clean || r.merchant_raw || r.sms || "");
      const cat = escapeHtml(r.category || "");
      const cur = escapeHtml(r.currency || "");
      const amt = (r.amount === null || r.amount === undefined) ? "" : escapeHtml(r.amount);
      return `<tr>
        <td>${date}</td>
        <td>${merch}</td>
        <td>${cat}</td>
        <td>${cur}</td>
        <td style="text-align:right">${amt}</td>
      </tr>`;
    }).join("");
  }

  async function force(){
    try{
      const tbody = pickTbody();
      const hasRows = tbody && tbody.querySelectorAll("tr").length > 0;
      if(hasRows) return; // ya hay filas

      const r = await fetch("/expenses?user_id=pedro&limit=200");
      const j = await r.json();
      const rows = j.expenses || j.rows || [];
      if(rows.length) renderDirect(rows);
    }catch(e){
      console.error("FORCE_RENDER_FALLBACK error:", e);
    }
  }

  // espera a que cargue el DOM y a que tu JS intente pintar primero
  window.addEventListener("load", () => setTimeout(force, 1200));
})();

</script>
</body>
</html>
