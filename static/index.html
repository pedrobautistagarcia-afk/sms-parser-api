<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Registro Gastos</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:18px}
    input,button,select{padding:7px 9px;font-size:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;max-width:1200px}
    .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;max-width:1200px;margin-top:10px}
    .muted{color:#666;font-size:13px}
    .ok{color:#0a7a2f;font-size:13px}
    .warn{color:#a15600;font-size:13px}
    .err{color:#b00020;font-size:13px}

    table{border-collapse:collapse;width:100%;margin-top:14px;max-width:1200px}
    th,td{border:1px solid #ddd;padding:6px 8px;text-align:left;vertical-align:middle}
    thead th{background:#f5f5f5;position:sticky;top:0;z-index:2}
    thead tr.filters th{background:#fafafa;top:37px;z-index:1}
    .num{text-align:right; font-variant-numeric: tabular-nums; white-space:nowrap}
    tr.duplicate{background:#ffe5e5}
    tr.newrow{background:#e9f7ff}
    .badge{display:inline-block;padding:2px 7px;border-radius:999px;font-size:12px;background:#f2f2f2}
    .totals{margin-top:10px;border:1px solid #ddd;border-radius:12px;padding:10px;max-width:1200px}
    .totals b{font-size:15px}
    .danger{background:#fff0f0;border:1px solid #ffd2d2}
    .thin{padding:6px;font-size:13px;width:100%;box-sizing:border-box}
    .w-date{width:170px}
    .w-amt{width:120px}
    .w-cur{width:95px}
    .w-cat{width:160px}

    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:12px}
    .btn{border:1px solid #ddd;background:#fff;border-radius:10px;padding:7px 10px}
    .btn:hover{background:#f7f7f7}
    .btn.active{border-color:#111}

    .merchant{font-weight:600}
    .date{color:#444}
    .cat{text-transform:lowercase}

    .cat-coffee{background:#fff3e6}
    .cat-food{background:#eaffea}
    .cat-transport{background:#eaf2ff}
    .cat-groceries{background:#f0fff5}
    .cat-shopping{background:#f7efff}
    .cat-other{background:#f5f5f5}

    tr.selected{outline:2px solid #111;outline-offset:-2px;}

    .cell-edit{width:100%;box-sizing:border-box;padding:6px;font-size:13px;}
    .cell-click{cursor:pointer}

    .snackbar{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:#111;color:#fff;border-radius:12px;padding:10px 12px;
      display:none;align-items:center;gap:10px;max-width:95vw;z-index:9999;
    }
    .snackbar button{
      background:#fff;color:#111;border:0;border-radius:10px;padding:7px 10px;
      cursor:pointer;font-weight:600;
    }
    .snackbar .mut{opacity:.85;font-size:13px}
  </style>
</head>
<body>

  <div class="topbar">
    <div>
      <h1 style="margin:0 0 6px 0">Registro Gastos</h1>
      <div class="muted">Ver es libre. Editar/borrar pide clave una vez. Reglas auto aplican al ingerir.</div>
    </div>

    <div class="right">
      <button class="btn" id="btnToday" onclick="setQuickRange('today')">Today</button>
      <button class="btn" id="btnWeek" onclick="setQuickRange('week')">Last week</button>
      <button class="btn" id="btnMonth" onclick="setQuickRange('month')">Last month</button>
      <button class="btn" id="btnYtd" onclick="setQuickRange('ytd')">This year</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button onclick="refreshAll()">Recargar</button>
        <button class="btn" onclick="exportCSV()">Export CSV</button>
        <button class="danger" id="btnDelete" onclick="deleteSelected()" disabled>Borrar seleccionado</button>

        <span class="muted">Seleccionado: <span id="selLabel">ninguno</span></span>
        <span id="status" class="muted">Listo.</span>
      </div>

      <div class="row">
        <label class="muted"><b>Desde</b></label>
        <input id="dateFrom" type="date" onchange="render()"/>
        <label class="muted"><b>Hasta</b></label>
        <input id="dateTo" type="date" onchange="render()"/>
        <button class="btn" onclick="clearDateRange()">Quitar fechas</button>
        <button class="btn" onclick="setOrChangeKey()">üîí Key</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <label><b>User</b></label>
      <input id="user" placeholder="userid" value="pedro"/>
      <span class="muted">Puedes dejarlo vac√≠o para ver todo.</span>
    </div>
  </div>

  <div class="totals">
    <b>Resumen (filtrado)</b>
    <div class="row" style="margin-top:8px">
      <span class="pill">Filas: <span id="sumCount">0</span></span>
      <span class="pill">Total KWD: <span id="sumKwd">0.000</span></span>
      <button onclick="clearFilters()">Limpiar filtros</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th class="w-date cell-click" onclick="toggleSort('date')">Fecha <span id="sort_date"></span></th>
        <th class="w-amt cell-click" onclick="toggleSort('amount')">Importe <span id="sort_amount"></span></th>
        <th class="w-cur">Moneda</th>
        <th>Comercio</th>
        <th class="w-cat">Categor√≠a</th>
      </tr>

      <tr class="filters">
        <th class="w-date">
          <span class="muted" style="font-size:12px">Usa ‚ÄúDesde/Hasta‚Äù arriba</span>
        </th>
        <th class="w-amt">
          <span class="muted" style="font-size:12px">‚Äî</span>
        </th>
        <th class="w-cur">
          <select id="fCur" class="thin" onchange="render()">
            <option value="">Todas</option>
          </select>
        </th>
        <th>
          <input id="fMerchant" class="thin" placeholder="buscar comercio..." oninput="render()"/>
        </th>
        <th class="w-cat">
          <select id="fCat" class="thin" onchange="render()">
            <option value="">Todas</option>
          </select>
        </th>
      </tr>
    </thead>

    <tbody id="tbody"></tbody>
  </table>

  <div id="snack" class="snackbar">
    <div>
      <div id="snackText" style="font-weight:700"></div>
      <div id="snackSub" class="mut"></div>
    </div>
    <button onclick="undoDelete()">Deshacer</button>
  </div>

<script>
let ALL = [];
let SORT = { field: "date", dir: "desc" };
let undoPayload = null;
let undoTimer = null;

const CATEGORY_OPTIONS = ["coffee","food","transport","groceries","shopping","other"];
const KEY_STORAGE = "rg_api_key";

function setStatus(text, cls){
  const el = document.getElementById('status');
  el.className = cls || "muted";
  el.textContent = text;
}

function fmtAmt(a){
  if(a === null || a === undefined || Number.isNaN(Number(a))) return "";
  return Number(a).toFixed(3);
}
function fmtDate(s){
  if(!s) return "";
  return String(s).replace("T"," ").replace("+00:00","").slice(0,16);
}
function catClass(cat){
  const c = (cat || "other").toLowerCase();
  if(c === "coffee") return "cat-coffee";
  if(c === "food") return "cat-food";
  if(c === "transport") return "cat-transport";
  if(c === "groceries") return "cat-groceries";
  if(c === "shopping") return "cat-shopping";
  return "cat-other";
}

function getSelectedId(){ return localStorage.getItem("selected_row_id"); }
function setSelectedId(id){
  if(id === null || id === undefined) localStorage.removeItem("selected_row_id");
  else localStorage.setItem("selected_row_id", String(id));
  updateSelectedUI();
}
function updateSelectedUI(){
  const id = getSelectedId();
  document.getElementById("selLabel").textContent = id ? "s√≠" : "ninguno";
  document.getElementById("btnDelete").disabled = !id;
}

/* ---------- KEY: prompt only when needed ---------- */
function getApiKey(passive=false){
  const k = (localStorage.getItem(KEY_STORAGE) || "").trim();
  if(k) return k;
  if(passive) return "";
  const entered = prompt("Introduce API key para editar/borrar:");
  if(!entered) return "";
  localStorage.setItem(KEY_STORAGE, entered.trim());
  return entered.trim();
}
function setOrChangeKey(){
  const current = localStorage.getItem(KEY_STORAGE) || "";
  const entered = prompt("API key (se guarda en este navegador):", current);
  if(entered === null) return; // cancel
  const v = entered.trim();
  if(!v){
    localStorage.removeItem(KEY_STORAGE);
    setStatus("Key borrada de este navegador.", "warn");
  }else{
    localStorage.setItem(KEY_STORAGE, v);
    setStatus("Key guardada ‚úÖ", "ok");
    setTimeout(()=>setStatus("Listo.","muted"), 900);
  }
}

async function fetchAll(){
  const user = (document.getElementById('user')?.value || "").trim();
  const url = user
    ? `/expenses?user_id=${encodeURIComponent(user)}&limit=2000`
    : `/expenses?limit=2000`;

  const res = await fetch(url);
  const data = await res.json();
  ALL = data.expenses || [];
}

function populateCategorySelect(){
  const sel = document.getElementById("fCat");
  const current = sel.value;
  const cats = Array.from(new Set(ALL.map(e => (e.category || "other")))).sort();
  sel.innerHTML = `<option value="">Todas</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join("");
  sel.value = cats.includes(current) ? current : "";
}

function populateCurrencySelect(){
  const sel = document.getElementById("fCur");
  const current = sel.value;

  const currencies = Array.from(new Set(ALL.map(e => (e.currency || "KWD")))).sort();
  ["KWD","USD","EUR"].forEach(c => { if(!currencies.includes(c)) currencies.push(c); });
  currencies.sort();

  sel.innerHTML =
    `<option value="">Todas</option>` +
    currencies.map(c => `<option value="${c}">${c}</option>`).join("");

  sel.value = (current === "" || currencies.includes(current)) ? current : "";
}

function parseISODateOnly(isoStr){
  if(!isoStr) return "";
  return String(isoStr).slice(0,10);
}

function withinDateRange(e){
  const from = document.getElementById("dateFrom").value;
  const to = document.getElementById("dateTo").value;
  if(!from && !to) return true;

  const d = parseISODateOnly(e.created_at);
  if(!d) return false;

  if(from && d < from) return false;
  if(to && d > to) return false;
  return true;
}

function applyFilters(){
  const fCur = document.getElementById("fCur").value; // "" => todas
  const fMerchant = document.getElementById("fMerchant").value.trim().toLowerCase();
  const fCat = document.getElementById("fCat").value;

  return ALL.filter(e => {
    if(fCur && (e.currency || "") !== fCur) return false;
    if(fCat && (e.category || "other") !== fCat) return false;

    if(fMerchant){
      const m = (e.merchant_clean || "").toLowerCase();
      if(!m.includes(fMerchant)) return false;
    }

    if(!withinDateRange(e)) return false;
    return true;
  });
}

function sortRows(rows){
  const copy = [...rows];
  const field = SORT.field;
  const dir = SORT.dir;

  const cmpText = (a,b) => String(a||"").localeCompare(String(b||""));
  const cmpNum  = (a,b) => (Number(a||0) - Number(b||0));

  copy.sort((ra, rb) => {
    let v = 0;
    if(field === "amount") v = cmpNum(ra.amount, rb.amount);
    else v = cmpText(ra.created_at, rb.created_at);
    return dir === "asc" ? v : -v;
  });
  return copy;
}

function updateSortIndicators(){
  document.getElementById("sort_date").textContent = SORT.field==="date" ? (SORT.dir==="asc"?"‚Üë":"‚Üì") : "";
  document.getElementById("sort_amount").textContent = SORT.field==="amount" ? (SORT.dir==="asc"?"‚Üë":"‚Üì") : "";
}

function toggleSort(field){
  if(SORT.field === field){
    SORT.dir = (SORT.dir === "asc") ? "desc" : "asc";
  }else{
    SORT.field = field;
    SORT.dir = (field === "date") ? "desc" : "asc";
  }
  updateSortIndicators();
  render();
}

function setActiveQuickButton(kind){
  const ids = ["btnToday","btnWeek","btnMonth","btnYtd"];
  ids.forEach(id => document.getElementById(id).classList.remove("active"));
  if(kind === "today") document.getElementById("btnToday").classList.add("active");
  if(kind === "week") document.getElementById("btnWeek").classList.add("active");
  if(kind === "month") document.getElementById("btnMonth").classList.add("active");
  if(kind === "ytd") document.getElementById("btnYtd").classList.add("active");
}

function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function addDaysISO(baseISO, delta){
  const d = new Date(baseISO + "T00:00:00");
  d.setDate(d.getDate() + delta);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function setQuickRange(kind){
  const t = todayISO();
  const fromEl = document.getElementById("dateFrom");
  const toEl = document.getElementById("dateTo");

  if(kind === "today"){
    fromEl.value = t; toEl.value = t;
  }else if(kind === "week"){
    fromEl.value = addDaysISO(t, -6); toEl.value = t;
  }else if(kind === "month"){
    fromEl.value = addDaysISO(t, -29); toEl.value = t;
  }else if(kind === "ytd"){
    fromEl.value = `${new Date().getFullYear()}-01-01`; toEl.value = t;
  }
  setActiveQuickButton(kind);
  render();
}
function clearDateRange(){
  document.getElementById("dateFrom").value = "";
  document.getElementById("dateTo").value = "";
  setActiveQuickButton(null);
  render();
}
function clearFilters(){
  document.getElementById("fCur").value = "";
  document.getElementById("fMerchant").value = "";
  document.getElementById("fCat").value = "";
  clearDateRange();
  SORT = { field: "date", dir: "desc" };
  updateSortIndicators();
  render();
}

function getFilteredRows(){
  return sortRows(applyFilters());
}

function exportCSV(){
  const rows = getFilteredRows();
  const header = ["created_at","amount","currency","merchant_clean","category"];
  const lines = [header.join(",")];

  for(const e of rows){
    const vals = [
      e.created_at || "",
      (e.amount ?? ""),
      e.currency || "",
      e.merchant_clean || "",
      e.category || "other"
    ].map(v => `"${String(v).replace(/"/g,'""')}"`);
    lines.push(vals.join(","));
  }

  const csv = lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.href = url;
  a.download = `gastos-${stamp}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  setStatus(`CSV exportado (${rows.length} filas)`, "ok");
  setTimeout(()=>setStatus("Listo.","muted"), 1200);
}

/* ---------------- Inline edit (requires key) ---------------- */
async function saveCategory(id, newCat){
  const apiKey = getApiKey(false);
  if(!apiKey){ setStatus("Acci√≥n cancelada (sin key).", "warn"); return false; }

  const res = await fetch(`/expenses/${encodeURIComponent(id)}/category?api_key=${encodeURIComponent(apiKey)}`,{
    method:"PATCH",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({category:newCat})
  });
  if(res.status === 401){ setStatus("Key incorrecta.", "err"); return false; }
  const data = await res.json();
  return data.updated === 1;
}

async function saveMerchant(id, newMerchant){
  const apiKey = getApiKey(false);
  if(!apiKey){ setStatus("Acci√≥n cancelada (sin key).", "warn"); return false; }

  const res = await fetch(`/expenses/${encodeURIComponent(id)}/merchant?api_key=${encodeURIComponent(apiKey)}`,{
    method:"PATCH",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({merchant_clean:newMerchant})
  });
  if(res.status === 401){ setStatus("Key incorrecta.", "err"); return false; }
  const data = await res.json();
  return data.updated === 1;
}

/* ---------------- Undo Snackbar ---------------- */
function showSnack(title, subtitle){
  document.getElementById("snackText").textContent = title;
  document.getElementById("snackSub").textContent = subtitle || "";
  document.getElementById("snack").style.display = "flex";
}
function hideSnack(){
  document.getElementById("snack").style.display = "none";
}
async function undoDelete(){
  if(!undoPayload) return;

  const apiKey = getApiKey(false);
  if(!apiKey){ setStatus("Acci√≥n cancelada (sin key).", "warn"); return; }

  try{
    const res = await fetch(`/expenses/restore?api_key=${encodeURIComponent(apiKey)}`,{
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(undoPayload)
    });
    if(res.status === 401){ setStatus("Key incorrecta.", "err"); return; }
    const data = await res.json();
    if(data.restored){
      setStatus("Deshecho ‚úÖ", "ok");
      hideSnack();
      undoPayload = null;
      if(undoTimer) clearTimeout(undoTimer);
      await refreshAll();
    }else{
      setStatus("No se pudo deshacer.", "warn");
    }
  }catch(e){
    setStatus("Error en undo.", "err");
  }
}

/* ---------------- Render table ---------------- */
function render(){
  updateSortIndicators();

  const selectedId = getSelectedId();
  const filtered = getFilteredRows();

  let sumKwd = 0;
  for(const e of filtered){
    if(e.currency === "KWD") sumKwd += Number(e.amount || 0);
  }
  document.getElementById("sumCount").textContent = String(filtered.length);
  document.getElementById("sumKwd").textContent = sumKwd.toFixed(3);

  const tb = document.getElementById('tbody');
  tb.innerHTML = "";

  for(const e of filtered){
    const tr = document.createElement('tr');
    tr.classList.add(catClass(e.category));
    tr.dataset.id = String(e.id);

    if(selectedId && String(e.id) === selectedId) tr.classList.add("selected");

    const tdDate = document.createElement("td");
    tdDate.className = "date";
    tdDate.textContent = fmtDate(e.created_at);

    const tdAmt = document.createElement("td");
    tdAmt.className = "num";
    tdAmt.innerHTML = `<b>${fmtAmt(e.amount)}</b>`;

    const tdCur = document.createElement("td");
    tdCur.textContent = e.currency || "";

    const tdMer = document.createElement("td");
    tdMer.className = "merchant cell-click";
    tdMer.textContent = e.merchant_clean || "";
    tdMer.title = "Click para editar (pedir√° key)";

    const tdCat = document.createElement("td");
    tdCat.className = "cell-click";
    tdCat.title = "Click para editar (pedir√° key)";

    const catSpan = document.createElement("span");
    catSpan.className = "badge cat";
    catSpan.textContent = (e.category || "other");
    tdCat.appendChild(catSpan);

    tr.addEventListener("click", (ev) => {
      const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : "";
      if(tag === "input" || tag === "select" || tag === "option") return;
      setSelectedId(e.id);
      render();
    });

    // Merchant inline edit
    tdMer.addEventListener("click", async (ev) => {
      ev.stopPropagation();

      const input = document.createElement("input");
      input.className = "cell-edit";
      input.value = e.merchant_clean || "";
      tdMer.innerHTML = "";
      tdMer.appendChild(input);
      input.focus();
      input.select();

      const finish = async (commit) => {
        const val = input.value.trim();
        tdMer.innerHTML = "";
        tdMer.textContent = val;

        if(!commit) return;
        if(val === (e.merchant_clean || "")) return;

        setStatus("Guardando comercio...", "muted");
        const ok = await saveMerchant(e.id, val);
        if(ok){
          setStatus("Guardado ‚úÖ", "ok");
          e.merchant_clean = val;
          setTimeout(()=>setStatus("Listo.","muted"), 900);
        }else{
          setStatus("No guardado.", "warn");
          tdMer.textContent = e.merchant_clean || "";
        }
      };

      input.addEventListener("keydown", (k) => {
        if(k.key === "Enter") finish(true);
        if(k.key === "Escape") finish(false);
      });
      input.addEventListener("blur", () => finish(true));
    });

    // Category inline edit
    tdCat.addEventListener("click", async (ev) => {
      ev.stopPropagation();

      const sel = document.createElement("select");
      sel.className = "cell-edit";
      for(const c of CATEGORY_OPTIONS){
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        if((e.category || "other").toLowerCase() === c) opt.selected = true;
        sel.appendChild(opt);
      }
      tdCat.innerHTML = "";
      tdCat.appendChild(sel);
      sel.focus();

      const commit = async () => {
        const val = sel.value;
        tdCat.innerHTML = "";
        const span = document.createElement("span");
        span.className = "badge cat";
        span.textContent = val;
        tdCat.appendChild(span);

        if(val === (e.category || "other")) return;

        setStatus("Guardando categor√≠a...", "muted");
        const ok = await saveCategory(e.id, val);
        if(ok){
          setStatus("Guardado ‚úÖ", "ok");
          e.category = val;
          setTimeout(()=>setStatus("Listo.","muted"), 900);
          render();
        }else{
          setStatus("No guardado.", "warn");
          render();
        }
      };

      sel.addEventListener("change", commit);
      sel.addEventListener("blur", commit);
      sel.addEventListener("keydown", (k) => {
        if(k.key === "Escape") { render(); }
      });
    });

    tr.appendChild(tdDate);
    tr.appendChild(tdAmt);
    tr.appendChild(tdCur);
    tr.appendChild(tdMer);
    tr.appendChild(tdCat);

    tb.appendChild(tr);
  }

  updateSelectedUI();
}

async function refreshAll(){
  setStatus("Cargando...", "muted");
  await fetchAll();
  populateCategorySelect();
  populateCurrencySelect();
  render();
  setStatus("Listo.", "muted");
}

/* ---------------- Delete + Undo (requires key) ---------------- */
async function deleteSelected(){
  const id = getSelectedId();
  if(!id) return;

  const apiKey = getApiKey(false);
  if(!apiKey){ setStatus("Acci√≥n cancelada (sin key).", "warn"); return; }

  const ok = confirm(`¬øSeguro que quieres borrar este gasto?`);
  if(!ok) return;

  setStatus("Borrando...", "muted");

  try{
    const res = await fetch(`/expenses/${encodeURIComponent(id)}?api_key=${encodeURIComponent(apiKey)}`, {
      method: "DELETE"
    });
    if(res.status === 401){ setStatus("Key incorrecta.", "err"); return; }
    const data = await res.json();

    if(data.deleted === 1 && data.deleted_row){
      const r = data.deleted_row;
      undoPayload = {
        user_id: r.user_id,
        sms: r.sms || r.sms_raw || "",
        amount: r.amount,
        currency: r.currency,
        merchant_raw: r.merchant_raw,
        merchant_clean: r.merchant_clean,
        category: r.category,
        created_at: r.created_at,
        date_raw: r.date_raw,
        date_iso: r.date_iso
      };

      showSnack("Gasto eliminado", `${(undoPayload.merchant_clean||"").slice(0,40)} ¬∑ ${undoPayload.amount ?? ""} ${undoPayload.currency||""}`);
      if(undoTimer) clearTimeout(undoTimer);
      undoTimer = setTimeout(() => {
        hideSnack();
        undoPayload = null;
      }, 5000);

      setSelectedId(null);
      await refreshAll();
      setStatus("Borrado (undo disponible).", "warn");
      setTimeout(()=>setStatus("Listo.","muted"), 1200);
    }else{
      setStatus("No se ha borrado.", "warn");
    }
  }catch(e){
    setStatus("Error borrando.", "err");
  }
}

updateSelectedUI();
refreshAll();
</script>
</body>
</html>
