<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Gastos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    h1 { margin-bottom: 10px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .filters { margin-bottom: 12px; }
    .filters button { margin-right: 6px; padding: 6px 10px; cursor: pointer; }
    .filters input, .filters select { padding: 6px 8px; }
    .insights { display: flex; gap: 20px; margin: 12px 0 18px; flex-wrap: wrap; }
    .box { background: white; padding: 12px; border: 1px solid #ddd; flex: 1; min-width: 260px; }
    .box h3 { margin: 0 0 8px; font-size: 16px; }
    .muted { color: #777; font-size: 13px; }
    table { border-collapse: collapse; width: 100%; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #efefef; text-align: left; }
    tfoot td { font-weight: bold; background: #fafafa; }
    .pill { display: inline-block; padding: 2px 6px; border: 1px solid #ddd; border-radius: 10px; font-size: 12px; background: #fff; }
  </style>
</head>
<body>

<h1>Registro de Gastos</h1>

<div class="filters">
  <div class="row" style="margin-bottom:10px;">
    <button onclick="setQuickRange('today')">Hoy</button>
    <button onclick="setQuickRange('7d')">7 días</button>
    <button onclick="setQuickRange('month')">Mes</button>
    <button onclick="setQuickRange('year')">Año</button>
    <span class="pill" id="activeRange">rango: custom</span>
  </div>

  <div class="row">
    <input id="q" type="text" placeholder="Buscar comercio..." />

    <select id="category">
      <option value="">Todas las categorías</option>
      <option value="apartment rental">Apartment rental</option>
      <option value="coffee">Coffee</option>
      <option value="food">Food</option>
      <option value="groceries">Groceries</option>
      <option value="transport">Transport</option>
      <option value="uncategorized">Uncategorized</option>
      <option value="other">Other</option>
    </select>

    <label class="muted">Desde</label>
    <input id="date_from" type="date" />
    <label class="muted">Hasta</label>
    <input id="date_to" type="date" />

    <label class="muted">Orden</label>
    <select id="sort">
      <option value="date_desc" selected>Fecha (nuevo → viejo)</option>
      <option value="date_asc">Fecha (viejo → nuevo)</option>
      <option value="amount_desc">Importe (alto → bajo)</option>
      <option value="amount_asc">Importe (bajo → alto)</option>
    </select>

    <label class="muted">Límite</label>
    <select id="limit">
      <option value="50">50</option>
      <option value="200" selected>200</option>
      <option value="500">500</option>
      <option value="1000">1000</option>
    </select>

    <button onclick="applyFilters()">Aplicar</button>
    <button onclick="resetFilters()">Reset</button>
  </div>
</div>

<div class="insights">
  <div class="box">
    <h3>Total</h3>
    <div id="totalAmount">–</div>
    <div class="muted" id="txCount"></div>
  </div>

  <div class="box">
    <h3>Top categorías</h3>
    <div id="topCategories">–</div>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Comercio</th>
      <th>Categoría</th>
      <th>Importe (KWD)</th>
    </tr>
  </thead>
  <tbody id="expensesBody"></tbody>
  <tfoot>
    <tr>
      <td colspan="3">TOTAL</td>
      <td id="tableTotal">–</td>
    </tr>
  </tfoot>
</table>

<script>
let currentRange = null;

function iso(d){return d.toISOString().slice(0,10)}

function setQuickRange(r){
  currentRange=r;
  const n=new Date();let f,t;
  if(r==='today'){f=t=iso(n)}
  if(r==='7d'){f=iso(new Date(n-7*864e5));t=iso(n)}
  if(r==='month'){f=iso(new Date(n.getFullYear(),n.getMonth(),1));t=iso(n)}
  if(r==='year'){f=iso(new Date(n.getFullYear(),0,1));t=iso(n)}
  date_from.value=f;date_to.value=t;
  activeRange.textContent='rango: '+r;
  loadAll();
}

function applyFilters(){currentRange=null;activeRange.textContent='rango: custom';loadAll()}
function resetFilters(){
  q.value='';
  category.value='';
  date_from.value='';
  date_to.value='';
  sort.value='date_desc';
  limit.value='200';
  currentRange=null;
  activeRange.textContent='rango: custom';
  loadAll()
}

async function loadAll(){await loadInsights();await loadExpenses()}

async function loadInsights(){
  const p=new URLSearchParams();
  if(currentRange)p.set('range',currentRange);
  else{if(date_from.value)p.set('from_date',date_from.value);if(date_to.value)p.set('to_date',date_to.value)}
  if(q.value)p.set('q',q.value);
  if(category.value)p.set('category',category.value);
  const d=await (await fetch('/api/insights?'+p)).json();
  totalAmount.textContent=(d.total_amount||0).toFixed(3)+' KWD';
  txCount.textContent=(d.tx_count||0)+' movimientos';
  topCategories.innerHTML=(d.category_share||[]).map(c=>`${c.category}: ${Number(c.amount).toFixed(3)} KWD (${c.pct}%)`).join('<br>')||'<span class="muted">Sin datos</span>';
}

async function loadExpenses(){
  const p=new URLSearchParams({limit:limit.value, sort:sort.value});
  if(q.value)p.set('q',q.value);
  if(category.value)p.set('category',category.value);
  if(date_from.value)p.set('date_from',date_from.value);
  if(date_to.value)p.set('date_to',date_to.value);

  const d=await (await fetch('/expenses?'+p)).json();
  expensesBody.innerHTML='';
  let t=0;
  (d.expenses||[]).forEach(e=>{
    t+=Number(e.amount||0);
    expensesBody.innerHTML+=`<tr><td>${String(e.created_at||'').slice(0,10)}</td><td>${e.merchant_clean||''}</td><td>${e.category||''}</td><td>${Number(e.amount||0).toFixed(3)}</td></tr>`;
  });
  tableTotal.textContent=t.toFixed(3)+' KWD';
}

loadAll();
</script>

</body>
</html>
