<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Registro Gastos</title>
  <style>
    :root{
      --bg:#000000;          /* dark */
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
      --border2:#243041;
      --green:#22c55e;
      --red:#ef4444;

      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
      --border2:#243041;
      --green:#22c55e;
      --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      background: var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 18px;}
    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom:14px;
    }
    h1{margin:0; font-size:22px; letter-spacing:.2px;}
    .sub{margin:6px 0 0 0; color:var(--muted); font-size:12px}

    /* flags */
    .flagSvg{width:16px;height:12px;display:inline-block;vertical-align:-2px;margin-right:6px;border-radius:2px;overflow:hidden;box-shadow:0 0 0 1px rgba(255,255,255,.10) inset;}

    /* Balance dropdown */
    #balanceBox{
      display:inline-flex;
      flex-direction:column;
      padding:8px 12px;
      border-radius:10px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
      min-width:170px;
    }
    #balanceBox .balTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
    }
    #balanceBox .balChevron{
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      transition:transform .15s ease;
    }
    #balanceBox[aria-expanded="true"] .balChevron{ transform: rotate(180deg); }
    #balanceBox .balDrop{
      display:none;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(31,41,55,.7);
      gap:8px;
    }
    #balanceBox[aria-expanded="true"] .balDrop{
      display:flex;
      flex-direction:column;
    }
    .balRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      padding:6px 8px;
      border-radius:10px;
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(31,41,55,.8);
      font-weight:900;
    }
    .balLeft{display:flex; align-items:center; gap:8px;}
    .balCur{color:var(--muted); width:44px;}
    .balAmt{font-variant-numeric: tabular-nums; font-weight:900;}
    .pos{color:var(--green)}
    .neg{color:var(--red)}

    #errBanner{
      display:none;
      margin:12px 0;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.35);
      color:#fecaca;
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }

    .panel{
      background:var(--panelBg);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .bar{
      display:flex; flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .left, .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      background:#0b0f14;
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:12px;
      outline:none;
      font-weight:900;
    }
    .pill:focus{border-color:#304156}
    select.pill option{background:#0b0f14; color:var(--text)}
    .btn{
      cursor:pointer;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:12px;
      transition:transform .02s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.05); border-color:var(--border2)}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 9px; font-size:12px}
    .loading{color:var(--muted); font-size:12px; padding:6px 2px}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--tableBg);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:#cbd5e1;
      background:rgba(255,255,255,.03);
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      position:sticky;
      top:0;
      z-index:5;
    }
    tbody td{
      padding:9px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(31,41,55,.8);
      vertical-align:middle;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:1px;
    }
    tbody tr:hover td{background:rgba(255,255,255,.02)}
    tbody tr:last-child td{border-bottom:none}

    th.th-sort{cursor:pointer; user-select:none}
    th.th-sort:hover{background:rgba(255,255,255,.06)}
    .sort-ind{display:inline-block; min-width:14px; opacity:.8}

    td.amt{font-variant-numeric: tabular-nums; text-align:right}
    .amt-income{color:var(--green); font-weight:900}
    .amt-expense{color:var(--red); font-weight:900}

    .muted{color:var(--muted)}
    .tight{max-width:260px}
    .tight2{max-width:170px}

    .filterRow th{padding:8px 10px; background:rgba(255,255,255,.02)}
    .colFilter{
      width:100%;
      background:#0b0f14;
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:6px 8px;
      font-size:12px;
      outline:none;
    }
    .colFilter:focus{border-color:#304156}

    /* inline edit */
    td .inlineInput{
      width:100%;
      background:#0b0f14;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px 8px;
      font-size:12px;
      outline:none;
    }
    td .inlineInput:focus{border-color:#304156}
    td .catSel{
      width:100%;
      background:#0b0f14;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px 8px;
      font-size:12px;
      outline:none;
      font-weight:900;
    }
    td .catSel:focus{border-color:#304156}
    td .catSel option{background:#0b0f14; color:var(--text)}
  
    /* THEMES */
    html[data-theme="light"]{
      --bgA:#f3f4f6;
      --bgB:#ffffff;
      --bgC:#f3f4f6;

      --panelBg:#ffffff;
      --tableBg:#ffffff;

      --text:#0b1220;
      --muted:#4b5563;
      --border:#e5e7eb;
      --border2:#d1d5db;
    }
/* Theme control UI */
    .themeCtl{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:10px;
      flex-wrap:wrap;
    }
.themeCtl .miniBtn{
      cursor:pointer;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      transition:background .2s ease, border-color .2s ease, transform .02s ease;
      user-select:none;
    }
    .themeCtl .miniBtn:hover{background:rgba(255,255,255,.05); border-color:var(--border2)}
    .themeCtl .miniBtn:active{transform:translateY(1px)}

    /* LIGHT THEME FIXES (contrast) */
    html[data-theme="light"] body{
      background:linear-gradient(180deg,var(--bgA), var(--bgB) 40%, var(--bgC));
    }
    html[data-theme="light"] .panel{
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    html[data-theme="light"] table{
      background:var(--tableBg);
    }
    html[data-theme="light"] thead th{
      color:#111827;
      background:#f3f4f6;
      border-bottom:1px solid var(--border);
    }
    html[data-theme="light"] tbody td{
      border-bottom:1px solid rgba(229,231,235,.9);
    }
    html[data-theme="light"] tbody tr:hover td{
      background:#f9fafb;
    }
    /* Inputs / selects */
    html[data-theme="light"] .pill,
    html[data-theme="light"] .colFilter,
    html[data-theme="light"] td .inlineInput,
    html[data-theme="light"] td .catSel{
      background:#ffffff !important;
      color:#0b1220 !important;
      border-color:var(--border) !important;
    }
    html[data-theme="light"] select.pill option,
    html[data-theme="light"] td .catSel option{
      background:#ffffff !important;
      color:#0b1220 !important;
    }
    /* Buttons */
    html[data-theme="light"] .btn,
    html[data-theme="light"] .themeCtl .miniBtn{
      background:#ffffff;
      color:#0b1220;
      border-color:var(--border);
    }
    html[data-theme="light"] .btn:hover,
    html[data-theme="light"] .themeCtl .miniBtn:hover{
      background:#f9fafb;
      border-color:var(--border2);
    }
    /* Balance box */
    html[data-theme="light"] #balanceBox{
      background:#ffffff;
      border-color:var(--border);
    }
    html[data-theme="light"] .balRow{
      background:#f9fafb;
      border-color:var(--border);
    }
    html[data-theme="light"] .balCur{ color:#6b7280; }

</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Registro Gastos</h1>
        <div class="sub">Estable (no rompe) + Add Category + Balance por divisa + Flags SVG.</div>
        <div class="themeCtl">
          <button class="btn small" id="themeToggle" title="Toggle theme"><span id="themeText">Dark</span></button>
</div>
      </div>

      <div id="balanceBox" aria-expanded="false" title="Click to expand">
        <div class="balTop">
          <span class="balTitle">Balance</span>
          <span class="balChevron">▾</span>
        </div>
        <div class="balDrop" id="balDrop">
          <div class="balRow" id="balKWD"><span class="balLeft"><span class="balCur">KWD</span></span><span class="balAmt">+0.000</span></div>
          <div class="balRow" id="balUSD"><span class="balLeft"><span class="balCur">USD</span></span><span class="balAmt">+0.000</span></div>
          <div class="balRow" id="balEUR"><span class="balLeft"><span class="balCur">EUR</span></span><span class="balAmt">+0.000</span></div>
        </div>
      </div>
    </div>

    <div id="errBanner"></div>

    <div class="panel">
      <div class="bar">
        <div class="left">
          <input id="q" class="pill" placeholder="Search merchant / category / currency…" />
          <select id="cur" class="pill">
            <option value="">All currencies</option>
            <option value="KWD">KWD</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
          <select id="cat" class="pill">
            <option value="">All categories</option>
          </select>
          <input id="startDate" class="pill" type="date" title="Start date"/>
          <input id="endDate" class="pill" type="date" title="End date"/>
          <button class="btn ghost" id="clear">Clear</button>
        </div>

        <div class="right">
          <button class="btn small" data-range="today">Today</button>
          <button class="btn small" data-range="week">Last week</button>
          <button class="btn small" data-range="month">Last month</button>
          <button class="btn small" data-range="year">This year</button>
          <button class="btn small" id="reload">Reload</button>
          <button class="btn small" id="csv">Export CSV</button>
        </div>
      </div>

      <div class="loading" id="loading">Loading…</div>

      <table>
        <thead>
          <tr>
            <th class="th-sort" data-sort="created_at">Created <span class="sort-ind" data-ind="created_at"></span></th>
            <th class="tight th-sort" data-sort="merchant_clean">Merchant <span class="sort-ind" data-ind="merchant_clean"></span></th>
            <th>Category</th>
            <th class="th-sort" data-sort="currency">Currency <span class="sort-ind" data-ind="currency"></span></th>
            <th class="th-sort" data-sort="amount" style="text-align:right">Amount <span class="sort-ind" data-ind="amount"></span></th>
          </tr>
          <tr class="filterRow">
            <th></th>
            <th><input class="colFilter" id="fMerch" placeholder="Merchant contains…" /></th>
            <th><input class="colFilter" id="fCat" placeholder="Category contains…" /></th>
            <th><input class="colFilter" id="fCur" placeholder="KWD/USD/EUR…" /></th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const errBanner = $("errBanner");
  function showError(msg){
    errBanner.style.display="block";
    errBanner.textContent = String(msg || "Unknown error");
  }
  function clearError(){
    errBanner.style.display="none";
    errBanner.textContent="";
  }
  window.addEventListener("error", (e)=>showError("JS error: " + (e?.message || e)));
  window.addEventListener("unhandledrejection", (e)=>showError("Promise error: " + (e?.reason?.message || e?.reason || e)));

  // balance toggle
  const bal = $("balanceBox");
  if(bal){
    bal.addEventListener("click", (ev)=>{
      ev.stopPropagation();
      const open = bal.getAttribute("aria-expanded") === "true";
      bal.setAttribute("aria-expanded", open ? "false" : "true");
    });
    document.addEventListener("click", ()=> bal.setAttribute("aria-expanded","false"));
  }

  const state = {
    user_id: "pedro",
    raw: [],
    view: [],
    sort: { key:"created_at", dir:"desc" },
    cats: new Set()
  };

  function flagForCur(cur){
    const c = String(cur||"").toUpperCase();
    if(c==="KWD") return `
      <svg class="flagSvg" viewBox="0 0 24 18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect width="24" height="18" fill="#fff"/>
        <rect width="24" height="6" y="0" fill="#16a34a"/>
        <rect width="24" height="6" y="12" fill="#dc2626"/>
        <path d="M0 0h7l5 9-5 9H0z" fill="#111827"/>
      </svg>`;
    if(c==="USD") return `
      <svg class="flagSvg" viewBox="0 0 24 18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect width="24" height="18" fill="#fff"/>
        <g fill="#dc2626">
          <rect y="0" width="24" height="2"/>
          <rect y="4" width="24" height="2"/>
          <rect y="8" width="24" height="2"/>
          <rect y="12" width="24" height="2"/>
          <rect y="16" width="24" height="2"/>
        </g>
        <rect width="10" height="8" fill="#1d4ed8"/>
        <g fill="#fff">
          <circle cx="2" cy="2" r="0.6"/><circle cx="4" cy="2" r="0.6"/><circle cx="6" cy="2" r="0.6"/><circle cx="8" cy="2" r="0.6"/>
          <circle cx="3" cy="4" r="0.6"/><circle cx="5" cy="4" r="0.6"/><circle cx="7" cy="4" r="0.6"/><circle cx="9" cy="4" r="0.6"/>
          <circle cx="2" cy="6" r="0.6"/><circle cx="4" cy="6" r="0.6"/><circle cx="6" cy="6" r="0.6"/><circle cx="8" cy="6" r="0.6"/>
        </g>
      </svg>`;
    if(c==="EUR") return `
      <svg class="flagSvg" viewBox="0 0 24 18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect width="24" height="18" fill="#1d4ed8"/>
        <g fill="#facc15">
          <circle cx="12" cy="3.5" r="0.7"/><circle cx="15" cy="4.3" r="0.7"/><circle cx="17.3" cy="6.5" r="0.7"/><circle cx="18.1" cy="9" r="0.7"/>
          <circle cx="17.3" cy="11.5" r="0.7"/><circle cx="15" cy="13.7" r="0.7"/><circle cx="12" cy="14.5" r="0.7"/><circle cx="9" cy="13.7" r="0.7"/>
          <circle cx="6.7" cy="11.5" r="0.7"/><circle cx="5.9" cy="9" r="0.7"/><circle cx="6.7" cy="6.5" r="0.7"/><circle cx="9" cy="4.3" r="0.7"/>
        </g>
      </svg>`;
    return "";
  }

  function isIncomeFromSms(sms){
    const t = String(sms||"").toLowerCase();
    return t.includes("credit") || t.includes("credited") || t.includes("deposit") || t.includes("salary") || t.includes("received") || t.includes("refund");
  }

  function fmtCat(x){
    const raw = String(x||"other").trim();
    const t = raw ? raw : "other";
    const nice = t.replaceAll("_"," ").replaceAll("-"," ").toLowerCase();
    return nice.split(" ").filter(Boolean).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(" ");
  }

  function setLoading(text){ $("loading").textContent = text || ""; }

  function catOptions(selected){
    const sel = String(selected || "other").toLowerCase();
    const cats = Array.from(state.cats || []).map(x=>String(x||"").toLowerCase()).filter(Boolean);
    if(!cats.includes("other")) cats.push("other");
    if(sel && !cats.includes(sel)) cats.push(sel);
    cats.sort();

    const opts = cats.map(c=>{
      const label = fmtCat(c);
      const isSel = c === sel ? "selected" : "";
      return `<option value="${c}" ${isSel}>${label}</option>`;
    }).join("");

    return opts + `<option value="__add__">+ Add category…</option>`;
  }

  async function postJSON(url, body){
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    if(!r.ok) throw new Error("HTTP " + r.status);
    return r.json().catch(()=> ({}));
  }

  async function load(){
    clearError();
    setLoading("Loading…");
    try{
      const r = await fetch(`/expenses?user_id=${encodeURIComponent(state.user_id)}&limit=500`);
      if(!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      state.raw = Array.isArray(j.expenses) ? j.expenses : [];
      state.cats = new Set(state.raw.map(x=>String(x.category||"other").toLowerCase()));
      syncCategoryDropdown();
      applyFilters();
    }catch(e){
      showError(e?.message || e);
    }finally{
      setLoading("");
    }
  }

  function syncCategoryDropdown(){
    const sel = $("cat");
    const keep = sel.value;
    const arr = Array.from(state.cats).sort();
    sel.innerHTML = '<option value="">All categories</option>' + arr.map(c=>`<option value="${c}">${fmtCat(c)}</option>`).join("");
    sel.value = keep;
  }

  function applyFilters(){
    const q = ($("q")?.value || "").trim().toLowerCase();
    const cur = ($("cur")?.value || "").trim().toUpperCase();
    const cat = ($("cat")?.value || "").trim().toLowerCase();

    const fCreated = ($("fCreated")?.value || "").trim().toLowerCase();
    const fMerch = $("fMerch").value.trim().toLowerCase();
    const fCat = $("fCat").value.trim().toLowerCase();
    const fCur = ($("fCur")?.value || "").trim().toLowerCase();
    const sd = $("startDate") ? ($("startDate")?.value || "") : "";
    const ed = $("endDate") ? ($("endDate")?.value || "") : "";

    let v = state.raw.filter(e=>{
      const merch = String(e.merchant_clean||"").toLowerCase();
      const category = String(e.category||"other").toLowerCase();
      const currency = String(e.currency||"").toUpperCase();
      const created = String(e.created_at||"");
      const cdate = created ? created.slice(0,10) : "";
      if(sd && cdate && cdate < sd) return false;
      if(ed && cdate && cdate > ed) return false;

      if(cur && currency !== cur) return false;
      if(cat && category !== cat) return false;

      if(q){
        const hay = (merch + " " + category + " " + currency).toLowerCase();
        if(!hay.includes(q)) return false;
      }

      if(fCreated && !created.toLowerCase().includes(fCreated)) return false;
      if(fMerch && !merch.includes(fMerch)) return false;
      if(fCat && !category.includes(fCat)) return false;
      if(fCur && !currency.toLowerCase().includes(fCur)) return false;

      return true;
    });

    const {key, dir} = state.sort;
    const mul = dir === "asc" ? 1 : -1;
    v.sort((a,b)=>{
      let av = a?.[key], bv = b?.[key];
      if(key === "amount"){
        av = Number(av||0); bv = Number(bv||0);
        return (av===bv?0:(av>bv?1:-1))*mul;
      }
      if(key === "created_at"){
        const ad = new Date(av||0).getTime();
        const bd = new Date(bv||0).getTime();
        return (ad===bd?0:(ad>bd?1:-1))*mul;
      }
      av = String(av||"").toLowerCase();
      bv = String(bv||"").toLowerCase();
      return (av===bv?0:(av>bv?1:-1))*mul;
    });

    state.view = v;
    render();
  }

  function updateSortIndicators(){
    document.querySelectorAll(".sort-ind").forEach(el=>el.textContent="");
    const ind = document.querySelector(`.sort-ind[data-ind="${state.sort.key}"]`);
    if(ind) ind.textContent = state.sort.dir === "asc" ? "↑" : "↓";
  }

  function setBalanceFlags(){
    const map = { balKWD:"KWD", balUSD:"USD", balEUR:"EUR" };
    for(const id in map){
      const row = document.getElementById(id);
      if(!row) continue;
      const left = row.querySelector(".balLeft");
      if(!left) continue;
      if(left.querySelector("svg")) continue;
      const span = document.createElement("span");
      span.innerHTML = flagForCur(map[id]);
      left.insertBefore(span, left.firstChild);
    }
  }

  function updateBalance(){
    const totals = { KWD:0, USD:0, EUR:0 };
    for(const e of state.view){
      const cur = String(e.currency||"").toUpperCase();
      if(!(cur in totals)) continue;
      const income = isIncomeFromSms(e.sms);
      const amt = Number(e.amount||0);
      totals[cur] += income ? amt : -amt;
    }
    function setRow(rowId, val){
      const row = document.getElementById(rowId);
      if(!row) return;
      const amtEl = row.querySelector(".balAmt");
      if(!amtEl) return;
      amtEl.classList.remove("pos","neg");
      amtEl.classList.add(val >= 0 ? "pos" : "neg");
      const sign = val >= 0 ? "+" : "";
      amtEl.textContent = sign + val.toFixed(3);
    }
    setRow("balKWD", totals.KWD);
    setRow("balUSD", totals.USD);
    setRow("balEUR", totals.EUR);
    setBalanceFlags();
  }

  function render(){
    updateSortIndicators();
    const tb = $("tbody");
    tb.innerHTML = state.view.map(e=>{
      const income = isIncomeFromSms(e.sms);
      const amt = Number(e.amount||0);
      const amtTxt = (income?"+":"") + amt.toFixed(3);
      const amtClass = income ? "amt-income" : "amt-expense";
      return `
        <tr>
          <td class="muted tight2">${String(e.created_at||"")}</td>
          <td class="tight merchCell" data-id="${e.id}">
            <span class="merchText">${String(e.merchant_clean||"")}</span>
          </td>
          <td class="category">
            <select class="catSel" data-id="${e.id}">${catOptions(e.category)}</select>
          </td>
          <td class="muted">${flagForCur(e.currency)} ${String(e.currency||"")}</td>
          <td class="amt ${amtClass}">${amtTxt}</td>
        </tr>
      `;
    }).join("");
    updateBalance();
  }

  function setRange(range){
    const now = new Date();
    const start = new Date(now);
    if(range==="today"){ start.setHours(0,0,0,0); }
    else if(range==="week"){ start.setDate(start.getDate()-7); }
    else if(range==="month"){ start.setMonth(start.getMonth()-1); }
    else if(range==="year"){ start.setMonth(0,1); start.setHours(0,0,0,0); }
    $("fCreated").value = start.toISOString().slice(0,10);
    applyFilters();
  }

  function exportCSV(){
    const rows = [["created_at","merchant","category","currency","amount"]];
    for(const e of state.view){
      rows.push([String(e.created_at||""), String(e.merchant_clean||""), String(e.category||"other"), String(e.currency||""), String(e.amount||"")]);
    }
    const csv = rows.map(r=>r.map(x=>{
      const t = String(x).replaceAll('"','""');
      return `"${t}"`;
    }).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "expenses.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // events filters
  if($("q")) $("q").addEventListener("input", applyFilters);
  if($("cur")) $("cur").addEventListener("change", applyFilters);
  if($("cat")) $("cat").addEventListener("change", applyFilters);
  if($("startDate")) if($("startDate")) $("startDate").addEventListener("change", applyFilters);
  if($("endDate")) if($("endDate")) $("endDate").addEventListener("change", applyFilters);
  if($("fCreated")) $("fCreated").addEventListener("input", applyFilters);
  if($("fMerch")) $("fMerch").addEventListener("input", applyFilters);
  if($("fCat")) $("fCat").addEventListener("input", applyFilters);
  if($("fCur")) $("fCur").addEventListener("input", applyFilters);

  if($("clear")) $("clear").addEventListener("click", ()=>{
    ($("q")?.value || "")="";
    ($("cur")?.value || "")="";
    ($("cat")?.value || "")="";
    $("fCreated").value="";
    $("fMerch").value="";
    $("fCat").value="";
    ($("fCur")?.value || "")="";
    if($("startDate")) ($("startDate")?.value || "")="";
    if($("endDate")) ($("endDate")?.value || "")="";
    applyFilters();
  });

  document.querySelectorAll('[data-range]').forEach(btn=>{
    btn.addEventListener("click", ()=> setRange(btn.dataset.range));
  });

  if($("reload")) $("reload").addEventListener("click", load);
  if($("csv")) $("csv").addEventListener("click", exportCSV);

  document.querySelectorAll("th.th-sort").forEach(th=>{
    th.addEventListener("click", ()=>{
      const key = th.dataset.sort;
      if(state.sort.key === key) state.sort.dir = (state.sort.dir === "asc") ? "desc" : "asc";
      else { state.sort.key = key; state.sort.dir = "asc"; }
      applyFilters();
    });
  });

  // Merchant inline edit
  document.addEventListener("click", (ev)=>{
    const cell = ev.target.closest("td.merchCell");
    if(!cell) return;
    if(cell.querySelector("input.inlineInput")) return;

    const id = Number(cell.dataset.id||0);
    if(!id) return;

    const span = cell.querySelector(".merchText");
    const oldValue = span ? span.textContent : "";

    const input = document.createElement("input");
    input.className = "inlineInput";
    input.type = "text";
    input.value = oldValue;

    if(span) span.replaceWith(input);
    else cell.appendChild(input);

    input.focus();
    input.select();

    const finish = async (save)=>{
      const val = input.value.trim();
      const finalVal = save ? val : oldValue;

      const sp = document.createElement("span");
      sp.className = "merchText";
      sp.textContent = finalVal;
      input.replaceWith(sp);

      if(save && val !== oldValue){
        try{
          await postJSON("/update/merchant", { id, merchant: val });
          await initTheme();
  
  function initTheme(){
    const saved = localStorage.getItem("rg_theme");
    const theme = (saved === "light" || saved === "dark") ? saved : "dark";
    document.documentElement.setAttribute("data-theme", theme);
    const t = document.getElementById("themeText");
    if(t) t.textContent = (theme === "dark") ? "Dark" : "Light";
  }

const tbtn = document.getElementById("themeToggle");
  if(tbtn){
    tbtn.addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      const next = (cur === "dark") ? "light" : "dark";
      localStorage.setItem("rg_theme", next);
      document.documentElement.setAttribute("data-theme", next);
      const t = document.getElementById("themeText");
      if(t) t.textContent = (next === "dark") ? "Dark" : "Light";
    });
  }

  load();
        }catch(e){
          showError("Save merchant failed: " + (e?.message || e));
        }
      }
    };

    input.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") finish(true);
      if(e.key === "Escape") finish(false);
    });
    input.addEventListener("blur", ()=>finish(true));
  });

  // Category save + add category
  document.addEventListener("change", async (ev)=>{
    const sel = ev.target.closest("select.catSel");
    if(!sel) return;

    const id = Number(sel.dataset.id||0);
    if(!id) return;

    let category = String(sel.value||"other").toLowerCase();

    if(category === "__add__"){
      const userText = prompt("New category name (e.g. coffee shop, rent, groceries):");
      if(!userText){
        await load();
        return;
      }
      category = userText.trim().toLowerCase().replaceAll(" ", "_");
      category = category.replace(/[^a-z0-9_-]/g, "");
      category = category.replace(/__+/g, "_").replace(/^[_-]+|[_-]+$/g, "");
      if(!category) category = "other";

      state.cats.add(category);
      syncCategoryDropdown(); // para que se vea también arriba
    }

    try{
      await postJSON("/update/category", { id, category });
      await load();
    }catch(e){
      showError("Save category failed: " + (e?.message || e));
      await load();
    }
  });


  function applyTheme(theme){
    const t = (theme === "light") ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", t);
    const btn = document.getElementById("themeToggle");
    if(btn) btn.textContent = "Theme: " + (t === "dark" ? "Dark" : "Light");
  }

  function loadThemePrefs(){
    const theme = localStorage.getItem("rg_theme") || "dark";
    applyTheme(theme);
}

  // boot
  loadThemePrefs();
  load();

  // Theme listeners
  const tbtn = document.getElementById("themeToggle");
  if(tbtn){
    tbtn.addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      const next = (cur === "dark") ? "light" : "dark";
      localStorage.setItem("rg_theme", next);
      applyTheme(next);
    });
  }

})();
</script>
</body>
</html>
