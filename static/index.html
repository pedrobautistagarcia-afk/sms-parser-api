<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Registro Gastos</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px}
    input,button,select{padding:8px;font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;max-width:1200px}
    .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;max-width:1200px;margin-top:12px}
    .muted{color:#666;font-size:13px}
    .ok{color:#0a7a2f;font-size:13px}
    .warn{color:#a15600;font-size:13px}
    .err{color:#b00020;font-size:13px}
    table{border-collapse:collapse;width:100%;margin-top:16px;max-width:1200px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:top}
    thead th{background:#f5f5f5;position:sticky;top:0;z-index:2}
    thead tr.filters th{background:#fafafa;top:41px;z-index:1}
    .num{text-align:right; font-variant-numeric: tabular-nums;}
    .click{cursor:pointer; user-select:none}
    tr.duplicate{background:#ffe5e5}
    tr.newrow{background:#e9f7ff}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#f2f2f2}
    .totals{margin-top:12px;border:1px solid #ddd;border-radius:12px;padding:12px;max-width:1200px}
    .totals b{font-size:16px}
    .danger{background:#fff0f0;border:1px solid #ffd2d2}
    .thin{padding:6px;font-size:13px;width:100%;box-sizing:border-box}
    .w-id{width:80px}
    .w-date{width:210px}
    .w-amt{width:140px}
    .w-cur{width:110px}
    .w-cat{width:160px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:12px}
    .btn{border:1px solid #ddd;background:#fff;border-radius:10px;padding:8px 10px}
    .btn:hover{background:#f7f7f7}
    .btn.active{border-color:#111}
    details summary{cursor:pointer}
    /* colores suaves por categoría */
    .cat-coffee{background:#fff3e6}
    .cat-food{background:#eaffea}
    .cat-transport{background:#eaf2ff}
    .cat-groceries{background:#f0fff5}
    .cat-shopping{background:#f7efff}
    .cat-other{background:#f5f5f5}
  </style>
</head>
<body>

  <div class="topbar">
    <div>
      <h1 style="margin:0 0 6px 0">Registro Gastos</h1>
      <div class="muted">Filtros en cabecera. Click en el título para ordenar. Intervalo de fechas arriba.</div>
    </div>

    <div class="right">
      <button class="btn" id="btnToday" onclick="setQuickRange('today')">Today</button>
      <button class="btn" id="btnWeek" onclick="setQuickRange('week')">Last week</button>
      <button class="btn" id="btnMonth" onclick="setQuickRange('month')">Last month</button>
      <button class="btn" id="btnYtd" onclick="setQuickRange('ytd')">This year</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button onclick="refreshAll()">Recargar</button>
        <button class="danger" id="btnDelete" onclick="deleteSelected()" disabled>Borrar seleccionado</button>
        <span class="muted">Seleccionado: <span id="selLabel">ninguno</span></span>
        <span id="status" class="muted">Listo.</span>
      </div>

      <div class="row">
        <label class="muted"><b>Desde</b></label>
        <input id="dateFrom" type="date" onchange="render()"/>
        <label class="muted"><b>Hasta</b></label>
        <input id="dateTo" type="date" onchange="render()"/>
        <button class="btn" onclick="clearDateRange()">Quitar fechas</button>
      </div>
    </div>

    <details style="margin-top:10px">
      <summary class="muted"><b>Settings</b> (user / api key)</summary>
      <div class="row" style="margin-top:10px">
        <label><b>User</b></label>
        <input id="user" placeholder="userid" value="pedro"/>
        <label><b>API key</b></label>
        <input id="key" placeholder="api_key" value="ElPortichuelo99" style="min-width:220px"/>
        <span class="muted">Solo necesario para borrar (y endpoints protegidos).</span>
      </div>
    </details>
  </div>

  <div class="totals">
    <b>Resumen (filtrado)</b>
    <div class="row" style="margin-top:8px">
      <span class="pill">Filas: <span id="sumCount">0</span></span>
      <span class="pill">Total KWD: <span id="sumKwd">0.000</span></span>
      <button onclick="clearFilters()">Limpiar filtros</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th class="w-id click" onclick="toggleSort('id')">ID <span id="sort_id"></span></th>
        <th class="w-date click" onclick="toggleSort('date')">Fecha <span id="sort_date"></span></th>
        <th class="w-amt click" onclick="toggleSort('amount')">Importe <span id="sort_amount"></span></th>
        <th class="w-cur">Moneda</th>
        <th>Comercio</th>
        <th class="w-cat">Categoría</th>
      </tr>

      <!-- filtros dentro de la tabla (sin fecha, sin min/max) -->
      <tr class="filters">
        <th class="w-id">
          <input id="fId" class="thin" placeholder="id..." oninput="render()"/>
        </th>
        <th class="w-date">
          <!-- eliminado filtro fecha aquí -->
          <span class="muted" style="font-size:12px">Usa “Desde/Hasta” arriba</span>
        </th>
        <th class="w-amt">
          <span class="muted" style="font-size:12px">—</span>
        </th>
        <th class="w-cur">
          <select id="fCur" class="thin" onchange="render()">
            <option value="KWD">KWD</option>
          </select>
        </th>
        <th>
          <input id="fMerchant" class="thin" placeholder="buscar comercio..." oninput="render()"/>
        </th>
        <th class="w-cat">
          <select id="fCat" class="thin" onchange="render()">
            <option value="">Todas</option>
          </select>
        </th>
      </tr>
    </thead>

    <tbody id="tbody"></tbody>
  </table>

<script>
let ALL = [];
let SORT = { field: "date", dir: "desc" }; // date desc default

function setStatus(text, cls){
  const el = document.getElementById('status');
  el.className = cls || "muted";
  el.textContent = text;
}

function fmtAmt(a){
  if(a === null || a === undefined || Number.isNaN(Number(a))) return "";
  return Number(a).toFixed(3);
}

function fmtDate(s){
  if(!s) return "";
  return String(s).replace("T"," ").replace("+00:00","").slice(0,16);
}

function catClass(cat){
  const c = (cat || "other").toLowerCase();
  if(c === "coffee") return "cat-coffee";
  if(c === "food") return "cat-food";
  if(c === "transport") return "cat-transport";
  if(c === "groceries") return "cat-groceries";
  if(c === "shopping") return "cat-shopping";
  return "cat-other";
}

function getDupId(){ return localStorage.getItem("last_duplicate_id"); }
function getNewId(){ return localStorage.getItem("last_new_id"); }
function setNewId(id){
  if(id === null || id === undefined) localStorage.removeItem("last_new_id");
  else localStorage.setItem("last_new_id", String(id));
}

function getSelectedId(){ return localStorage.getItem("selected_row_id"); }
function setSelectedId(id){
  if(id === null || id === undefined) localStorage.removeItem("selected_row_id");
  else localStorage.setItem("selected_row_id", String(id));
  updateSelectedUI();
}

function updateSelectedUI(){
  const id = getSelectedId();
  document.getElementById("selLabel").textContent = id ? id : "ninguno";
  document.getElementById("btnDelete").disabled = !id;
}

async function fetchAll(){
  const user = (document.getElementById('user')?.value || "pedro").trim();
  const url = user
    ? `/expenses?user_id=${encodeURIComponent(user)}&limit=2000`
    : `/expenses?limit=2000`;

  const res = await fetch(url);
  const data = await res.json();
  ALL = data.expenses || [];
}

function populateCategorySelect(){
  const sel = document.getElementById("fCat");
  const current = sel.value;
  const cats = Array.from(new Set(ALL.map(e => (e.category || "other")))).sort();
  sel.innerHTML = `<option value="">Todas</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join("");
  sel.value = cats.includes(current) ? current : "";
}

function parseISODateOnly(isoStr){
  // isoStr: "2026-02-02T06:31:00+00:00" -> "2026-02-02"
  if(!isoStr) return "";
  return String(isoStr).slice(0,10);
}

function withinDateRange(e){
  const from = document.getElementById("dateFrom").value; // yyyy-mm-dd
  const to = document.getElementById("dateTo").value;     // yyyy-mm-dd
  if(!from && !to) return true;

  const d = parseISODateOnly(e.created_at);
  if(!d) return false;

  if(from && d < from) return false;
  if(to && d > to) return false;
  return true;
}

function applyFilters(){
  const fId = document.getElementById("fId").value.trim();
  const fCur = document.getElementById("fCur").value;
  const fMerchant = document.getElementById("fMerchant").value.trim().toLowerCase();
  const fCat = document.getElementById("fCat").value;

  return ALL.filter(e => {
    if(fId){
      if(String(e.id) !== fId) return false;
    }
    if(fCur && (e.currency || "") !== fCur) return false;
    if(fCat && (e.category || "other") !== fCat) return false;

    if(fMerchant){
      const m = (e.merchant_clean || "").toLowerCase();
      if(!m.includes(fMerchant)) return false;
    }

    if(!withinDateRange(e)) return false;

    return true;
  });
}

function sortRows(rows){
  const copy = [...rows];
  const field = SORT.field;
  const dir = SORT.dir;

  const cmpText = (a,b) => String(a||"").localeCompare(String(b||""));
  const cmpNum  = (a,b) => (Number(a||0) - Number(b||0));

  copy.sort((ra, rb) => {
    let v = 0;
    if(field === "id") v = cmpNum(ra.id, rb.id);
    else if(field === "amount") v = cmpNum(ra.amount, rb.amount);
    else v = cmpText(ra.created_at, rb.created_at); // date
    return dir === "asc" ? v : -v;
  });

  return copy;
}

function updateSortIndicators(){
  document.getElementById("sort_id").textContent = SORT.field==="id" ? (SORT.dir==="asc"?"↑":"↓") : "";
  document.getElementById("sort_date").textContent = SORT.field==="date" ? (SORT.dir==="asc"?"↑":"↓") : "";
  document.getElementById("sort_amount").textContent = SORT.field==="amount" ? (SORT.dir==="asc"?"↑":"↓") : "";
}

function toggleSort(field){
  if(SORT.field === field){
    SORT.dir = (SORT.dir === "asc") ? "desc" : "asc";
  }else{
    SORT.field = field;
    SORT.dir = (field === "date") ? "desc" : "asc";
  }
  updateSortIndicators();
  render();
}

function setActiveQuickButton(kind){
  const ids = ["btnToday","btnWeek","btnMonth","btnYtd"];
  ids.forEach(id => document.getElementById(id).classList.remove("active"));
  if(kind === "today") document.getElementById("btnToday").classList.add("active");
  if(kind === "week") document.getElementById("btnWeek").classList.add("active");
  if(kind === "month") document.getElementById("btnMonth").classList.add("active");
  if(kind === "ytd") document.getElementById("btnYtd").classList.add("active");
}

function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function addDaysISO(baseISO, delta){
  const d = new Date(baseISO + "T00:00:00");
  d.setDate(d.getDate() + delta);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function setQuickRange(kind){
  const t = todayISO();
  const fromEl = document.getElementById("dateFrom");
  const toEl = document.getElementById("dateTo");

  if(kind === "today"){
    fromEl.value = t;
    toEl.value = t;
  }else if(kind === "week"){
    fromEl.value = addDaysISO(t, -6); // últimos 7 días (incluye hoy)
    toEl.value = t;
  }else if(kind === "month"){
    fromEl.value = addDaysISO(t, -29); // últimos 30 días (incluye hoy)
    toEl.value = t;
  }else if(kind === "ytd"){
    fromEl.value = `${new Date().getFullYear()}-01-01`;
    toEl.value = t;
  }
  setActiveQuickButton(kind);
  render();
}

function clearDateRange(){
  document.getElementById("dateFrom").value = "";
  document.getElementById("dateTo").value = "";
  setActiveQuickButton(null);
  render();
}

function clearFilters(){
  document.getElementById("fId").value = "";
  document.getElementById("fCur").value = "KWD";
  document.getElementById("fMerchant").value = "";
  document.getElementById("fCat").value = "";
  clearDateRange();
  SORT = { field: "date", dir: "desc" };
  updateSortIndicators();
  render();
}

function render(){
  updateSortIndicators();

  const dupId = getDupId();
  const newId = getNewId();
  const selectedId = getSelectedId();

  const filtered = sortRows(applyFilters());

  // Totales (solo KWD)
  let sumKwd = 0;
  for(const e of filtered){
    if(e.currency === "KWD") sumKwd += Number(e.amount || 0);
  }
  document.getElementById("sumCount").textContent = String(filtered.length);
  document.getElementById("sumKwd").textContent = sumKwd.toFixed(3);

  const tb = document.getElementById('tbody');
  tb.innerHTML = "";

  for(const e of filtered){
    const tr = document.createElement('tr');
    tr.classList.add(catClass(e.category));

    if(dupId && String(e.id) === dupId) tr.classList.add("duplicate");
    if(newId && String(e.id) === newId) tr.classList.add("newrow");

    if(selectedId && String(e.id) === selectedId){
      tr.style.outline = "2px solid #111";
      tr.style.outlineOffset = "-2px";
    }

    tr.innerHTML = `
      <td class="click" title="Click para seleccionar">${e.id}</td>
      <td>${fmtDate(e.created_at)}</td>
      <td class="num">${fmtAmt(e.amount)}</td>
      <td>${e.currency || ""}</td>
      <td>${e.merchant_clean || ""}</td>
      <td><span class="badge">${e.category || "other"}</span></td>
    `;

    tr.addEventListener("click", () => {
      setSelectedId(e.id);
      render();
    });

    tb.appendChild(tr);
  }

  setTimeout(() => setNewId(null), 600);
  updateSelectedUI();
}

async function refreshAll(){
  setStatus("Cargando...", "muted");
  await fetchAll();
  populateCategorySelect();
  render();
  setStatus("Listo.", "muted");
}

async function deleteSelected(){
  const id = getSelectedId();
  const apiKey = (document.getElementById('key')?.value || "").trim();
  if(!id) return;

  if(!apiKey){
    setStatus("Falta API key (Settings).", "err");
    return;
  }

  const ok = confirm(`¿Seguro que quieres borrar el gasto con id ${id}?`);
  if(!ok) return;

  setStatus(`Borrando id ${id}...`, "muted");

  try{
    const res = await fetch(`/expenses/${encodeURIComponent(id)}?api_key=${encodeURIComponent(apiKey)}`, {
      method: "DELETE"
    });
    const data = await res.json();

    if(data.deleted === 1){
      setStatus(`Borrado ✅ (id ${id})`, "ok");
      setSelectedId(null);
      await refreshAll();
    }else{
      setStatus(`No se ha borrado (id ${id}).`, "warn");
    }
  }catch(e){
    setStatus("Error borrando.", "err");
  }
}

updateSelectedUI();
refreshAll();
</script>
</body>
</html>
