<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro Gastos</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#111b27; --text:#e6edf3; --muted:#93a4b8;
      --line:rgba(255,255,255,.10);
      --chip:rgba(255,255,255,.06);
      --danger:#ff5c66; --ok:#3ddc97;
      --accent:#7aa2ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#ffffff; --panel:#f6f7f9; --panel2:#ffffff; --text:#0b1220; --muted:#516074;
      --line:rgba(0,0,0,.10);
      --chip:rgba(0,0,0,.06);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{display:flex; align-items:center; gap:10px;}
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .pill{
      border:1px solid var(--line); background:var(--chip); padding:6px 10px; border-radius:999px;
      color:var(--muted); font-size:12px;
    }
    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}

    .btn{
      border:1px solid var(--line); background:var(--panel2); color:var(--text);
      padding:8px 10px; border-radius:10px; cursor:pointer; box-shadow:none;
      font-size:13px;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(122,162,255,.35); background:rgba(122,162,255,.12)}
    .btn.danger{border-color:rgba(255,92,102,.35); background:rgba(255,92,102,.10)}
    .btn.ghost{background:transparent}
    .iconbtn{width:40px; display:inline-flex; align-items:center; justify-content:center}

    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:12px;
      box-shadow:var(--shadow);
    }
    .ctrl{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .ctrl label{font-size:12px; color:var(--muted); margin-right:2px;}
    select, input[type="date"], input[type="text"]{
      border:1px solid var(--line); background:var(--panel2); color:var(--text);
      padding:8px 10px; border-radius:10px; font-size:13px; outline:none;
    }
    select:focus, input:focus{border-color:rgba(122,162,255,.45)}
    .spacer{flex:1}

    .balance{position:relative;}
    .dropdown{
      position:absolute; right:0; top:44px; z-index:20;
      min-width:230px;
      border:1px solid var(--line); background:var(--panel2);
      border-radius:14px; box-shadow:var(--shadow);
      padding:10px;
      display:none;
    }
    .dropdown.open{display:block}
    .brow{display:flex; align-items:center; justify-content:space-between; padding:8px 8px; border-radius:10px;}
    .brow:hover{background:var(--chip)}
    .brow b{font-weight:700}
    .pos{color:var(--ok); font-weight:700}
    .neg{color:var(--danger); font-weight:700}

    .tablewrap{
      margin-top:14px;
      border:1px solid var(--line); background:var(--panel);
      border-radius:14px; box-shadow:var(--shadow);
    }
    table{width:100%; border-collapse:collapse; table-layout:fixed}
    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      padding:12px 12px; border-bottom:1px solid var(--line);
      user-select:none; cursor:pointer;
      white-space:nowrap;
    }
    thead th.selcol{cursor:default}
    tbody td{
      padding:10px 12px; border-bottom:1px solid var(--line);
      font-size:13px; vertical-align:middle;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    [data-theme="light"] tbody tr:hover{background:rgba(0,0,0,.03)}

    .amt{text-align:right; font-variant-numeric: tabular-nums}
    .curcell{display:flex; align-items:center; justify-content:center; gap:8px}
    .flag{display:inline-flex; width:18px}
    .flag svg{width:16px; height:12px; border-radius:3px; display:block}

    .catSel, .merchantEdit{
      width:100%;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      padding:6px 8px;
      border-radius:10px;
    }
    .merchantEdit:hover{background:var(--chip)}
    .merchantEdit:focus{outline:none; border-color:rgba(122,162,255,.45); background:var(--panel2)}

    .small{font-size:12px; color:var(--muted)}
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--panel2);
      display:none;
      align-items:center; justify-content:space-between; gap:10px;
    }
    .toast.show{display:flex}
    .err{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,92,102,.35);
      background:rgba(255,92,102,.10);
      color:#ffb4b4;
      display:none;
      white-space:pre-wrap;
    }
    .err.show{display:block}

    .sortHint{opacity:.6; margin-left:6px; font-size:11px}

    .kpiRow{
      display:none;
      margin-top:12px;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap:10px;
    }
    .kpiRow.show{display:grid}
    .kpi{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:14px;
      padding:12px;
      box-shadow:var(--shadow);
    }
    .kpi .v{font-size:18px; font-weight:800; margin-top:6px}

    /* ===== Row selection checkboxes ===== */
    th.selcol, td.selcol { width: 44px; text-align: center; }
    .cbRow, #cbAll{
      width: 16px; height: 16px; cursor: pointer;
      accent-color: var(--accent);
    }
    td.selcol .cbRow { opacity: 0; transition: opacity .12s ease; }
    tbody tr:hover td.selcol .cbRow { opacity: 1; }
    td.selcol .cbRow:checked { opacity: 1; }
    th.selcol #cbAll { opacity: 1; }

    tr.selected-row { outline: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.05); }
    [data-theme="light"] tr.selected-row { outline: 1px solid rgba(0,0,0,.14); background: rgba(0,0,0,.04); }
  
/* ===== Dropdown readability fix (native selects) ===== */
:root { color-scheme: dark; }
[data-theme="light"] { color-scheme: light; }

/* The CLOSED select control (always fixable) */
select, input[type="date"], input[type="text"]{
  color: var(--text);
  background: var(--panel2);
}

/* Hint to browsers to render native dropdown menus with dark palette */
select{ color-scheme: dark; }
[data-theme="light"] select{ color-scheme: light; }

/* Some browsers use system colors for the popout list; this helps where supported */
option{ color: var(--text); background: var(--panel2); }

/* If the OS forces light popups, at least make the select itself readable */
select:focus{ border-color: rgba(122,162,255,.45); }



/* ===== AUTO-REFRESH PATCH: TABLE UX ===== */

/* Sin scroll interno: el scroll es de la p√°gina */
.tablewrap{
  overflow: visible;
  max-height: none;
}

/* Header sticky */
thead th{
  position: sticky;
  top: 0;
  z-index: 5;
  background: var(--panel);
}

/* En light, fondo coherente */
[data-theme="light"] thead th{
  background: var(--panel);
}


/* ===== Premium UX patch (safe) ===== */

/* Sticky filters bar (sin tocar l√≥gica) */
.row{
  position: sticky;
  top: 10px;
  z-index: 30;
}

/* Evita la "tabla dentro de un cuadro con scroll" */
.tablewrap{
  overflow: visible !important;
  max-height: none !important;
}

/* Si por alg√∫n motivo en tu versi√≥n hab√≠a overflow:auto en alg√∫n wrapper, esto lo mata */
html, body { overflow: auto !important; }

/* Subt√≠tulo del header */
#subtitle{ margin-top:4px; }

/* Dropdowns legibles en dark: el popup del select es del sistema, pero el control s√≠ queda bien */
select, input[type="date"], input[type="text"]{
  color: var(--text);
}

/* ===== Category chips on select (con contraste) ===== */
:root{
  --chipCoffee: rgba(255, 179, 71, .16);
  --chipFood: rgba(61, 220, 151, .14);
  --chipGroceries: rgba(122, 162, 255, .14);
  --chipTransport: rgba(159, 122, 234, .14);
  --chipOther: rgba(255,255,255,.08);
  --chipBorder: rgba(255,255,255,.14);
}
[data-theme="light"]{
  --chipCoffee: rgba(255, 179, 71, .22);
  --chipFood: rgba(61, 220, 151, .18);
  --chipGroceries: rgba(122, 162, 255, .18);
  --chipTransport: rgba(159, 122, 234, .18);
  --chipOther: rgba(0,0,0,.06);
  --chipBorder: rgba(0,0,0,.12);
}
.catSel{
  border:1px solid transparent;
}
.catSel[data-cat="coffee"]{ background: var(--chipCoffee); border-color: var(--chipBorder); }
.catSel[data-cat="food"]{ background: var(--chipFood); border-color: var(--chipBorder); }
.catSel[data-cat="groceries"]{ background: var(--chipGroceries); border-color: var(--chipBorder); }
.catSel[data-cat="transport"]{ background: var(--chipTransport); border-color: var(--chipBorder); }
.catSel[data-cat="other"]{ background: var(--chipOther); border-color: var(--chipBorder); }

/* Roadmap cards */
.roadmap{ margin-top:14px; }
.roadmap h2{ margin:0 0 10px 0; font-size:14px; color:var(--muted); letter-spacing:.2px; }
.rmGrid{
  display:grid;
  grid-template-columns: repeat(3, minmax(220px, 1fr));
  gap:10px;
}
@media (max-width: 900px){
  .rmGrid{ grid-template-columns: 1fr; }
}
.rmCard{
  border:1px solid var(--line);
  background:var(--panel);
  border-radius:14px;
  padding:12px;
  box-shadow:var(--shadow);
}
.rmCard b{ display:block; margin-bottom:6px; }
.rmTag{
  display:inline-flex;
  border:1px solid var(--line);
  background:var(--chip);
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  color:var(--muted);
}


/* ===== FIX: balance dropdown over sticky filters ===== */
.top{ position: relative; z-index: 60; }
.balance{ position: relative; z-index: 2000; }
.balance .dropdown{ z-index: 3000 !important; }
.row{ z-index: 30; } /* por debajo del dropdown */


/* === SETTINGS (gear) + DENSITY === */
.settings{ position:relative; }
#settingsMenu{
  position:absolute; right:0; top:44px; z-index:40;
  min-width:240px;
  border:1px solid var(--line); background:var(--panel2);
  border-radius:14px; box-shadow:var(--shadow);
  padding:10px;
  display:none;
}
#settingsMenu.open{display:block}
.setRow{ padding:8px 8px; border-radius:10px; }
.setRow:hover{ background:var(--chip); }
.setRow .ttl{ font-size:12px; color:var(--muted); margin-bottom:6px; }
.setBtns{ display:flex; gap:8px; flex-wrap:wrap; }
.setBtns .btn{ padding:7px 10px; border-radius:10px; font-size:12px; }
.setBtns .btn.active{ border-color:rgba(122,162,255,.55); background:rgba(122,162,255,.18); }

/* Density behavior (table paddings + row height feeling) */
:root{ --td-pad-y: 10px; --td-pad-x: 12px; --th-pad-y: 12px; }
[data-density="compact"] { --td-pad-y: 6px;  --td-pad-x: 12px; --th-pad-y: 10px; }
[data-density="normal"]  { --td-pad-y: 10px; --td-pad-x: 12px; --th-pad-y: 12px; }
[data-density="comfy"]   { --td-pad-y: 14px; --td-pad-x: 12px; --th-pad-y: 14px; }

thead th{ padding: var(--th-pad-y) var(--td-pad-x) !important; }
tbody td{ padding: var(--td-pad-y) var(--td-pad-x) !important; }


/* === SETTINGS: hide original buttons moved into gear === */
#toggleKpi{ display:none !important; }
#btnExport{ display:none !important; }

/* Rule button: intentamos varios IDs comunes */
#btnRule, #ruleBtn, #ruleButton{ display:none !important; }



/* === STICKY TABLE HEADER (Date/Merchant/...) === */
.tablewrap { overflow: visible !important; } /* evita scroll interno raro */
table thead th{
  position: sticky;
  top: 0;
  z-index: 30;
  background: var(--panel);
}
[data-theme="light"] table thead th{
  background: var(--panel);
}
/* l√≠nea de separaci√≥n m√°s clara cuando est√° sticky */
table thead th{
  box-shadow: 0 1px 0 var(--line);
}
/* por si hay checkbox/columna select a la izquierda */
table thead th:first-child{
  z-index: 31;
}


/* ================================
   STICKY TABLE HEADER
   ================================ */
table thead th {
  position: sticky;
  top: 0;
  z-index: 20;
  background: var(--bg, #0f1115);
}

/* En modo claro */
body.light table thead th {
  background: #ffffff;
}


/* ================================
   STICKY TABLE HEADER
   ================================ */
table thead th {
  position: sticky;
  top: 0;
  z-index: 20;
  background: var(--bg, #0f1115);
}

/* En modo claro */
body.light table thead th {
  background: #ffffff;
}


/* ===== PATCH: Hide Date column (use day headers instead) ===== */
#t thead th:nth-child(2){ display:none !important; }
#t tbody tr:not(.rg-sep) td:nth-child(2){ display:none !important; }

/* Rebalance widths */
#t thead th:nth-child(3), #t tbody td:nth-child(3){ width:56% !important; }  /* Merchant */
#t thead th:nth-child(4), #t tbody td:nth-child(4){ width:18% !important; }  /* Category */
#t thead th:nth-child(5), #t tbody td:nth-child(5){ width:12% !important; }  /* Amount */
#t thead th:nth-child(6), #t tbody td:nth-child(6){ width:14% !important; }  /* Currency */

/* Day separator row */
tr.rg-sep td{
  font-size:12px;
  color:var(--muted);
  background:rgba(255,255,255,.03);
  cursor:pointer;
}


/* ===== Transaction details modal ===== */
.rgModalOverlay{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center;
  z-index:5000;
}
.rgModalOverlay.open{ display:flex; }
.rgModal{
  width:min(720px, calc(100vw - 28px));
  max-height:calc(100vh - 28px);
  overflow:auto;
  border:1px solid var(--line);
  background:var(--panel2);
  border-radius:16px;
  box-shadow:var(--shadow);
}
.rgModalHead{
  display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
  padding:14px 14px 10px 14px;
  border-bottom:1px solid var(--line);
}
.rgModalTitle{
  margin:0; font-size:15px; font-weight:600; letter-spacing:.2px;
}
.rgModalSub{
  margin-top:6px; font-size:12px; color:var(--muted);
}
.rgModalClose{
  border:1px solid var(--line);
  background:transparent;
  color:var(--text);
  width:38px; height:38px;
  border-radius:12px;
  cursor:pointer;
}
.rgModalBody{ padding:14px; }
.rgGrid{
  display:grid;
  grid-template-columns: 150px 1fr;
  gap:10px 12px;
}
@media (max-width: 520px){
  .rgGrid{ grid-template-columns: 1fr; }
}
.rgK{ font-size:12px; color:var(--muted); }
.rgV{ font-size:13px; color:var(--text); }
.rgBig{
  margin-top:12px;
  padding:12px;
  border:1px solid var(--line);
  background:var(--panel);
  border-radius:14px;
  font-size:13px;
  white-space:pre-wrap;
  word-break:break-word;
  line-height:1.35;
}
.rgPills{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.rgPill{
  border:1px solid var(--line);
  background:var(--chip);
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  color:var(--muted);
}

</style>

<!-- AUTO-REFRESH COMPLETELY DISABLED: manual refresh only -->
</head>

<body>
<div class="wrap" id="app">
  <div class="top">
    <div class="title">
      <div>
        <h1>Expense Tracker</h1>
        <div class="small" id="subtitle">Personal finance dashboard</div>
      </div>
      <div class="pill" id="statusPill">loading‚Ä¶</div>
      <button class="btn ghost" id="toggleKpi">KPIs</button>
    </div>

    <div class="right">
      <button class="btn iconbtn" id="themeBtn" title="Tema">
        <span id="themeIcon">üåô</span>
      </button>
      <div class="settings">
        <button class="btn iconbtn" id="settingsBtn" title="Settings">
          <span id="settingsIcon">‚öôÔ∏è</span>
        </button>
        <div class="dropdown" id="settingsMenu">
          
          <div class="setRow" id="quickActions">
            <div class="ttl"><b>Quick actions</b></div>
            <div class="setBtns">
              <button class="btn" id="qaKpi" type="button">KPIs</button>
              <button class="btn" id="qaRule" type="button">Rule</button>
              <button class="btn" id="qaCsv" type="button">Export CSV</button>
              <button class="btn" id="qaRefresh" type="button">üîÑ Refresh</button>
              <button class="btn" id="qaSortDate" type="button">üìÖ Sort by date</button>
            </div>
          </div>
<div class="setRow">
            <div class="ttl"><b>Row density</b></div>
            <div class="setBtns">
              <button class="btn" id="densCompact" type="button">Compact</button>
              <button class="btn" id="densNormal" type="button">Normal</button>
              <button class="btn" id="densComfy" type="button">Comfortable</button>
            </div>
          </div>
        </div>
      </div>


      <div class="balance">
        <button class="btn primary" id="balanceBtn">Balance</button>
        <div class="dropdown" id="balanceMenu">
          
          
          
          
          
        <div class="brow"><b><span class="flag" data-cur="KWD"></span> KWD</b><span id="balKWD" class="small">‚Äî</span></div>
          <div class="brow"><b><span class="flag" data-cur="USD"></span> USD</b><span id="balUSD" class="small">‚Äî</span></div>
          <div class="brow"><b><span class="flag" data-cur="EUR"></span> EUR</b><span id="balEUR" class="small">‚Äî</span></div>
          <div class="brow"><b><span class="flag" data-cur="AED"></span> AED</b><span id="balAED" class="small">‚Äî</span></div>
          <div class="brow" style="border-top:1px solid var(--line); margin-top:8px; padding-top:10px;"><b>Total (EUR)</b><span id="balTotalEUR" class="small">‚Äî</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="ctrl">
      <label>Currency</label>
      <select id="curFilter"></select>
    </div>
    <div class="ctrl">
      <label>Category</label>
      <select id="catFilter"></select>
    </div>
    <div class="ctrl">
      <label>From</label>
      <input type="date" id="dateFrom">
    </div>
    <div class="ctrl">
      <label>To</label>
      <input type="date" id="dateTo">
    </div>

    <div class="ctrl">
      <button class="btn" id="btnToday">Today</button>
      <button class="btn" id="btnWeek">Last week</button>
      <button class="btn" id="btnMonth">Last month</button>
      <button class="btn" id="btnYear">This year</button>
      <button class="btn" id="btnClear">Clear</button>
    </div>

    <div class="spacer"></div>

    <div class="ctrl">
      <button class="btn danger" id="btnDelete" disabled>Delete selected</button>
      <button class="btn" id="btnExport">Export CSV</button>
      <button class="btn" id="btnRule">Rule</button>
    </div>
  </div>

  <div class="kpiRow" id="kpiRow">
    <div class="kpi"><div class="small">Total (filtered)</div><div class="v" id="kpiTotal">‚Äî</div></div>
    <div class="kpi"><div class="small">Today</div><div class="v" id="kpiToday">‚Äî</div></div>
    <div class="kpi"><div class="small">Avg / day</div><div class="v" id="kpiAvg">‚Äî</div></div>
    <div class="kpi"><div class="small">Top category</div><div class="v" id="kpiTopCat">‚Äî</div></div>
  </div>

  <div class="err" id="errBox"></div>

  <div class="toast" id="toast">
    <div id="toastMsg">Deleted.</div>
    <button class="btn" id="btnUndo">Undo (10s)</button>
  </div>

  <div class="tablewrap">
    <table id="t">
      <thead>
        <tr>
          <th class="selcol"><input type="checkbox" id="cbAll" title="Select all"></th>
          <th data-sort="created_at">Date <span class="sortHint" id="sortHintDate"></span></th>
          <th data-sort="merchant_clean">Merchant</th>
          <th data-sort="category">Category</th>
          <th data-sort="amount" style="text-align:right">Amount</th>
          <th data-sort="currency" style="text-align:center">Currency</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- RULE MODAL -->
  <div id="ruleModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999;">
    <div style="max-width:520px; margin:90px auto; background:var(--panel2); border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); padding:14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-weight:800;">Create rule</div>
        <button class="btn ghost" id="ruleClose" title="Close">‚úï</button>
      </div>

      <div style="margin-top:10px; display:grid; gap:10px;">
        <div>
          <div class="small" style="margin-bottom:6px;">Merchant (pattern, contains)</div>
          <input id="ruleMerchant" type="text" placeholder="e.g. starb, talabat, uber‚Ä¶" style="width:100%;" />
        </div>

        <div>
          <div class="small" style="margin-bottom:6px;">Category</div>
          <select id="ruleCategory" style="width:100%;"></select>
          <div class="small" style="margin-top:6px; opacity:.9;">Tip: puedes escribir una nueva categor√≠a desde la tabla y luego saldr√° aqu√≠.</div>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px;">
          <button class="btn" id="ruleCancel">Cancel</button>
          
            <div style="margin-top:10px;padding:10px;border:1px solid var(--line);background:var(--chip);border-radius:12px;">
              <div class="small"><b>Rule preview</b></div>
              <div class="small" id="rulePreviewText">Matches in current table: ‚Äî</div>
            </div>
<button class="btn primary" id="ruleSave">Save rule</button>
        </div>

        <div class="small" id="ruleStatus" style="min-height:18px;"></div>
      </div>
    </div>
  </div>

</div>


  <div class="roadmap" id="roadmap">
    <h2>Roadmap</h2>
    <div class="rmGrid">
      <div class="rmCard">
        <b>Insights</b>
        <div class="small">Month-over-month changes, recurring merchants, top categories.</div>
        <div style="margin-top:10px;"><span class="rmTag">Planned</span></div>
      </div>
      <div class="rmCard">
        <b>Currency conversion</b>
        <div class="small">Optional FX view (KWD ‚Üí EUR/USD) for reporting.</div>
        <div style="margin-top:10px;"><span class="rmTag">Planned</span></div>
      </div>
      <div class="rmCard">
        <b>Subscriptions</b>
        <div class="small">Detect repeated charges and show a ‚Äúsubscriptions‚Äù section.</div>
        <div style="margin-top:10px;"><span class="rmTag">Planned</span></div>
      </div>
    </div>
  </div>

<script>
  // =============== CONFIG ===============
  const USER_ID = "pedro";
  const API_KEY = "ElPortichuelo99";
  const LIMIT = 500;

  // =============== FLAGS (SVG) ===============
  function flagHTML(cur){
    const c = String(cur||"").toUpperCase();
    const KUWAIT = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#fff"/>
      <rect width="16" height="4" y="0" fill="#0B7A3B"/>
      <rect width="16" height="4" y="8" fill="#C8102E"/>
      <path d="M0 0h5L8 6 5 12H0z" fill="#000"/>
    </svg>`;
    const USA = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#fff"/>
      <g fill="#B22234">
        <rect y="0" width="16" height="1"/>
        <rect y="2" width="16" height="1"/>
        <rect y="4" width="16" height="1"/>
        <rect y="6" width="16" height="1"/>
        <rect y="8" width="16" height="1"/>
        <rect y="10" width="16" height="1"/>
      </g>
      <rect width="7" height="5" fill="#3C3B6E"/>
      <g fill="#fff" opacity=".9">
        <circle cx="1.2" cy="1" r=".25"/><circle cx="2.4" cy="1" r=".25"/><circle cx="3.6" cy="1" r=".25"/><circle cx="4.8" cy="1" r=".25"/><circle cx="6.0" cy="1" r=".25"/>
        <circle cx="1.8" cy="2" r=".25"/><circle cx="3.0" cy="2" r=".25"/><circle cx="4.2" cy="2" r=".25"/><circle cx="5.4" cy="2" r=".25"/>
        <circle cx="1.2" cy="3" r=".25"/><circle cx="2.4" cy="3" r=".25"/><circle cx="3.6" cy="3" r=".25"/><circle cx="4.8" cy="3" r=".25"/><circle cx="6.0" cy="3" r=".25"/>
        <circle cx="1.8" cy="4" r=".25"/><circle cx="3.0" cy="4" r=".25"/><circle cx="4.2" cy="4" r=".25"/><circle cx="5.4" cy="4" r=".25"/>
      </g>
    </svg>`;
    const EU = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#003399"/>
      <g fill="#FFCC00">
        <circle cx="8" cy="2.1" r=".35"/>
        <circle cx="10.2" cy="2.7" r=".35"/>
        <circle cx="11.8" cy="4.3" r=".35"/>
        <circle cx="12.4" cy="6.0" r=".35"/>
        <circle cx="11.8" cy="7.7" r=".35"/>
        <circle cx="10.2" cy="9.3" r=".35"/>
        <circle cx="8" cy="9.9" r=".35"/>
        <circle cx="5.8" cy="9.3" r=".35"/>
        <circle cx="4.2" cy="7.7" r=".35"/>
        <circle cx="3.6" cy="6.0" r=".35"/>
        <circle cx="4.2" cy="4.3" r=".35"/>
        <circle cx="5.8" cy="2.7" r=".35"/>
      </g>
    </svg>`;
    const UAE = `<svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="12" fill="#fff"/>
      <rect x="4" y="0" width="12" height="4" fill="#00732F"/>
      <rect x="4" y="4" width="12" height="4" fill="#fff"/>
      <rect x="4" y="8" width="12" height="4" fill="#000"/>
      <rect x="0" y="0" width="4" height="12" fill="#FF0000"/>
    </svg>`;
    if(c==="KWD") return KUWAIT;
    if(c==="USD") return USA;
    if(c==="EUR") return EU;
    if(c==="AED") return UAE;
    return "";
  }
  function initFlags(){
    document.querySelectorAll(".flag[data-cur]").forEach(el=>{
      el.innerHTML = flagHTML(el.getAttribute("data-cur"));
    });
  }

  // =============== HELPERS ===============
  const $ = (id)=>document.getElementById(id);
  function setStatus(txt){ $("statusPill").textContent = txt; }
  function showErr(msg){
    const b = $("errBox");
    b.textContent = String(msg||"");
    b.classList.toggle("show", !!msg);
  }
  function api(url){
    const u = new URL(url, window.location.origin);
    return u.pathname + u.search;
  }
  function apiKey(url){
    const u = new URL(url, window.location.origin);
    u.searchParams.set("api_key", API_KEY);
    return u.pathname + u.search;
  }
  async function getJSON(url){
    const r = await fetch(api(url));
    const j = await r.json();
    return j;
  }
  async function postJSON(url, body){
    const r = await fetch(apiKey(url), {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body||{})
    });
    const t = await r.text().catch(()=> "");
    if(!r.ok) throw new Error(`${url} => HTTP ${r.status} :: ${t}`);
    try{ return JSON.parse(t); }catch(_){ return {ok:true}; }
  }
  function titleCase(x){
    x = String(x||"").trim();
    if(!x) return "";
    return x.charAt(0).toUpperCase() + x.slice(1);
  }
  
function isoDay(s){ return (s||"").slice(0,10); }

// ===== DATE (ENGLISH) =====
function enOrdinal(n){
  const v = n % 100;
  if(v>=11 && v<=13) return n+"th";
  switch(n % 10){
    case 1: return n+"st";
    case 2: return n+"nd";
    case 3: return n+"rd";
    default: return n+"th";
  }
}
function formatDateEnglishISO(iso10){
  if(!iso10 || iso10.length<10) return iso10;
  const y = Number(iso10.slice(0,4));
  const m = Number(iso10.slice(5,7));
  const d = Number(iso10.slice(8,10));
  if(!y || !m || !d) return iso10;
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  return `${enOrdinal(d)} ${months[m-1]} ${y}`;
}

  function fmtMoney(n){
    if(n===null||n===undefined||n==="") return "";
    const v = Number(n);
    if(Number.isNaN(v)) return String(n);
    return v.toFixed(3);
  }
  function inferDirection(row){
    const d = (row.direction||"").toLowerCase();
    if(d==="income" || d==="in" || d==="credit" || d==="credited") return "in";
    if(d==="expense" || d==="out" || d==="debit" || d==="debited") return "out";
    const sms = (row.sms||row.sms_raw||"").toLowerCase();
    if(sms.includes("credited")) return "in";
    if(sms.includes("debited")) return "out";
    return "out";
  }

  // =============== STATE ===============
  const state = {
    all: [],
    view: [],
    sortKey: "created_at",
    sortDir: "desc",
    categories: new Set(),
    currencies: new Set(),
    undoTimer: null,
    selected: new Set()
  };

  // =============== THEME ===============
  function setTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem("theme", t);
    $("themeIcon").textContent = (t==="light") ? "‚òÄÔ∏è" : "üåô";
  }
  function initTheme(){
    const t = localStorage.getItem("theme") || "dark";
    setTheme(t);
  }

  // =============== FILTERS ===============
  function buildFilters(){
    const curSel = $("curFilter");
    const curs = Array.from(state.currencies).sort();
    curSel.innerHTML = `<option value="">All currencies</option>` + curs.map(c=>`<option value="${c}">${c}</option>`).join("");

    const catSel = $("catFilter");
    const cats = Array.from(state.categories).sort();
    catSel.innerHTML = `<option value="">All categories</option>` + cats.map(c=>`<option value="${c}">${titleCase(c)}</option>`).join("");
  }

  function applyFilters(){
    const cur = $("curFilter").value || "";
    const cat = $("catFilter").value || "";
    const df = $("dateFrom").value || "";
    const dt = $("dateTo").value || "";

    state.view = state.all.filter(r=>{
      if(cur && (r.currency||"")!==cur) return false;
      if(cat && (r.category||"")!==cat) return false;

      if(df || dt){
        const d = isoDay(r.created_at || r.date_iso || r.date_raw || "");
        if(df && d && d < df) return false;
        if(dt && d && d > dt) return false;
      }
      return true;
    });

    sortView();
    render();
  }

  function setQuickRange(mode){
    const today = new Date();
    const iso = (d)=> d.toISOString().slice(0,10);
    const to = iso(today);
    let from = "";
    if(mode==="today"){
      from = to;
    }else if(mode==="week"){
      const d = new Date(today); d.setDate(d.getDate()-7);
      from = iso(d);
    }else if(mode==="month"){
      const d = new Date(today); d.setMonth(d.getMonth()-1);
      from = iso(d);
    }else if(mode==="year"){
      const d = new Date(today); d.setMonth(0); d.setDate(1);
      from = iso(d);
    }
    $("dateFrom").value = from;
    $("dateTo").value = to;
    applyFilters();
  }

  function clearFilters(){
    $("curFilter").value = "";
    $("catFilter").value = "";
    $("dateFrom").value = "";
    $("dateTo").value = "";
    applyFilters();
  }

  // =============== SORT ===============
  function sortView(){
    const k = state.sortKey;
    const dir = state.sortDir === "asc" ? 1 : -1;
    state.view.sort((a,b)=>{
      let av = a[k], bv = b[k];
      if(k==="amount"){
        av = Number(av||0); bv = Number(bv||0);
      }else{
        av = String(av||""); bv = String(bv||"");
      }
      if(av < bv) return -1*dir;
      if(av > bv) return  1*dir;
      return 0;
    });
    $("sortHintDate").textContent = (state.sortKey==="created_at") ? (state.sortDir==="asc"?"‚Üë":"‚Üì") : "";
  }

  // =============== BALANCE + KPI ===============
  // ===== FX (live total in EUR) =====
  const __rgFx = { ts: 0, rates: null };

  async function __rgGetFxRatesEUR(){
    const now = Date.now();
    // cache 10 min
    if(__rgFx.rates && (now - __rgFx.ts) < 10*60*1000) return __rgFx.rates;

    // 1) Fuente principal: fawazahmed0 currency-api (incluye KWD/AED)
    const urls = [
      "https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/eur.json",
      "https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@1/latest/currencies/eur.json",
      "https://api.frankfurter.app/latest?base=EUR&symbols=USD,KWD,AED",
      "https://api.exchangerate-api.com/v4/latest/EUR"
    ];

    let lastErr = null;

    for(const url of urls){
      try{
        const r = await fetch(url, { cache: "no-store" });
        if(!r.ok) throw new Error(`FX HTTP ${r.status}`);
        const j = await r.json();

        // fawaz: { date: "...", eur: { usd:..., kwd:..., aed:... } }
        if(j && j.eur){
          const eur = j.eur;
          const rates = {
            USD: eur.usd,
            KWD: eur.kwd,
            AED: eur.aed
          };
          if(rates.USD && rates.KWD && rates.AED){
            __rgFx.rates = rates;
            __rgFx.ts = now;
            return rates;
          }
        }

        // frankfurter: { rates: { USD:..., KWD:..., AED:... } }
        if(j && j.rates){
          const rates = j.rates;
          if(rates.USD && rates.KWD && rates.AED){
            __rgFx.rates = rates;
            __rgFx.ts = now;
            return rates;
          }
        }

        // exchangerate-api: { rates: { USD:..., KWD:..., AED:... } }
        if(j && j.rates){
          const rates = j.rates;
          if(rates.USD && rates.KWD && rates.AED){
            __rgFx.rates = rates;
            __rgFx.ts = now;
            return rates;
          }
        }

        throw new Error("FX: missing rates");
      }catch(e){
        lastErr = e;
      }
    }

    throw lastErr || new Error("FX error");
  }

  function __rgToEUR(amount, cur, rates){
    cur = String(cur||"").toUpperCase();
    const n = Number(amount||0);
    if(cur === "EUR") return n;
    const r = rates && rates[cur];
    if(!r) return null;      // if rate missing, skip
    return n / Number(r);    // because rates are: 1 EUR = r CUR
  }

  async function __rgUpdateTotalEUR(bal){
    const el = document.getElementById("balTotalEUR");
    if(!el) return;
    el.textContent = "‚Ä¶";
    try{
      const rates = await __rgGetFxRatesEUR();
      const parts = [
        __rgToEUR(bal.KWD, "KWD", rates),
        __rgToEUR(bal.USD, "USD", rates),
        __rgToEUR(bal.AED, "AED", rates),
        __rgToEUR(bal.EUR, "EUR", rates),
      ];
      const total = parts.filter(v => typeof v === "number" && !Number.isNaN(v)).reduce((a,b)=>a+b, 0);
      // show with 2 decimals (EUR)
      el.innerHTML = (total>=0) ? `<span class="pos">${total.toFixed(2)}</span>` : `<span class="neg">${total.toFixed(2)}</span>`;
    }catch(e){
      el.textContent = "FX error";
    }
  }


  function computeBalance(rows){
    const out = {KWD:0, USD:0, EUR:0, AED:0};
    for(const r of rows){
      const cur = (r.currency||"").toUpperCase();
      const amt = Number(r.amount||0);
      const sign = inferDirection(r)==="in" ? 1 : -1;
      if(out[cur]!==undefined) out[cur] += sign*amt;
    }
    return out;
  }

  function updateBalanceAndKpis(){
    const rows = state.view;
    const b = computeBalance(rows);

    const fmt = (v)=> (v>=0 ? `<span class="pos">${v.toFixed(2)}</span>` : `<span class="neg">${v.toFixed(2)}</span>`);
    $("balKWD").innerHTML = fmt(b.KWD);
    const balAED = document.getElementById("balAED"); if(balAED) balAED.innerHTML = fmt(b.AED);
    $("balUSD").innerHTML = fmt(b.USD);
    $("balEUR").innerHTML = fmt(b.EUR);

    // live Total (EUR)
    try{ __rgUpdateTotalEUR(b); }catch(e){}
    $("balAED").innerHTML = fmt(b.AED);

    const mix = b.KWD + b.USD + b.EUR + b.AED;
    $("kpiTotal").textContent = `${mix.toFixed(2)} (mix)`;

    const t = new Date().toISOString().slice(0,10);
    const todayRows = rows.filter(r => isoDay(r.created_at||"") === t);
    const bt = computeBalance(todayRows);
    const todayMix = bt.KWD + bt.USD + bt.EUR + bt.AED;
    $("kpiToday").textContent = `${todayMix.toFixed(2)} (mix)`;

    const days = new Set(rows.map(r=>isoDay(r.created_at||"")).filter(Boolean));
    const dcount = Math.max(1, days.size);
    $("kpiAvg").textContent = `${(mix/dcount).toFixed(2)} (mix)`;

    const m = new Map();
    for(const r of rows){
      const c = (r.category||"other");
      m.set(c, (m.get(c)||0) + 1);
    }
    let best = "‚Äî", bestN=0;
    for(const [k,v] of m.entries()){
      if(v>bestN){bestN=v; best=k;}
    }
    $("kpiTopCat").textContent = titleCase(best);
  }

  // =============== RENDER ===============
  function categoryCellHTML(id, current){
    const cats = Array.from(state.categories).sort();
    const options = cats.map(c=>{
      const sel = c===current ? "selected" : "";
      return `<option value="${c}" ${sel}>${titleCase(c)}</option>`;
    }).join("");
    return `
      <select class="catSel" data-id="${id}" data-cat="${current}">
        ${options}
        <option value="__add__">+ Add category‚Ä¶</option>
      </select>
    `;
  }

  function render(){
    const tb = $("tbody");
    tb.innerHTML = "";

    for(const r of state.view){
      const id = r.id;
      const dir = inferDirection(r);
      const signClass = dir==="in" ? "pos" : "neg";
      const amountTxt = fmtMoney(r.amount);
      const dateISO = isoDay(r.created_at || r.date_iso || r.date_raw || "");
      const dateTxt = formatDateEnglishISO(dateISO);

      const cur = (r.currency||"").toUpperCase();
      const cat = (r.category||"other");
      const merch = (r.merchant_clean ?? r.merchant_raw ?? "").trim();

      const tr = document.createElement("tr");
      tr.dataset.day = dateISO;   // üëà clave: agrupaci√≥n determinista
      tr.dataset.id = id;
      // day key for day-headers
      tr.dataset.day = isoDay(r.created_at || r.date_iso || r.date_raw || "");

      const checked = state.selected.has(id) ? "checked" : "";
      if(state.selected.has(id)) tr.classList.add("selected-row");

      tr.innerHTML = `
        <td class="selcol">
          <input class="cbRow" type="checkbox" data-id="${id}" ${checked}>
        </td>

        <td title="${dateISO}">${dateTxt}</td>

        <td>
          <input class="merchantEdit" data-id="${id}" value="${merch.replace(/"/g,'&quot;')}" />
        </td>

        <td>
          ${categoryCellHTML(id, cat)}
        </td>

        <td class="amt ${signClass}" title="${amountTxt}">${amountTxt}</td>

        <td style="text-align:center">
          <div class="curcell" title="${cur}">
            <span class="flag">${flagHTML(cur)}</span><span>${cur}</span>
          </div>
        </td>
      `;

      tb.appendChild(tr);
    }

    setStatus(`count ${state.view.length}`);
    updateBalanceAndKpis();
    wireRowInputs();
    wireSelectionControls();
    try{ window.__rgRebuildDayHeaders && window.__rgRebuildDayHeaders(); }catch(e){}

    try{ if(typeof window.__rgRebuildDayHeaders==="function") window.__rgRebuildDayHeaders(); }catch(e){}

  }

  function wireRowInputs(){
    // merchant edit
    document.querySelectorAll(".merchantEdit").forEach(inp=>{
      inp.addEventListener("keydown", async (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          inp.blur();
        }
      });
      inp.addEventListener("blur", async ()=>{
        const id = Number(inp.dataset.id);
        const val = inp.value.trim();
        try{
          showErr("");
          await postJSON("/update_field", {userid: USER_ID, id, field:"merchant_clean", value: val});
          const row = state.all.find(x=>x.id===id);
          if(row) row.merchant_clean = val;
          applyFilters();
        }catch(err){
          showErr("Save merchant failed: " + err.message);
        }
      });
    });

    // category select
    document.querySelectorAll(".catSel").forEach(sel=>{
      sel.addEventListener("change", async ()=>{
        const id = Number(sel.dataset.id);
        const v = sel.value;
        // keep chip color synced
        sel.dataset.cat = (v === '__add__') ? (sel.dataset.cat || 'other') : v;

        if(v === "__add__"){
          const name = prompt("New category name:");
          if(!name){
            const row = state.all.find(x=>x.id===id);
            sel.value = row?.category || "other";
            return;
          }
          const cat = name.trim().toLowerCase();
          if(!cat){
            const row = state.all.find(x=>x.id===id);
            sel.value = row?.category || "other";
            return;
          }
          state.categories.add(cat);
          buildFilters();
          await saveCategory(id, cat);
          return;
        }

        await saveCategory(id, v);
      });
    });
  }

  async function saveCategory(id, cat){
    try{
      showErr("");
      await postJSON("/update_field", {userid: USER_ID, id, field:"category", value: cat});
      const row = state.all.find(x=>x.id===id);
      if(row) row.category = cat;
      applyFilters();
    }catch(err){
      showErr("Save category failed: " + err.message);
      applyFilters();
    }
  }

  // =============== SELECTION CONTROLS ===============
  function syncSelectAllCheckbox(){
    const cbAll = $("cbAll");
    if(!cbAll) return;
    const ids = state.view.map(r=>r.id);
    if(ids.length === 0){
      cbAll.checked = false;
      cbAll.indeterminate = false;
      return;
    }
    const selectedCount = ids.filter(id=>state.selected.has(id)).length;
    cbAll.checked = (selectedCount === ids.length);
    cbAll.indeterminate = (selectedCount > 0 && selectedCount, selectedCount < ids.length);
    cbAll.indeterminate = (selectedCount > 0 && selectedCount < ids.length);
  }

  function wireSelectionControls(){
    // row checkboxes
    document.querySelectorAll(".cbRow").forEach(cb=>{
      cb.addEventListener("change", ()=>{
        const id = Number(cb.dataset.id);
        const tr = cb.closest("tr");

        if(cb.checked){
          state.selected.add(id);
          tr?.classList.add("selected-row");
        }else{
          state.selected.delete(id);
          tr?.classList.remove("selected-row");
        }

        $("btnDelete").disabled = (state.selected.size === 0);
        syncSelectAllCheckbox();
      });
    });

    // header select all
    const cbAll = $("cbAll");
    if(cbAll){
      cbAll.onchange = ()=>{
        const want = cbAll.checked;
        for(const r of state.view){
          if(want) state.selected.add(r.id);
          else state.selected.delete(r.id);
        }
        document.querySelectorAll(".cbRow").forEach(cb=>{
          cb.checked = want;
          const tr = cb.closest("tr");
          if(want) tr?.classList.add("selected-row");
          else tr?.classList.remove("selected-row");
        });

        $("btnDelete").disabled = (state.selected.size === 0);
        syncSelectAllCheckbox();
      };
    }

    $("btnDelete").disabled = (state.selected.size === 0);
    syncSelectAllCheckbox();
  }

  // =============== DELETE + UNDO ===============
  function showToast(msg){
    $("toastMsg").textContent = msg;
    $("toast").classList.add("show");
    clearTimeout(state.undoTimer);
    state.undoTimer = setTimeout(()=> $("toast").classList.remove("show"), 10000);
  }

  async function doDeleteSelected(){
    const ids = Array.from(state.selected);
    if(ids.length === 0) return;

    try{
      showErr("");

      for(const id of ids){
        await postJSON("/delete", {userid: USER_ID, id});
      }

      state.selected.clear();
      $("btnDelete").disabled = true;
      $("cbAll").checked = false;
      $("cbAll").indeterminate = false;

      showToast(`Deleted ${ids.length} row(s)`);
      await load();
    }catch(err){
      showErr("Delete failed: " + err.message);
    }
  }

  async function undoDelete(){
    try{
      showErr("");
      await postJSON("/undo_delete", {userid: USER_ID});
      $("toast").classList.remove("show");
      await load();
    }catch(err){
      showErr("Undo failed: " + err.message);
    }
  }

  // =============== EXPORT CSV ===============
  function exportCSV(){
    const rows = state.view;
    const headers = ["created_at","merchant_clean","category","amount","currency"];
    const escape = (v)=> `"${String(v??"").replace(/"/g,'""')}"`;
    const lines = [headers.join(",")].concat(rows.map(r=>[
      r.created_at||"",
      r.merchant_clean||"",
      r.category||"",
      r.amount??"",
      r.currency||""
    ].map(escape).join(",")));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "registro_gastos.csv";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  // =============== LOAD ===============
  async function load(){
    try{
      showErr("");
      setStatus("loading‚Ä¶");
      const j = await getJSON(`/expenses?user_id=${encodeURIComponent(USER_ID)}&limit=${LIMIT}`);
      const rows = j.expenses || [];
      state.all = rows;
      window.__rg_last_rows = rows;

      state.categories = new Set(rows.map(r => (r.category||"other").toLowerCase()));
      state.currencies = new Set(rows.map(r => (r.currency||"").toUpperCase()).filter(Boolean));

      if(!state.categories.size) state.categories.add("other");
      if(!state.currencies.size) state.currencies.add("KWD");

      buildFilters();
      applyFilters();
      try{ window.__rgRebuildDayHeaders && window.__rgRebuildDayHeaders(); }catch(e){}

      setStatus(`count ${state.view.length}`);
    }catch(err){
      showErr(String(err?.message || err));
      setStatus("error");
    }
  }

  // =============== EVENTS ===============
  function bind(){
    initFlags();
    initTheme();

    $("toggleKpi").addEventListener("click", ()=>{
      $("kpiRow").classList.toggle("show");
    });

    $("themeBtn").addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      setTheme(cur==="dark" ? "light" : "dark");
    });

    $("balanceBtn").addEventListener("click", ()=>{
      $("balanceMenu").classList.toggle("open");
    });
    document.addEventListener("click",(e)=>{
      if(!e.target.closest(".balance")) $("balanceMenu").classList.remove("open");
    });

    $("curFilter").addEventListener("change", applyFilters);
    $("catFilter").addEventListener("change", applyFilters);
    $("dateFrom").addEventListener("change", applyFilters);
    $("dateTo").addEventListener("change", applyFilters);

    $("btnToday").addEventListener("click", ()=>setQuickRange("today"));
    $("btnWeek").addEventListener("click", ()=>setQuickRange("week"));
    $("btnMonth").addEventListener("click", ()=>setQuickRange("month"));
    $("btnYear").addEventListener("click", ()=>setQuickRange("year"));
    $("btnClear").addEventListener("click", clearFilters);

    $("btnDelete").addEventListener("click", doDeleteSelected);
    $("btnUndo").addEventListener("click", undoDelete);
    $("btnExport").addEventListener("click", exportCSV);

    // sorting headers (skip select column)
    document.querySelectorAll("thead th[data-sort]").forEach(th=>{
      th.addEventListener("click", ()=>{
        const k = th.getAttribute("data-sort");
        if(state.sortKey === k){
          state.sortDir = (state.sortDir==="asc") ? "desc" : "asc";
        }else{
          state.sortKey = k;
          state.sortDir = (k==="created_at") ? "desc" : "asc";
        }
        sortView();
        render();
      });
    });
  }

  // boot
  bind();
  load().then(()=>{
    // ‚úÖ ensure day headers appear on FIRST load (deterministic)
    try{ window.__rgRebuildDayHeaders && window.__rgRebuildDayHeaders(); }catch(e){}
    setTimeout(()=>{ try{ window.__rgRebuildDayHeaders && window.__rgRebuildDayHeaders(); }catch(e){} }, 120);
    setTimeout(()=>{ try{ window.__rgRebuildDayHeaders && window.__rgRebuildDayHeaders(); }catch(e){} }, 350);
  });





// AUTO-REFRESH DISABLED (manual only)




// ===== DATE FORMAT ENGLISH PATCH =====
function enOrdinal(n){
  const v = n % 100;
  if(v>=11 && v<=13) return n+"th";
  switch(n % 10){
    case 1: return n+"st";
    case 2: return n+"nd";
    case 3: return n+"rd";
    default: return n+"th";
  }
}
function formatDateEnglishISO(iso){
  if(!iso || iso.length < 10) return "";
  const y = Number(iso.slice(0,4));
  const m = Number(iso.slice(5,7));
  const d = Number(iso.slice(8,10));
  if(!y || !m || !d) return iso;
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  return `${enOrdinal(d)} ${months[m-1]} ${y}`;
}

// Hook render(): replace date cell display without touching core logic
(function(){
  const _render = window.render;
  if(typeof _render !== "function") return;

  window.render = function(){
    _render();
    document.querySelectorAll("#tbody tr td:first-child").forEach(td=>{
      const iso = (td.getAttribute("title") || td.textContent || "").trim();
      const iso10 = iso.slice(0,10);
      if(/^\d{4}-\d{2}-\d{2}$/.test(iso10)){
        td.textContent = formatDateEnglishISO(iso10);
      }
    });
  };
})();


// ===== PATCH: call day-headers after render() =====
(function(){
  if (window.__rgRenderHookDayHeaders) return;
  window.__rgRenderHookDayHeaders = true;

  function callRebuild(){
    try{
      if (typeof window.__rgRebuildDayHeaders === "function") window.__rgRebuildDayHeaders();
    }catch(e){}
  }

  const _render = window.render;
  if (typeof _render === "function"){
    window.render = function(){
      _render();
      setTimeout(callRebuild, 0);
      setTimeout(callRebuild, 60);
    };
  }else{
    // fallback: try on load
    window.addEventListener("load", ()=>setTimeout(callRebuild, 120));
  }
})();


</script>

<!-- RULE_BUTTON_WIRE_V1 -->
<!-- DISABLED OLD DAY HEADERS SCRIPT (PATCH: DAY HEADERS FINAL (dataset-based)) -->

<script>


// ===== SORT BY DATE BUTTON =====
(function(){
  document.addEventListener("DOMContentLoaded", ()=>{
    const b = document.getElementById("qaSortDate");
    if(!b) return;
    b.addEventListener("click", ()=>{
      try{
        if(window.state){
          window.state.sortKey = "created_at";
          window.state.sortDir = "desc";
        }
        if(typeof window.sortView === "function") window.sortView();
        if(typeof window.render === "function") window.render();
        try{ window.__rgRebuildDayHeaders && window.__rgRebuildDayHeaders(); }catch(e){}
      }catch(e){}
    });
  });
})();

// ===== MANUAL REFRESH BUTTON =====
(function(){
  document.addEventListener("DOMContentLoaded", ()=>{
    const b = document.getElementById("qaRefresh");
    if(!b) return;
    b.addEventListener("click", async ()=>{
      try{
        if(typeof load === "function") await load();
        try{ window.__rgRebuildDayHeaders && window.__rgRebuildDayHeaders(); }catch(e){}
      }catch(e){}
    });
  });
})();

</script>

<!-- ===== FIX: gear dropdown + tx modal dblclick (robust) ===== -->
<script id="FIX_GEAR_AND_MODAL_V1">
(function(){
  function ready(fn){
    if(document.readyState !== "loading") fn();
    else document.addEventListener("DOMContentLoaded", fn);
  }

  // Gear menu: toggle fiable
  ready(function(){
    var btn = document.getElementById("settingsBtn");
    var menu = document.getElementById("settingsMenu");
    if(btn && menu){
      btn.addEventListener("click", function(e){
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      });
      document.addEventListener("click", function(e){
        if(!e.target.closest(".settings")) menu.classList.remove("open");
      });
    }
  });

  // Tx modal: doble click en fila (evita inputs/selects)
  document.addEventListener("dblclick", function(e){
    var tr = e.target && e.target.closest ? e.target.closest("#tbody tr") : null;
    if(!tr) return;
    if(tr.classList.contains("rg-sep")) return;
    if(e.target.closest && e.target.closest("input, select, button, a, textarea")) return;

    var id = tr.getAttribute("data-id");
    if(!id) return;

    var list = window.__rg_last_rows || (window.state && Array.isArray(window.state.all) ? window.state.all : []);
    var item = Array.isArray(list) ? list.find(function(x){ return String(x.id) === String(id); }) : null;

    if(item && typeof window.__rgOpenTx === "function"){
      window.__rgOpenTx(item);
    }
  }, true);
})();
</script>

</body>
</html>

<!-- FIX_RULE_MODAL_V1 -->
<script>
(function(){
  function closeRuleModal(){
    const m = document.getElementById("ruleModal");
    if(m){
      m.style.display = "none";
    }
  }

  document.addEventListener("click", function(e){
    if(e.target && e.target.id === "ruleClose"){
      closeRuleModal();
    }
    if(e.target && e.target.id === "ruleSave"){
      setTimeout(closeRuleModal, 300);
    }
  });

  // Cerrar al hacer click fuera
  document.addEventListener("mousedown", function(e){
    const m = document.getElementById("ruleModal");
    if(!m) return;
    if(e.target === m){
      closeRuleModal();
    }
  });
})();

/* ===== TX MODAL PATCH ===== */
(function(){
  const $ = (q)=>document.querySelector(q);

  const overlay = $("#txOverlay");
  const closeBtn = $("#txClose");
  const grid = $("#txGrid");
  const pills = $("#txPills");
  const smsBox = $("#txSms");
  const sub = $("#txSub");

  function esc(s){ return (s ?? "").toString(); }

  function fmtMoney(amount, currency){
    if(amount === null || amount === undefined) return "‚Äî";
    try{
      const n = Number(amount);
      if(Number.isNaN(n)) return esc(amount);
      return (currency||"") + " " + n.toFixed(3);
    }catch(e){ return esc(amount) + " " + (currency||""); }
  }

  function fmtDateNice(iso){
    if(!iso) return "‚Äî";
    try{
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      return d.toLocaleString("en-GB", { day:"2-digit", month:"long", year:"numeric", hour:"2-digit", minute:"2-digit" });
    }catch(e){ return iso; }
  }

  function openTx(item){
    // pills
    pills.innerHTML = "";
    const pillData = [
      ["ID", item.id],
      ["Direction", item.direction || "‚Äî"],
      ["Currency", item.currency || "‚Äî"],
      ["Category", item.category || "‚Äî"]
    ];
    for(const [k,v] of pillData){
      const el = document.createElement("div");
      el.className = "rgPill";
      el.textContent = `${k}: ${v ?? "‚Äî"}`;
      pills.appendChild(el);
    }

    // sub header
    sub.textContent = `${fmtDateNice(item.created_at)} ‚Ä¢ ${fmtMoney(item.amount, item.currency)}`;

    // grid
    const rows = [
      ["Merchant", item.merchant_clean || "‚Äî"],
      ["Amount", fmtMoney(item.amount, item.currency)],
      ["Category", item.category || "‚Äî"],
      ["Direction", item.direction || "‚Äî"],
      ["Created", fmtDateNice(item.created_at)],
      ["Raw SMS", ""],
    ];
    grid.innerHTML = "";
    rows.forEach(([k,v])=>{
      const kEl = document.createElement("div"); kEl.className="rgK"; kEl.textContent=k;
      const vEl = document.createElement("div"); vEl.className="rgV"; vEl.textContent=v || "‚Äî";
      grid.appendChild(kEl); grid.appendChild(vEl);
    });

    smsBox.textContent = item.sms || "‚Äî";

    overlay.classList.add("open");
    overlay.setAttribute("aria-hidden","false");
  }

  function closeTx(){
    overlay.classList.remove("open");
    overlay.setAttribute("aria-hidden","true");
  }

  closeBtn && closeBtn.addEventListener("click", closeTx);
  overlay && overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeTx(); });
  window.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && overlay.classList.contains("open")) closeTx(); });

  // Row click: delegate on tbody
  document.addEventListener("dblclick", (e)=>{
    const tr = e.target.closest && e.target.closest("tbody tr");
    if(!tr) return;

    // Do NOT open modal when interacting with controls
    if(e.target.closest("input, select, button, a, textarea")) return;

    // Expect row has data-id
    const id = tr.getAttribute("data-id");
    if(!id) return;

    // Use global lastData if exists (most dashboards keep it)
    const list = window.__rg_last_rows || window.lastRows || window.rows || null;
    if(Array.isArray(list)){
      const item = list.find(x => String(x.id) === String(id));
      if(item) return openTx(item);
    }

    // Fallback: fetch single page and find it
    const user = (document.querySelector("#statusPill")?.dataset?.user) || "pedro";
    fetch(`/expenses?user_id=${encodeURIComponent(user)}&limit=500`)
      .then(r=>r.json())
      .then(j=>{
        const item = (j.expenses||[]).find(x => String(x.id)===String(id));
        if(item) openTx(item);
      })
      .catch(()=>{});
  });

  // expose for other parts if needed
  window.__rgOpenTx = openTx;
})();

</script>
<script>

// ===== DAY HEADERS ENGINE (single source of truth) =====
(function(){
  const MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];

  function label(iso){
    if(!iso) return "";
    const d=new Date(iso+"T00:00:00Z");
    const now=new Date();
    const today=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()));
    const diff=Math.round((d-today)/86400000);
    if(diff===0) return "Today";
    if(diff===1) return "Tomorrow";
    if(diff===-1) return "Yesterday";
    return d.getUTCDate()+" "+MONTHS[d.getUTCMonth()];
  }

  function rebuild(){
    const tb=document.querySelector("#t tbody");
    if(!tb) return;

    // limpia separadores previos
    tb.querySelectorAll("tr.rg-sep").forEach(x=>x.remove());

    let last=null;
    const rows=Array.from(tb.querySelectorAll("tr")).filter(r=>!r.classList.contains("rg-sep"));
    for(const r of rows){
      const day = r.dataset.day || "";
      if(!day) continue;

      if(day!==last){
        last=day;

        const sep=document.createElement("tr");
        sep.className="rg-sep";

        const td=document.createElement("td");
        td.colSpan = r.children.length;
        td.className="rg-sep-cell";
        td.style.cursor="pointer";
        td.style.userSelect="none";

        const caret=document.createElement("span");
        caret.textContent="‚ñæ ";
        caret.style.opacity=".6";

        const txt=document.createElement("span");
        txt.textContent=label(day);

        td.appendChild(caret);
        td.appendChild(txt);
        sep.appendChild(td);

        tb.insertBefore(sep, r);

        // collapse
        sep.addEventListener("click", ()=>{
          const c=sep.classList.toggle("collapsed");
          caret.textContent=c?"‚ñ∏ ":"‚ñæ ";
          let n=sep.nextElementSibling;
          while(n && !n.classList.contains("rg-sep")){
            n.style.display=c?"none":"table-row";
            n=n.nextElementSibling;
          }
        });
      }
    }
  }

  window.__rgRebuildDayHeaders = rebuild;
})();

</script>
